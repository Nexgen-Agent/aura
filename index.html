<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lonz Flawls Aura | Premium Skincare</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@300;400;500;600;700&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    
    <!-- Place your CSS here -->
    <!-- CSS will be added back here -->

    <!-- Supabase JS Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <!-- Floating Cart -->
    <div class="floating-cart" id="floatingCart">
        <div class="floating-cart-container" id="floatingCartBtn">
            <i class="fas fa-shopping-bag"></i>
            <div class="floating-cart-badge" id="floatingCartBadge">0</div>
        </div>
        <div class="floating-cart-label">Your Bag</div>
    </div>

    <!-- Background Video -->
    <video autoplay muted loop id="background-video">
        <source src="assets/videos/background-loop.mp4" type="video/mp4">
    </video>
    <div class="video-overlay"></div>

    <!-- Auth Choice Modal -->
    <div class="auth-choice-modal" id="authChoiceModal">
        <div class="auth-choice-content glass-card">
            <button class="close-button" id="closeAuthChoice">&times;</button>
            <h3>How would you like to proceed?</h3>
            <p>Choose an option below to continue with your purchase</p>
            
            <div class="auth-choice-options">
                <div class="auth-choice-option glass-card guest" id="guestOption">
                    <i class="fas fa-user"></i>
                    <h4>Continue as Guest</h4>
                    <p>Checkout without creating an account</p>
                </div>
                
                <div class="auth-choice-option glass-card signup" id="signupOption">
                    <i class="fas fa-user-plus"></i>
                    <h4>Sign Up & Receive a Welcome Gift</h4>
                    <p>Join our community for curated benefits on your first purchase</p>
                    <div class="discount-badge">15% OFF FIRST ORDER</div>
                </div>
                
                <div class="auth-choice-option glass-card login" id="loginOption">
                    <i class="fas fa-sign-in-alt"></i>
                    <h4>Welcome Back, Sign In</h4>
                    <p>Access your saved details and order history</p>
                </div>
            </div>
            
            <p class="auth-choice-note">
                <i class="fas fa-lock"></i> Your information is secure with us
            </p>
        </div>
    </div>

    <!-- Enhanced Auth Modal -->
    <div class="enhanced-auth-modal" id="enhancedAuthModal">
        <div class="enhanced-auth-content glass-card">
            <button class="close-button" id="closeEnhancedAuth">&times;</button>
            
            <div class="auth-loading" id="authLoading">
                <i class="fas fa-spinner"></i>
                <p>Processing your request...</p>
            </div>
            
            <div class="auth-success" id="authSuccess">
                <i class="fas fa-check-circle"></i>
                <h4>Authentication Successful!</h4>
                <p>Proceeding to checkout...</p>
            </div>
            
            <div id="mainAuthContent">
                <div class="enhanced-auth-tabs">
                    <button class="enhanced-auth-tab active" data-tab="login">Login</button>
                    <button class="enhanced-auth-tab" data-tab="signup">Sign Up</button>
                </div>
                
                <div class="discount-display" id="signupDiscount" style="display: none;">
                    <i class="fas fa-gift"></i>
                    <span>Receive a welcome gift when you join our community</span>
                </div>
                
                <form class="enhanced-auth-form active" id="enhancedLoginForm">
                    <div class="social-login-section">
                        <h5>Sign in with</h5>
                        <div class="social-login-buttons">
                            <div class="social-login-button google" id="googleLogin">
                                <i class="fab fa-google"></i>
                            </div>
                            <div class="social-login-button facebook" id="facebookLogin">
                                <i class="fab fa-facebook-f"></i>
                            </div>
                            <div class="social-login-button apple" id="appleLogin">
                                <i class="fab fa-apple"></i>
                            </div>
                        </div>
                    </div>
                    
                    <div class="divider">
                        <span>or continue with email</span>
                    </div>
                    
                    <div class="form-group">
                        <label for="enhancedLoginEmail">Email Address</label>
                        <input type="email" id="enhancedLoginEmail" class="form-input" placeholder="Enter your email" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="enhancedLoginPassword">Password</label>
                        <input type="password" id="enhancedLoginPassword" class="form-input" placeholder="Enter your password" required>
                        <a href="#" class="forgot-password" id="forgotPassword">Forgot Password?</a>
                    </div>
                    
                    <div class="form-checkbox">
                        <input type="checkbox" id="rememberMeEnhanced">
                        <label for="rememberMeEnhanced">Remember me</label>
                    </div>
                    
                    <button type="submit" class="glass-button" style="width: 100%;">
                        <i class="fas fa-sign-in-alt"></i> Sign In
                    </button>
                    
                    <div class="auth-footer">
                        Don't have an account? <a href="#" class="switch-to-signup-enhanced">Sign up here</a>
                    </div>
                </form>
                
                <form class="enhanced-auth-form" id="enhancedSignupForm">
                    <div class="social-login-section">
                        <h5>Sign up with</h5>
                        <div class="social-login-buttons">
                            <div class="social-login-button google" id="googleSignup">
                                <i class="fab fa-google"></i>
                            </div>
                            <div class="social-login-button facebook" id="facebookSignup">
                                <i class="fab fa-facebook-f"></i>
                            </div>
                            <div class="social-login-button apple" id="appleSignup">
                                <i class="fab fa-apple"></i>
                            </div>
                        </div>
                    </div>
                    
                    <div class="divider">
                        <span>or sign up with email</span>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group" style="flex: 1;">
                            <label for="signupFirstName">First Name</label>
                            <input type="text" id="signupFirstName" class="form-input" placeholder="First name" required>
                        </div>
                        <div class="form-group" style="flex: 1;">
                            <label for="signupLastName">Last Name</label>
                            <input type="text" id="signupLastName" class="form-input" placeholder="Last name" required>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="enhancedSignupEmail">Email Address</label>
                        <input type="email" id="enhancedSignupEmail" class="form-input" placeholder="Enter your email" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="enhancedSignupPassword">Password</label>
                        <input type="password" id="enhancedSignupPassword" class="form-input" placeholder="Create a password" required>
                        <div class="password-strength" id="passwordStrength"></div>
                    </div>
                    
                    <div class="form-group">
                        <label for="enhancedSignupConfirmPassword">Confirm Password</label>
                        <input type="password" id="enhancedSignupConfirmPassword" class="form-input" placeholder="Confirm your password" required>
                    </div>
                    
                    <div class="password-requirements">
                        <h6>Password must contain:</h6>
                        <ul>
                            <li id="reqLength" class="invalid"><i class="fas fa-circle" style="font-size: 6px;"></i> At least 8 characters</li>
                            <li id="reqUppercase" class="invalid"><i class="fas fa-circle" style="font-size: 6px;"></i> One uppercase letter</li>
                            <li id="reqLowercase" class="invalid"><i class="fas fa-circle" style="font-size: 6px;"></i> One lowercase letter</li>
                            <li id="reqNumber" class="invalid"><i class="fas fa-circle" style="font-size: 6px;"></i> One number</li>
                        </ul>
                    </div>
                    
                    <div class="form-checkbox">
                        <input type="checkbox" id="agreeTermsEnhanced" required>
                        <label for="agreeTermsEnhanced">I agree to the <a href="#" style="color: var(--accent-color);">Terms & Conditions</a> and <a href="#" style="color: var(--accent-color);">Privacy Policy</a></label>
                    </div>
                    
                    <button type="submit" class="glass-button" style="width: 100%;">
                        <i class="fas fa-user-plus"></i> Create Account & Receive Welcome Gift
                    </button>
                    
                    <div class="auth-footer">
                        Already have an account? <a href="#" class="switch-to-login-enhanced">Login here</a>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Search Overlay -->
    <div class="search-overlay" id="searchOverlay">
        <div class="search-header">
            <button class="search-back-btn" id="searchBackBtn">
                <i class="fas fa-arrow-left"></i>
            </button>
            <input type="text" class="search-overlay-input" id="searchOverlayInput" placeholder="Search by product, concern, or benefit">
        </div>
        <div class="search-overlay-content">
            <div class="search-overlay-results" id="searchOverlayResults"></div>
        </div>
    </div>

    <!-- Authentication Modal -->
    <div class="auth-modal" id="authModal">
        <div class="auth-content glass-card">
            <button class="close-button" id="closeAuth">&times;</button>
            <div class="auth-tabs">
                <button class="auth-tab active" data-tab="login">Login</button>
                <button class="auth-tab" data-tab="signup">Sign Up</button>
            </div>
            
            <form class="auth-form active" id="loginForm">
                <div class="form-group">
                    <label for="loginEmail">Email Address</label>
                    <input type="email" id="loginEmail" class="form-input" placeholder="Enter your email" required>
                </div>
                
                <div class="form-group">
                    <label for="loginPassword">Password</label>
                    <input type="password" id="loginPassword" class="form-input" placeholder="Enter your password" required>
                    <a href="#" class="forgot-password">Forgot Password?</a>
                </div>
                
                <div class="form-checkbox">
                    <input type="checkbox" id="rememberMe">
                    <label for="rememberMe">Remember me</label>
                </div>
                
                <button type="submit" class="glass-button" style="width: 100%;">
                    <i class="fas fa-sign-in-alt"></i> Login
                </button>
                
                <div class="auth-footer">
                    Don't have an account? <a href="#" class="switch-to-signup">Sign up here</a>
                </div>
            </form>
            
            <form class="auth-form" id="signupForm">
                <div class="form-group">
                    <label for="signupName">Full Name</label>
                    <input type="text" id="signupName" class="form-input" placeholder="Enter your full name" required>
                </div>
                
                <div class="form-group">
                    <label for="signupEmail">Email Address</label>
                    <input type="email" id="signupEmail" class="form-input" placeholder="Enter your email" required>
                </div>
                
                <div class="form-group">
                    <label for="signupPassword">Password</label>
                    <input type="password" id="signupPassword" class="form-input" placeholder="Create a password" required>
                </div>
                
                <div class="form-group">
                    <label for="signupConfirmPassword">Confirm Password</label>
                    <input type="password" id="signupConfirmPassword" class="form-input" placeholder="Confirm your password" required>
                </div>
                
                <div class="form-checkbox">
                    <input type="checkbox" id="agreeTerms" required>
                    <label for="agreeTerms">I agree to the Terms & Conditions and Privacy Policy</label>
                </div>
                
                <button type="submit" class="glass-button" style="width: 100%;">
                    <i class="fas fa-user-plus"></i> Create Account
                </button>
                
                <div class="auth-footer">
                    Already have an account? <a href="#" class="switch-to-login">Login here</a>
                </div>
            </form>
        </div>
    </div>

    <!-- Cart Modal -->
    <div class="cart-modal" id="cartModal">
        <div class="cart-content glass-card">
            <button class="close-button" id="closeCart">&times;</button>
            <div class="cart-header">
                <h3>Your Shopping Bag</h3>
            </div>
            
            <div class="cart-items" id="cartItems">
                <div class="cart-empty">
                    <i class="fas fa-shopping-bag"></i>
                    <h4>Your bag is empty</h4>
                    <p>Add some products to get started!</p>
                    <button class="glass-button" onclick="document.querySelector('#all-products').scrollIntoView({behavior: 'smooth'})">
                        <i class="fas fa-store"></i> Browse Products
                    </button>
                </div>
            </div>
            
            <div class="cart-summary glass-card" id="cartSummary" style="display: none;">
                <div class="summary-row">
                    <span>Subtotal</span>
                    <span id="cartSubtotal">R0.00</span>
                </div>
                <div class="summary-row">
                    <span>Shipping</span>
                    <span id="cartShipping">R50.00</span>
                </div>
                <div class="summary-row">
                    <span>Tax</span>
                    <span id="cartTax">R0.00</span>
                </div>
                <div class="summary-row total">
                    <span>Total</span>
                    <span id="cartTotal">R0.00</span>
                </div>
                
                <button class="glass-button" style="width: 100%; margin-top: 20px;" id="checkoutBtn">
                    <i class="fas fa-lock"></i> Proceed to Checkout
                </button>
            </div>
        </div>
    </div>

    <!-- Checkout Modal -->
    <div class="checkout-modal" id="checkoutModal">
        <div class="checkout-content glass-card">
            <button class="close-button" id="closeCheckout">&times;</button>
            <div class="checkout-header">
                <h3>Checkout</h3>
            </div>
            
            <div class="checkout-steps">
                <div class="checkout-step active" data-step="1">
                    <div class="step-number">1</div>
                    <div class="step-title">Shipping</div>
                </div>
                <div class="checkout-step" data-step="2">
                    <div class="step-number">2</div>
                    <div class="step-title">Payment</div>
                </div>
                <div class="checkout-step" data-step="3">
                    <div class="step-number">3</div>
                    <div class="step-title">Review</div>
                </div>
            </div>
            
            <form class="checkout-form active" id="shippingForm">
                <div class="form-row">
                    <div class="form-group">
                        <label for="shippingFirstName">First Name</label>
                        <input type="text" id="shippingFirstName" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label for="shippingLastName">Last Name</label>
                        <input type="text" id="shippingLastName" class="form-input" required>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="shippingEmail">Email Address</label>
                    <input type="email" id="shippingEmail" class="form-input" required>
                </div>
                
                <div class="form-group">
                    <label for="shippingPhone">Phone Number</label>
                    <input type="tel" id="shippingPhone" class="form-input" required>
                </div>
                
                <div class="global-shipping-note">
                    <p><i class="fas fa-globe-americas"></i> We ship worldwide! Don't see your village? You can enter it manually below.</p>
                </div>
                
                <div class="address-selection-container">
                    <div class="address-progress">
                        <div class="address-progress-step active" data-step="country">
                            <div class="step-number">1</div>
                            Country
                        </div>
                        <div class="address-progress-separator"></div>
                        <div class="address-progress-step" data-step="state">
                            <div class="step-number">2</div>
                            State/Province
                        </div>
                        <div class="address-progress-separator"></div>
                        <div class="address-progress-step" data-step="city">
                            <div class="step-number">3</div>
                            City/Town
                        </div>
                        <div class="address-progress-separator"></div>
                        <div class="address-progress-step" data-step="village">
                            <div class="step-number">4</div>
                            Village/Suburb
                        </div>
                        <div class="address-progress-separator"></div>
                        <div class="address-progress-step" data-step="zip">
                            <div class="step-number">5</div>
                            ZIP Code
                        </div>
                    </div>
                    
                    <div class="address-step active" id="countryStep">
                        <h4 style="color: var(--primary-color); margin-bottom: 20px;">Select Your Country</h4>
                        <div class="address-options" id="countryOptions"></div>
                    </div>
                    
                    <div class="address-step" id="stateStep">
                        <h4 style="color: var(--primary-color); margin-bottom: 20px;">Select Your State/Province</h4>
                        <div class="address-search">
                            <input type="text" class="address-search-input" id="stateSearch" placeholder="Search for your state/province...">
                            <button type="button" class="glass-button" style="padding: 12px 20px;" onclick="searchStates()">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                        <div class="address-options" id="stateOptions"></div>
                        <div class="address-options" style="margin-top: 15px;">
                            <div class="address-option" onclick="enterStateManually()">
                                <i class="fas fa-edit"></i>
                                <p>Enter State Manually</p>
                                <small style="color: rgba(255, 255, 255, 0.6);">Can't find your state?</small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="address-step" id="cityStep">
                        <h4 style="color: var(--primary-color); margin-bottom: 20px;">Select Your City/Town</h4>
                        <div class="address-search">
                            <input type="text" class="address-search-input" id="citySearch" placeholder="Search for your city/town...">
                            <button type="button" class="glass-button" style="padding: 12px 20px;" onclick="searchCities()">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                        <div class="address-options" id="cityOptions"></div>
                        <div class="address-options" style="margin-top: 15px;">
                            <div class="address-option" onclick="enterCityManually()">
                                <i class="fas fa-edit"></i>
                                <p>Enter City Manually</p>
                                <small style="color: rgba(255, 255, 255, 0.6);">Can't find your city?</small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="address-step" id="villageStep">
                        <h4 style="color: var(--primary-color); margin-bottom: 20px;">Select Your Village/Suburb</h4>
                        <p style="color: rgba(255, 255, 255, 0.7); margin-bottom: 15px; font-size: 14px;">Select your village or suburb for precise delivery. Can't find yours? Enter it manually below.</p>
                        <div class="address-search">
                            <input type="text" class="address-search-input" id="villageSearch" placeholder="Search for your village/suburb...">
                            <button type="button" class="glass-button" style="padding: 12px 20px;" onclick="searchVillages()">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                        <div class="address-options" id="villageOptions"></div>
                        
                        <div class="manual-village-container" id="manualVillageContainer">
                            <div class="manual-village-header">
                                <i class="fas fa-map-pin"></i>
                                <h5>Enter Village/Suburb Details Manually</h5>
                            </div>
                            <div class="manual-village-fields">
                                <div class="form-group">
                                    <label for="manualVillageName">Village/Suburb Name</label>
                                    <input type="text" id="manualVillageName" class="form-input" placeholder="Enter village or suburb name">
                                </div>
                                <div class="form-group">
                                    <label for="manualVillageZip">ZIP/Postal Code</label>
                                    <input type="text" id="manualVillageZip" class="form-input" placeholder="Enter ZIP code">
                                </div>
                            </div>
                            <div class="manual-village-actions">
                                <button type="button" class="glass-button" onclick="cancelManualVillage()">
                                    <i class="fas fa-times"></i> Cancel
                                </button>
                                <button type="button" class="glass-button" onclick="saveManualVillage()" style="background: rgba(196, 167, 125, 0.3);">
                                    <i class="fas fa-save"></i> Save & Continue
                                </button>
                            </div>
                        </div>
                        
                        <div class="address-options" style="margin-top: 15px;">
                            <div class="address-option" onclick="skipVillage()">
                                <i class="fas fa-forward"></i>
                                <p>Skip Village/Suburb</p>
                                <small style="color: rgba(255, 255, 255, 0.6);">I don't have a village/suburb</small>
                            </div>
                            <div class="address-option" onclick="enterVillageManually()">
                                <i class="fas fa-edit"></i>
                                <p>Enter Village Manually</p>
                                <small style="color: rgba(255, 255, 255, 0.6);">My village is not listed</small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="address-step" id="zipStep">
                        <h4 style="color: var(--primary-color); margin-bottom: 20px;">Enter Your ZIP/Postal Code</h4>
                        <p style="color: rgba(255, 255, 255, 0.7); margin-bottom: 20px; font-size: 14px;">Enter your ZIP code for accurate shipping calculation</p>
                        
                        <div class="form-group">
                            <label for="shippingZip">ZIP/Postal Code</label>
                            <input type="text" id="shippingZip" class="form-input" placeholder="Enter ZIP code" required>
                            <div class="zip-validation" id="zipValidation"></div>
                        </div>
                        
                        <div id="manualVillageNote" style="display: none;">
                            <div class="global-shipping-note">
                                <p><i class="fas fa-info-circle"></i> Using manually entered village and ZIP code. Shipping will be calculated based on this information.</p>
                            </div>
                        </div>
                        
                        <div class="google-maps-container">
                            <div class="google-maps-placeholder">
                                <i class="fas fa-map-marked-alt"></i>
                                <p>Google Maps integration for address verification</p>
                                <small style="margin-top: 10px;">Your address will be verified for shipping accuracy</small>
                            </div>
                        </div>
                        
                        <div class="address-confirmation" id="addressConfirmation">
                            <h5>Selected Address</h5>
                            <div class="address-details" id="addressDetails"></div>
                        </div>
                    </div>
                    
                    <div class="address-navigation">
                        <button type="button" class="glass-button" id="prevAddressStep" style="display: none;">
                            <i class="fas fa-arrow-left"></i> Previous
                        </button>
                        <button type="button" class="glass-button" id="nextAddressStep">
                            Next <i class="fas fa-arrow-right"></i>
                        </button>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="shippingAddress">Street Address</label>
                    <input type="text" id="shippingAddress" class="form-input" placeholder="House number, street name, building" required>
                </div>
                
                <div class="form-group">
                    <label for="shippingApartment">Apartment, Suite, Unit (Optional)</label>
                    <input type="text" id="shippingApartment" class="form-input" placeholder="Apartment, suite, unit, etc.">
                </div>
                
                <div class="form-group">
                    <label for="shippingNotes">Delivery Instructions (Optional)</label>
                    <textarea id="shippingNotes" class="form-input" rows="3" placeholder="Any special delivery instructions?"></textarea>
                </div>
                
                <div class="checkout-actions">
                    <button type="button" class="glass-button" id="backToCart">
                        <i class="fas fa-arrow-left"></i> Back to Cart
                    </button>
                    <button type="button" class="glass-button" id="nextToPayment">
                        Next <i class="fas fa-arrow-right"></i>
                    </button>
                </div>
            </form>
            
            <form class="checkout-form" id="paymentForm">
                <div class="payment-methods">
                    <div class="payment-method glass-card selected" data-method="credit">
                        <i class="fas fa-credit-card"></i>
                        <h4>Credit Card</h4>
                        <p>Pay with your credit card</p>
                    </div>
                    <div class="payment-method glass-card" data-method="paypal">
                        <i class="fab fa-paypal"></i>
                        <h4>PayPal</h4>
                        <p>Pay with your PayPal account</p>
                    </div>
                    <div class="payment-method glass-card" data-method="bank">
                        <i class="fas fa-university"></i>
                        <h4>Bank Transfer</h4>
                        <p>Direct bank transfer</p>
                    </div>
                </div>
                
                <div class="payment-details active" id="creditCardDetails">
                    <div class="form-group">
                        <label for="cardName">Name on Card</label>
                        <input type="text" id="cardName" class="form-input" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="cardNumber">Card Number</label>
                        <input type="text" id="cardNumber" class="form-input" placeholder="1234 5678 9012 3456" required>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="cardExpiry">Expiry Date</label>
                            <input type="text" id="cardExpiry" class="form-input" placeholder="MM/YY" required>
                        </div>
                        <div class="form-group">
                            <label for="cardCVC">CVC</label>
                            <input type="text" id="cardCVC" class="form-input" placeholder="123" required>
                        </div>
                    </div>
                    
                    <div class="payment-note">
                        <i class="fas fa-shield-alt"></i>
                        <span>Your payment information is secure and encrypted</span>
                    </div>
                </div>
                
                <div class="payment-details" id="paypalDetails">
                    <div class="payment-note">
                        <i class="fab fa-paypal"></i>
                        <span>You will be redirected to PayPal to complete your payment securely</span>
                    </div>
                    
                    <div class="paypal-button-container">
                        <button type="button" class="paypal-button" id="paypalButton">
                            <i class="fab fa-paypal"></i> Pay with PayPal
                        </button>
                    </div>
                    
                    <div style="text-align: center; margin-top: 20px; color: rgba(255, 255, 255, 0.7); font-size: 14px;">
                        <p>After clicking the button, you'll be redirected to PayPal to complete your payment</p>
                    </div>
                </div>
                
                <div class="payment-details" id="bankTransferDetails">
                    <div class="payment-note">
                        <i class="fas fa-university"></i>
                        <span>Transfer the total amount to our bank account. Your order will be processed once payment is confirmed.</span>
                    </div>
                    
                    <div class="bank-details">
                        <h5>Bank Account Details</h5>
                        <p><strong>Bank Name:</strong> Standard Bank</p>
                        <p><strong>Account Name:</strong> Lonz Flawls Aura</p>
                        <p><strong>Account Number:</strong> 0123456789</p>
                        <p><strong>Branch Code:</strong> 051001</p>
                        <p><strong>Reference:</strong> Order #<span id="bankReference">0000</span></p>
                        <p><strong>Amount:</strong> <span id="bankAmount">R0.00</span></p>
                    </div>
                    
                    <div class="form-group" style="margin-top: 20px;">
                        <label for="bankProof">Upload Proof of Payment (Optional)</label>
                        <input type="file" id="bankProof" class="form-input" accept=".jpg,.jpeg,.png,.pdf">
                        <small style="color: rgba(255, 255, 255, 0.6);">Upload screenshot or scan of payment confirmation</small>
                    </div>
                    
                    <div class="payment-note" style="background: rgba(255, 193, 7, 0.1); border-color: rgba(255, 193, 7, 0.2);">
                        <i class="fas fa-clock"></i>
                        <span>Please allow 24-48 hours for bank transfer verification</span>
                    </div>
                </div>
                
                <div class="checkout-actions">
                    <button type="button" class="glass-button" id="backToShipping">
                        <i class="fas fa-arrow-left"></i> Back to Shipping
                    </button>
                    <button type="button" class="glass-button" id="nextToReview">
                        Next <i class="fas fa-arrow-right"></i>
                    </button>
                </div>
            </form>
            
            <div class="checkout-form" id="reviewForm">
                <div class="checkout-review glass-card">
                    <h4 style="margin-bottom: 20px; color: var(--primary-color);">Order Summary</h4>
                    <div id="reviewItems"></div>
                    
                    <div class="summary-row">
                        <span>Subtotal</span>
                        <span id="reviewSubtotal">R0.00</span>
                    </div>
                    <div class="summary-row">
                        <span>Shipping</span>
                        <span id="reviewShipping">R50.00</span>
                    </div>
                    <div class="summary-row">
                        <span>Tax</span>
                        <span id="reviewTax">R0.00</span>
                    </div>
                    <div class="summary-row total">
                        <span>Total</span>
                        <span id="reviewTotal">R0.00</span>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="orderNotes">Order Notes (Optional)</label>
                    <textarea id="orderNotes" class="form-input" rows="3" placeholder="Add special instructions for your order..."></textarea>
                </div>
                
                <div class="form-checkbox">
                    <input type="checkbox" id="agreeTermsCheckout" required>
                    <label for="agreeTermsCheckout">I agree to the Terms & Conditions and Privacy Policy</label>
                </div>
                
                <div class="checkout-actions">
                    <button type="button" class="glass-button" id="backToPayment">
                        <i class="fas fa-arrow-left"></i> Back to Payment
                    </button>
                    <button type="button" class="glass-button" id="placeOrderBtn">
                        <i class="fas fa-lock"></i> Place Order
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Success Modal -->
    <div class="success-modal" id="successModal">
        <div class="success-content glass-card">
            <button class="close-button" id="closeSuccess">&times;</button>
            <div class="success-icon">
                <i class="fas fa-check-circle"></i>
            </div>
            <div class="success-message">
                <h3>Order Confirmed!</h3>
                <p id="successMessage">Thank you for your purchase. Your order has been successfully placed and is being processed. You will receive a confirmation email shortly.</p>
                <p style="font-size: 1rem; color: var(--accent-color); margin-top: 20px;">
                    Order ID: <strong>#LFA-<span id="orderId">0000</span></strong>
                </p>
                
                <div class="success-button-container">
                    <button class="glass-button" id="continueShopping">
                        <i class="fas fa-shopping-bag"></i> Continue Shopping
                    </button>
                    <button class="glass-button" style="background: rgba(196, 167, 125, 0.3);">
                        <i class="fas fa-truck"></i> Track Order
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Mobile Menu Overlay -->
    <div class="mobile-menu-overlay" id="mobileMenuOverlay"></div>
    
    <!-- Mobile Navigation Links -->
    <div class="mobile-nav-links" id="mobileNavLinks">
        <i class="fas fa-times mobile-menu-close" id="mobileMenuClose"></i>
        <a href="#hero" class="mobile-nav-link">Home</a>
        <a href="#products" class="mobile-nav-link">Products</a>
        <a href="#all-products" class="mobile-nav-link">All Products</a>
        <a href="#gallery" class="mobile-nav-link">Gallery</a>
        <a href="#social" class="mobile-nav-link">Connect</a>
    </div>

    <!-- Navigation -->
    <nav id="navbar">
        <a href="#" class="logo">
            <img src="assets/logo/logo.png" alt="Lonz Flawls Aura Logo" style="height: 60px;">
        </a>
        <div class="nav-links">
            <a href="#hero">Home</a>
            <a href="#products">Products</a>
            <a href="#all-products">All Products</a>
            <a href="#gallery">Gallery</a>
            <a href="#social">Connect</a>
        </div>
        <div class="nav-icons">
            <div class="search-container">
                <input type="text" class="search-input" id="searchInput" placeholder="Search by product, concern, or benefit">
                <i class="fas fa-search search-icon" id="searchIcon"></i>
                <i class="fas fa-times search-close" id="searchClose"></i>
                <div class="search-results" id="searchResults"></div>
            </div>
            <div class="mobile-menu-btn" id="mobileMenuBtn">
                <i class="fas fa-bars"></i>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Hero Section -->
        <section id="hero" class="hero">
            <div class="fade-in">
                <h1>Discover Your Glow</h1>
                <p>Lonz Flawls Aura combines science and nature to create premium skincare solutions that reveal your natural radiance. Experience the transformation.</p>
                <div class="hero-buttons">
                    <button class="glass-button start-qualification"><i class="fas fa-star"></i> Start Now</button>
                    <button class="glass-button"><i class="fas fa-play-circle"></i> Watch Our Story</button>
                </div>
            </div>
            <div class="scroll-indicator">
                <span>Scroll to explore</span>
                <i class="fas fa-chevron-down"></i>
            </div>
        </section>

        <!-- Lead Qualification Wizard -->
        <section id="qualification">
            <div class="lead-wizard glass-card fade-in">
                <button class="close-button" id="closeWizard">&times;</button>
                <div class="wizard-header">
                    <div class="wizard-avatar">
                        <i class="fas fa-spa"></i>
                    </div>
                    <div class="wizard-title">
                        <h3>Skin Analysis Wizard</h3>
                        <p class="wizard-priority-note">Start here for personalized recommendations tailored to your skin</p>
                    </div>
                </div>
                
                <div class="wizard-content">
                    <!-- Step 1: Skin Concern -->
                    <div class="wizard-step active" id="step1">
                        <h4>What is your primary skin concern?</h4>
                        <div class="option-grid">
                            <div class="option-item glass-card" data-value="acne">
                                <i class="fas fa-leaf"></i>
                                <p>Acne & Breakouts</p>
                            </div>
                            <div class="option-item glass-card" data-value="dark-spots">
                                <i class="fas fa-circle"></i>
                                <p>Dark Spots</p>
                            </div>
                            <div class="option-item glass-card" data-value="dry">
                                <i class="fas fa-tint"></i>
                                <p>Dryness</p>
                            </div>
                            <div class="option-item glass-card" data-value="uneven-tone">
                                <i class="fas fa-palette"></i>
                                <p>Uneven Tone</p>
                            </div>
                            <div class="option-item glass-card" data-value="glow">
                                <i class="fas fa-sun"></i>
                                <p>Glow Maintenance</p>
                            </div>
                        </div>
                        <div class="wizard-actions">
                            <button class="glass-button wizard-next" data-step="1" disabled>Next <i class="fas fa-arrow-right"></i></button>
                        </div>
                    </div>
                    
                    <!-- Step 2: Skin Sensitivity -->
                    <div class="wizard-step" id="step2">
                        <h4>How sensitive is your skin?</h4>
                        <div class="option-grid">
                            <div class="option-item glass-card" data-value="very-sensitive">
                                <i class="fas fa-exclamation-circle"></i>
                                <p>Very Sensitive</p>
                            </div>
                            <div class="option-item glass-card" data-value="sensitive">
                                <i class="fas fa-low-vision"></i>
                                <p>Sensitive</p>
                            </div>
                            <div class="option-item glass-card" data-value="normal">
                                <i class="fas fa-check-circle"></i>
                                <p>Normal</p>
                            </div>
                            <div class="option-item glass-card" data-value="resilient">
                                <i class="fas fa-shield-alt"></i>
                                <p>Resilient</p>
                            </div>
                        </div>
                        <div class="wizard-actions">
                            <button class="glass-button wizard-prev"><i class="fas fa-arrow-left"></i> Back</button>
                            <button class="glass-button wizard-next" data-step="2" disabled>Next <i class="fas fa-arrow-right"></i></button>
                        </div>
                    </div>
                    
                    <!-- Step 3: Skin Age -->
                    <div class="wizard-step" id="step3">
                        <h4>What is your skin age range?</h4>
                        <div class="option-grid">
                            <div class="option-item glass-card" data-value="under-25">
                                <i class="fas fa-child"></i>
                                <p>Under 25</p>
                            </div>
                            <div class="option-item glass-card" data-value="25-35">
                                <i class="fas fa-user"></i>
                                <p>25-35</p>
                            </div>
                            <div class="option-item glass-card" data-value="36-50">
                                <i class="fas fa-user-friends"></i>
                                <p>36-50</p>
                            </div>
                            <div class="option-item glass-card" data-value="50-plus">
                                <i class="fas fa-crown"></i>
                                <p>50+</p>
                            </div>
                        </div>
                        <div class="wizard-actions">
                            <button class="glass-button wizard-prev"><i class="fas fa-arrow-left"></i> Back</button>
                            <button class="glass-button wizard-next" data-step="3" disabled>Get Recommendations</button>
                        </div>
                    </div>
                </div>
                
                <div class="wizard-progress">
                    <div class="wizard-progress-bar" id="progressBar"></div>
                </div>
            </div>
        </section>

        <!-- Recommended Combos -->
        <section id="products">
            <div class="section-header fade-in">
                <h2>Recommended For You</h2>
                <p>Based on your skin profile, we recommend these combos for optimal results</p>
            </div>
            
            <div class="products-grid fade-in">
                <!-- Whitening Combo -->
                <div class="product-card glass-card">
                    <div class="product-badge badge-recommended">Recommended</div>
                    <div class="product-image" style="background-image: url('assets/products/whitening-combo.jpg');"></div>
                    <div class="product-info">
                        <h3>Whitening Combo</h3>
                        <p>Complete whitening set for radiant, even-toned skin. Perfect for daily use.</p>
                        <div class="product-details">
                            <div class="product-usage"><strong>Usage:</strong> Morning and night</div>
                            <div class="product-ingredients"><strong>Contains:</strong> Whitening oil, whitening soap, whitening cream</div>
                        </div>
                        <div class="product-price">R420.00</div>
                    </div>
                    <button class="glass-button add-to-cart" data-id="14" data-name="Whitening Combo" data-price="420.00" data-image="assets/products/whitening-combo.jpg"><i class="fas fa-cart-plus"></i> Add to Cart</button>
                </div>
                
                <!-- Extra Glow Combo -->
                <div class="product-card glass-card">
                    <div class="product-badge badge-bestseller">Bestseller</div>
                    <div class="product-image" style="background-image: url('assets/products/extra-glow-combo.jpg');"></div>
                    <div class="product-info">
                        <h3>Extra Glow Combo</h3>
                        <p>Complete extra glow set for radiant, hydrated skin.</p>
                        <div class="product-details">
                            <div class="product-usage"><strong>Usage:</strong> Morning and night</div>
                            <div class="product-ingredients"><strong>Contains:</strong> Extra glow soap, extra glow oil, extra glow cream</div>
                        </div>
                        <div class="product-price">R250.00</div>
                    </div>
                    <button class="glass-button add-to-cart" data-id="13" data-name="Extra Glow Combo" data-price="250.00" data-image="assets/products/extra-glow-combo.jpg"><i class="fas fa-cart-plus"></i> Add to Cart</button>
                </div>
                
                <!-- Extra Whitening Combo -->
                <div class="product-card glass-card">
                    <div class="product-badge badge-recommended">Recommended</div>
                    <div class="product-image" style="background-image: url('assets/products/extra-whitening-combo.jpg');"></div>
                    <div class="product-info">
                        <h3>Extra Whitening Combo</h3>
                        <p>Premium whitening set with kojic soap for enhanced results.</p>
                        <div class="product-details">
                            <div class="product-usage"><strong>Usage:</strong> Morning and night</div>
                            <div class="product-ingredients"><strong>Contains:</strong> Whitening oil, whitening cream, kojic soap</div>
                        </div>
                        <div class="product-price">R500.00</div>
                    </div>
                    <button class="glass-button add-to-cart" data-id="15" data-name="Extra Whitening Combo" data-price="500.00" data-image="assets/products/extra-whitening-combo.jpg"><i class="fas fa-cart-plus"></i> Add to Cart</button>
                </div>
            </div>
        </section>

        <!-- Flagship Product -->
        <section id="flagship">
            <div class="section-header fade-in">
                <h2>Flagship Whitening Oil</h2>
                <p>Our most advanced formula for radiant, even-toned skin. Experience the transformation.</p>
            </div>
            
            <div class="products-grid fade-in">
                <div class="product-card glass-card flagship-card">
                    <div class="product-badge badge-flagship">Flagship</div>
                    <div class="flagship-container">
                        <img src="assets/products/whitening-oil-100ml.jpg" alt="Whitening Oil 100ml" class="flagship-image">
                        <div class="flagship-info">
                            <h3>Whitening Oil 100ml</h3>
                            <p>Our premium whitening oil is formulated with natural extracts and advanced brightening agents. This luxurious oil targets dark spots, evens skin tone, and delivers a radiant glow with continued use. Lightweight and fast-absorbing.</p>
                            <div class="flagship-details collapsed">
                                <div class="product-benefits"><strong>Benefits:</strong> Clear dead skin, Repair damage skin, Improve skin tone</div>
                                <div class="product-usage"><strong>Usage:</strong> Morning and night</div>
                                <div class="product-ingredients"><strong>Active Ingredients:</strong> Vitamin E and C collagen, Gluthathion</div>
                            </div>
                            <button class="see-more-btn">
                                <i class="fas fa-chevron-down"></i> See More
                            </button>
                            <div class="product-price">R200.00</div>
                            <button class="glass-button add-to-cart" data-id="1" data-name="Whitening Oil 100ml" data-price="200.00" data-image="assets/products/whitening-oil-100ml.jpg" style="background: rgba(196, 167, 125, 0.3);"><i class="fas fa-gem"></i> Add to Cart</button>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- All Products -->
        <section id="all-products">
            <div class="section-header fade-in">
                <h2>All Products</h2>
                <p>Explore our complete range of premium skincare products</p>
            </div>

            <div class="products-grid fade-in">
                <!-- Whitening Cream -->
                <div class="product-card glass-card">
                    <div class="product-image" style="background-image: url('assets/products/whitening-cream-250g.jpg');"></div>
                    <div class="product-info">
                        <h3>Whitening Cream 250g</h3>
                        <p>Advanced whitening cream for even skin tone and radiant complexion.</p>
                        <div class="product-details">
                            <div class="product-benefits"><strong>Benefits:</strong> Improves skin tone, Strong moisturising, Anti Aging, Acne, Pigmentation, Dark spot, Pimples</div>
                            <div class="product-usage"><strong>Usage:</strong> Morning and night</div>
                            <div class="product-ingredients"><strong>Active Ingredients:</strong> Vitamin E and C, Collagen and Glutathione</div>
                        </div>
                        <div class="product-price">R150.00</div>
                    </div>
                    <button class="glass-button add-to-cart" data-id="2" data-name="Whitening Cream 250g" data-price="150.00" data-image="assets/products/whitening-cream-250g.jpg"><i class="fas fa-cart-plus"></i> Add to Cart</button>
                </div>

                <!-- Kojic Soap -->
                <div class="product-card glass-card">
                    <div class="product-image" style="background-image: url('assets/products/kojic-soap.jpg');"></div>
                    <div class="product-info">
                        <h3>Kojic Soap</h3>
                        <p>Treats different skin disorders and cleans whole body.</p>
                        <div class="product-details">
                            <div class="product-benefits"><strong>Benefits:</strong> Treats uneven skin tone, Dark spots due to acne, Brightens the skin</div>
                        </div>
                        <div class="product-price">R150.00</div>
                    </div>
                    <button class="glass-button add-to-cart" data-id="3" data-name="Kojic Soap" data-price="150.00" data-image="assets/products/kojic-soap.jpg"><i class="fas fa-cart-plus"></i> Add to Cart</button>
                </div>

                <!-- Extra Glow Lotion -->
                <div class="product-card glass-card">
                    <div class="product-image" style="background-image: url('assets/products/extra-glow-lotion-250g.jpg');"></div>
                    <div class="product-info">
                        <h3>Extra Glow Lotion 250g</h3>
                        <p>Hydrating lotion for glowing, healthy-looking skin.</p>
                        <div class="product-details">
                            <div class="product-benefits"><strong>Benefits:</strong> Helps with dry skin, Glowing, Dark inner thighs, Sunburn, Stretch marks, Blemishes, Wounds</div>
                            <div class="product-usage"><strong>Usage:</strong> Morning and Night</div>
                            <div class="product-ingredients"><strong>Active Ingredients:</strong> Vitamin C, Vegetal glycerin, Sodium lactate</div>
                        </div>
                        <div class="product-price">R100.00</div>
                    </div>
                    <button class="glass-button add-to-cart" data-id="4" data-name="Extra Glow Lotion 250g" data-price="100.00" data-image="assets/products/extra-glow-lotion-250g.jpg"><i class="fas fa-cart-plus"></i> Add to Cart</button>
                </div>

                <!-- Whitening Soap -->
                <div class="product-card glass-card">
                    <div class="product-image" style="background-image: url('assets/products/whitening-soap.jpg');"></div>
                    <div class="product-info">
                        <h3>Whitening Soap</h3>
                        <p>Gentle cleansing soap for skin whitening purposes.</p>
                        <div class="product-details">
                            <div class="product-benefits"><strong>Benefits:</strong> Skin whitening purposes, Eliminates excess oils, Eliminates blemishes, Gently exfoliates dead skin cells, Treats hyperpigmentation and Acne</div>
                            <div class="product-usage"><strong>Usage:</strong> Morning and Night</div>
                            <div class="product-ingredients"><strong>Active Ingredients:</strong> Collagen extract, Licorice, Glutathione extract and Arbutin extract</div>
                        </div>
                        <div class="product-price">R70.00</div>
                    </div>
                    <button class="glass-button add-to-cart" data-id="5" data-name="Whitening Soap" data-price="70.00" data-image="assets/products/whitening-soap.jpg"><i class="fas fa-cart-plus"></i> Add to Cart</button>
                </div>

                <!-- Extra Glow Soap -->
                <div class="product-card glass-card">
                    <div class="product-image" style="background-image: url('assets/products/extra-glow-soap.jpg');"></div>
                    <div class="product-info">
                        <h3>Extra Glow Soap</h3>
                        <p>Nourishing soap for glowing, moisturized skin.</p>
                        <div class="product-details">
                            <div class="product-benefits"><strong>Benefits:</strong> Brings out the glow, Moisturises dry skin, Helps treat Stretch marks, Helps fade skin scars</div>
                            <div class="product-usage"><strong>Usage:</strong> Morning and Night</div>
                            <div class="product-ingredients"><strong>Active Ingredients:</strong> Turmeric + Vitamin C, Essential oils, Lemon, Palm oil and Honey</div>
                        </div>
                        <div class="product-price">R70.00</div>
                    </div>
                    <button class="glass-button add-to-cart" data-id="6" data-name="Extra Glow Soap" data-price="70.00" data-image="assets/products/extra-glow-soap.jpg"><i class="fas fa-cart-plus"></i> Add to Cart</button>
                </div>

                <!-- Whitening Tissue Oil -->
                <div class="product-card glass-card">
                    <div class="product-image" style="background-image: url('assets/products/whitening-tissue-oil.jpg');"></div>
                    <div class="product-info">
                        <h3>Whitening Tissue Oil</h3>
                        <p>Lightweight tissue oil for targeted whitening treatment.</p>
                        <div class="product-price">R200.00</div>
                    </div>
                    <button class="glass-button add-to-cart" data-id="7" data-name="Whitening Tissue Oil" data-price="200.00" data-image="assets/products/whitening-tissue-oil.jpg"><i class="fas fa-cart-plus"></i> Add to Cart</button>
                </div>

                <!-- Extra Glow Oil -->
                <div class="product-card glass-card">
                    <div class="product-image" style="background-image: url('assets/products/extra-glow-oil.jpg');"></div>
                    <div class="product-info">
                        <h3>Extra Glow Oil</h3>
                        <p>Radiant glow oil for luminous, healthy-looking skin.</p>
                        <div class="product-price">R100.00</div>
                    </div>
                    <button class="glass-button add-to-cart" data-id="8" data-name="Extra Glow Oil" data-price="100.00" data-image="assets/products/extra-glow-oil.jpg"><i class="fas fa-cart-plus"></i> Add to Cart</button>
                </div>

                <!-- AMAL FRAGRANCES SECTION -->
                <!-- Collection 1: THE EXCLUSIVE OUD COLLECTION -->
                <div class="product-card glass-card">
                    <div class="product-badge badge-recommended">New</div>
                    <div class="product-image" style="background-image: url('assets/fragrances/black-oud-30ml.jpg');"></div>
                    <div class="product-info">
                        <h3>Black Oud (30ml)</h3>
                        <p>THE EXCLUSIVE OUD COLLECTION - A rich, deep oud fragrance with woody notes.</p>
                        <div class="product-details">
                            <div class="product-benefits"><strong>Fragrance:</strong> Black Oud</div>
                            <div class="product-usage"><strong>Size:</strong> 30ml</div>
                            <div class="product-ingredients"><strong>Collection:</strong> Amal Fragrances</div>
                        </div>
                        <div class="product-price">R180.00</div>
                    </div>
                    <button class="glass-button add-to-cart" data-id="100" data-name="Black Oud (30ml)" data-price="180.00" data-image="assets/fragrances/black-oud-30ml.jpg"><i class="fas fa-cart-plus"></i> Add to Cart</button>
                </div>

                <div class="product-card glass-card">
                    <div class="product-badge badge-recommended">New</div>
                    <div class="product-image" style="background-image: url('assets/fragrances/black-oud-50ml.jpg');"></div>
                    <div class="product-info">
                        <h3>Black Oud (50ml)</h3>
                        <p>THE EXCLUSIVE OUD COLLECTION - A rich, deep oud fragrance with woody notes.</p>
                        <div class="product-details">
                            <div class="product-benefits"><strong>Fragrance:</strong> Black Oud</div>
                            <div class="product-usage"><strong>Size:</strong> 50ml</div>
                            <div class="product-ingredients"><strong>Collection:</strong> Amal Fragrances</div>
                        </div>
                        <div class="product-price">R250.00</div>
                    </div>
                    <button class="glass-button add-to-cart" data-id="101" data-name="Black Oud (50ml)" data-price="250.00" data-image="assets/fragrances/black-oud-50ml.jpg"><i class="fas fa-cart-plus"></i> Add to Cart</button>
                </div>

                <div class="product-card glass-card">
                    <div class="product-badge badge-recommended">New</div>
                    <div class="product-image" style="background-image: url('assets/fragrances/black-oud-100ml.jpg');"></div>
                    <div class="product-info">
                        <h3>Black Oud (100ml)</h3>
                        <p>THE EXCLUSIVE OUD COLLECTION - A rich, deep oud fragrance with woody notes.</p>
                        <div class="product-details">
                            <div class="product-benefits"><strong>Fragrance:</strong> Black Oud</div>
                            <div class="product-usage"><strong>Size:</strong> 100ml</div>
                            <div class="product-ingredients"><strong>Collection:</strong> Amal Fragrances</div>
                        </div>
                        <div class="product-price">R450.00</div>
                    </div>
                    <button class="glass-button add-to-cart" data-id="102" data-name="Black Oud (100ml)" data-price="450.00" data-image="assets/fragrances/black-oud-100ml.jpg"><i class="fas fa-cart-plus"></i> Add to Cart</button>
                </div>

                <div class="product-card glass-card">
                    <div class="product-badge badge-recommended">New</div>
                    <div class="product-image" style="background-image: url('assets/fragrances/white-oud-30ml.jpg');"></div>
                    <div class="product-info">
                        <h3>White Oud (30ml)</h3>
                        <p>THE EXCLUSIVE OUD COLLECTION - A lighter, floral oud fragrance with subtle notes.</p>
                        <div class="product-details">
                            <div class="product-benefits"><strong>Fragrance:</strong> White Oud</div>
                            <div class="product-usage"><strong>Size:</strong> 30ml</div>
                            <div class="product-ingredients"><strong>Collection:</strong> Amal Fragrances</div>
                        </div>
                        <div class="product-price">R180.00</div>
                    </div>
                    <button class="glass-button add-to-cart" data-id="103" data-name="White Oud (30ml)" data-price="180.00" data-image="assets/fragrances/white-oud-30ml.jpg"><i class="fas fa-cart-plus"></i> Add to Cart</button>
                </div>

                <div class="product-card glass-card">
                    <div class="product-badge badge-recommended">New</div>
                    <div class="product-image" style="background-image: url('assets/fragrances/white-oud-50ml.jpg');"></div>
                    <div class="product-info">
                        <h3>White Oud (50ml)</h3>
                        <p>THE EXCLUSIVE OUD COLLECTION - A lighter, floral oud fragrance with subtle notes.</p>
                        <div class="product-details">
                            <div class="product-benefits"><strong>Fragrance:</strong> White Oud</div>
                            <div class="product-usage"><strong>Size:</strong> 50ml</div>
                            <div class="product-ingredients"><strong>Collection:</strong> Amal Fragrances</div>
                        </div>
                        <div class="product-price">R250.00</div>
                    </div>
                    <button class="glass-button add-to-cart" data-id="104" data-name="White Oud (50ml)" data-price="250.00" data-image="assets/fragrances/white-oud-50ml.jpg"><i class="fas fa-cart-plus"></i> Add to Cart</button>
                </div>

                <div class="product-card glass-card">
                    <div class="product-badge badge-recommended">New</div>
                    <div class="product-image" style="background-image: url('assets/fragrances/white-oud-100ml.jpg');"></div>
                    <div class="product-info">
                        <h3>White Oud (100ml)</h3>
                        <p>THE EXCLUSIVE OUD COLLECTION - A lighter, floral oud fragrance with subtle notes.</p>
                        <div class="product-details">
                            <div class="product-benefits"><strong>Fragrance:</strong> White Oud</div>
                            <div class="product-usage"><strong>Size:</strong> 100ml</div>
                            <div class="product-ingredients"><strong>Collection:</strong> Amal Fragrances</div>
                        </div>
                        <div class="product-price">R450.00</div>
                    </div>
                    <button class="glass-button add-to-cart" data-id="105" data-name="White Oud (100ml)" data-price="450.00" data-image="assets/fragrances/white-oud-100ml.jpg"><i class="fas fa-cart-plus"></i> Add to Cart</button>
                </div>

                <div class="product-card glass-card">
                    <div class="product-badge badge-recommended">New</div>
                    <div class="product-image" style="background-image: url('assets/fragrances/black-oud-30ml-2.jpg');"></div>
                    <div class="product-info">
                        <h3>Black Oud (30ml)</h3>
                        <p>THE EXCLUSIVE OUD COLLECTION - A rich, deep oud fragrance with woody notes.</p>
                        <div class="product-details">
                            <div class="product-benefits"><strong>Fragrance:</strong> Black Oud</div>
                            <div class="product-usage"><strong>Size:</strong> 30ml</div>
                            <div class="product-ingredients"><strong>Collection:</strong> Amal Fragrances</div>
                        </div>
                        <div class="product-price">R180.00</div>
                    </div>
                    <button class="glass-button add-to-cart" data-id="106" data-name="Black Oud (30ml)" data-price="180.00" data-image="assets/fragrances/black-oud-30ml-2.jpg"><i class="fas fa-cart-plus"></i> Add to Cart</button>
                </div>

                <div class="product-card glass-card">
                    <div class="product-badge badge-recommended">New</div>
                    <div class="product-image" style="background-image: url('assets/fragrances/black-oud-50ml-2.jpg');"></div>
                    <div class="product-info">
                        <h3>Black Oud (50ml)</h3>
                        <p>THE EXCLUSIVE OUD COLLECTION - A rich, deep oud fragrance with woody notes.</p>
                        <div class="product-details">
                            <div class="product-benefits"><strong>Fragrance:</strong> Black Oud</div>
                            <div class="product-usage"><strong>Size:</strong> 50ml</div>
                            <div class="product-ingredients"><strong>Collection:</strong> Amal Fragrances</div>
                        </div>
                        <div class="product-price">R250.00</div>
                    </div>
                    <button class="glass-button add-to-cart" data-id="107" data-name="Black Oud (50ml)" data-price="250.00" data-image="assets/fragrances/black-oud-50ml-2.jpg"><i class="fas fa-cart-plus"></i> Add to Cart</button>
                </div>

                <div class="product-card glass-card">
                    <div class="product-badge badge-recommended">New</div>
                    <div class="product-image" style="background-image: url('assets/fragrances/black-oud-100ml-2.jpg');"></div>
                    <div class="product-info">
                        <h3>Black Oud (100ml)</h3>
                        <p>THE EXCLUSIVE OUD COLLECTION - A rich, deep oud fragrance with woody notes.</p>
                        <div class="product-details">
                            <div class="product-benefits"><strong>Fragrance:</strong> Black Oud</div>
                            <div class="product-usage"><strong>Size:</strong> 100ml</div>
                            <div class="product-ingredients"><strong>Collection:</strong> Amal Fragrances</div>
                        </div>
                        <div class="product-price">R450.00</div>
                    </div>
                    <button class="glass-button add-to-cart" data-id="108" data-name="Black Oud (100ml)" data-price="450.00" data-image="assets/fragrances/black-oud-100ml-2.jpg"><i class="fas fa-cart-plus"></i> Add to Cart</button>
                </div>

                <!-- Collection 2: THE EXCLUSIVE OUD SPRING COLLECTION -->
                <div class="product-card glass-card">
                    <div class="product-badge badge-bestseller">Bestseller</div>
                    <div class="product-image" style="background-image: url('assets/fragrances/oud-joy-50ml.jpg');"></div>
                    <div class="product-info">
                        <h3>OUD JOY (50ml)</h3>
                        <p>THE EXCLUSIVE OUD SPRING COLLECTION - A fresh, uplifting oud fragrance for spring.</p>
                        <div class="product-details">
                            <div class="product-benefits"><strong>Fragrance:</strong> OUD JOY</div>
                            <div class="product-usage"><strong>Size:</strong> 50ml</div>
                            <div class="product-ingredients"><strong>Collection:</strong> Amal Fragrances</div>
                        </div>
                        <div class="product-price">R350.00</div>
                    </div>
                    <button class="glass-button add-to-cart" data-id="109" data-name="OUD JOY (50ml)" data-price="350.00" data-image="assets/fragrances/oud-joy-50ml.jpg"><i class="fas fa-cart-plus"></i> Add to Cart</button>
                </div>

                <div class="product-card glass-card">
                    <div class="product-badge badge-bestseller">Bestseller</div>
                    <div class="product-image" style="background-image: url('assets/fragrances/oud-joy-100ml.jpg');"></div>
                    <div class="product-info">
                        <h3>OUD JOY (100ml)</h3>
                        <p>THE EXCLUSIVE OUD SPRING COLLECTION - A fresh, uplifting oud fragrance for spring.</p>
                        <div class="product-details">
                            <div class="product-benefits"><strong>Fragrance:</strong> OUD JOY</div>
                            <div class="product-usage"><strong>Size:</strong> 100ml</div>
                            <div class="product-ingredients"><strong>Collection:</strong> Amal Fragrances</div>
                        </div>
                        <div class="product-price">R600.00</div>
                    </div>
                    <button class="glass-button add-to-cart" data-id="110" data-name="OUD JOY (100ml)" data-price="600.00" data-image="assets/fragrances/oud-joy-100ml.jpg"><i class="fas fa-cart-plus"></i> Add to Cart</button>
                </div>

                <!-- Collection 3: THE PREMIUM OUD COLLECTION -->
                <div class="product-card glass-card">
                    <div class="product-badge badge-flagship">Premium</div>
                    <div class="product-image" style="background-image: url('assets/fragrances/premium-oud-50ml.jpg');"></div>
                    <div class="product-info">
                        <h3>Premium Oud (50ml)</h3>
                        <p>THE PREMIUM OUD COLLECTION - Luxurious oud fragrance with premium ingredients.</p>
                        <div class="product-details">
                            <div class="product-benefits"><strong>Collection:</strong> Premium Oud</div>
                            <div class="product-usage"><strong>Size:</strong> 50ml</div>
                            <div class="product-ingredients"><strong>Category:</strong> Amal Fragrances</div>
                        </div>
                        <div class="product-price">R900.00</div>
                    </div>
                    <button class="glass-button add-to-cart" data-id="111" data-name="Premium Oud (50ml)" data-price="900.00" data-image="assets/fragrances/premium-oud-50ml.jpg"><i class="fas fa-cart-plus"></i> Add to Cart</button>
                </div>

                <div class="product-card glass-card">
                    <div class="product-badge badge-flagship">Premium</div>
                    <div class="product-image" style="background-image: url('assets/fragrances/premium-oud-100ml.jpg');"></div>
                    <div class="product-info">
                        <h3>Premium Oud (100ml)</h3>
                        <p>THE PREMIUM OUD COLLECTION - Luxurious oud fragrance with premium ingredients.</p>
                        <div class="product-details">
                            <div class="product-benefits"><strong>Collection:</strong> Premium Oud</div>
                            <div class="product-usage"><strong>Size:</strong> 100ml</div>
                            <div class="product-ingredients"><strong>Category:</strong> Amal Fragrances</div>
                        </div>
                        <div class="product-price">R1500.00</div>
                    </div>
                    <button class="glass-button add-to-cart" data-id="112" data-name="Premium Oud (100ml)" data-price="1500.00" data-image="assets/fragrances/premium-oud-100ml.jpg"><i class="fas fa-cart-plus"></i> Add to Cart</button>
                </div>

                <!-- Collection 5: THE HOME DIFFUSER OUD COLLECTION -->
                <div class="product-card glass-card">
                    <div class="product-badge badge-recommended">Home Fragrance</div>
                    <div class="product-image" style="background-image: url('assets/fragrances/home-diffuser-oud.jpg');"></div>
                    <div class="product-info">
                        <h3>Home Diffuser Oud</h3>
                        <p>THE HOME DIFFUSER OUD COLLECTION - Create a luxurious ambiance with oud fragrance.</p>
                        <div class="product-details">
                            <div class="product-benefits"><strong>Type:</strong> Home Diffuser</div>
                            <div class="product-usage"><strong>Use:</strong> Home fragrance</div>
                            <div class="product-ingredients"><strong>Category:</strong> Amal Fragrances</div>
                        </div>
                        <div class="product-price">R350.00</div>
                    </div>
                    <button class="glass-button add-to-cart" data-id="113" data-name="Home Diffuser Oud" data-price="350.00" data-image="assets/fragrances/home-diffuser-oud.jpg"><i class="fas fa-cart-plus"></i> Add to Cart</button>
                </div>

                <!-- Collection 6: THE CAR DIFFUSER OUD COLLECTION -->
                <div class="product-card glass-card">
                    <div class="product-image" style="background-image: url('assets/fragrances/car-diffuser-oud.jpg');"></div>
                    <div class="product-info">
                        <h3>Car Diffuser Oud</h3>
                        <p>THE CAR DIFFUSER OUD COLLECTION - Enjoy oud fragrance during your travels.</p>
                        <div class="product-details">
                            <div class="product-benefits"><strong>Type:</strong> Car Diffuser</div>
                            <div class="product-usage"><strong>Use:</strong> Car fragrance</div>
                            <div class="product-ingredients"><strong>Category:</strong> Amal Fragrances</div>
                        </div>
                        <div class="product-price">R80.00</div>
                    </div>
                    <button class="glass-button add-to-cart" data-id="114" data-name="Car Diffuser Oud" data-price="80.00" data-image="assets/fragrances/car-diffuser-oud.jpg"><i class="fas fa-cart-plus"></i> Add to Cart</button>
                </div>

                <!-- Collection 7: THE BODY LOTION OUD COLLECTION -->
                <div class="product-card glass-card">
                    <div class="product-image" style="background-image: url('assets/fragrances/body-lotion-oud.jpg');"></div>
                    <div class="product-info">
                        <h3>Body Lotion Oud</h3>
                        <p>THE BODY LOTION OUD COLLECTION - Moisturizing body lotion with oud fragrance.</p>
                        <div class="product-details">
                            <div class="product-benefits"><strong>Type:</strong> Body Lotion</div>
                            <div class="product-usage"><strong>Use:</strong> Daily moisturizer</div>
                            <div class="product-ingredients"><strong>Category:</strong> Amal Fragrances</div>
                        </div>
                        <div class="product-price">R200.00</div>
                    </div>
                    <button class="glass-button add-to-cart" data-id="115" data-name="Body Lotion Oud" data-price="200.00" data-image="assets/fragrances/body-lotion-oud.jpg"><i class="fas fa-cart-plus"></i> Add to Cart</button>
                </div>

                <!-- Collection 8: THE DEODORANT OUD COLLECTION -->
                <div class="product-card glass-card">
                    <div class="product-image" style="background-image: url('assets/fragrances/deodorant-oud.jpg');"></div>
                    <div class="product-info">
                        <h3>Deodorant Oud</h3>
                        <p>THE DEODORANT OUD COLLECTION - Long-lasting deodorant with oud fragrance.</p>
                        <div class="product-details">
                            <div class="product-benefits"><strong>Type:</strong> Deodorant</div>
                            <div class="product-usage"><strong>Use:</strong> Daily protection</div>
                            <div class="product-ingredients"><strong>Category:</strong> Amal Fragrances</div>
                        </div>
                        <div class="product-price">R100.00</div>
                    </div>
                    <button class="glass-button add-to-cart" data-id="116" data-name="Deodorant Oud" data-price="100.00" data-image="assets/fragrances/deodorant-oud.jpg"><i class="fas fa-cart-plus"></i> Add to Cart</button>
                </div>
            </div>
        </section>

        <!-- Gallery -->
        <section id="gallery">
            <div class="section-header fade-in">
                <h2>Glow Gallery</h2>
                <p>See the transformation and lifestyle with Lonz Flawls Aura</p>
            </div>
            
            <div class="gallery-container fade-in">
                <div class="gallery-track" id="galleryTrack">
                    <div class="gallery-slide glass-card">
                        <img src="assets/gallery/gallery-1.jpg" alt="Skincare products">
                    </div>
                    <div class="gallery-slide glass-card">
                        <img src="assets/gallery/gallery-2.jpg" alt="Product application">
                    </div>
                    <div class="gallery-slide glass-card">
                        <img src="assets/gallery/gallery-3.jpg" alt="Natural ingredients">
                    </div>
                    <div class="gallery-slide glass-card">
                        <img src="assets/gallery/gallery-4.jpg" alt="Luxury skincare">
                    </div>
                    <div class="gallery-slide glass-card">
                        <img src="assets/gallery/gallery-5.jpg" alt="Radiant skin results">
                    </div>
                </div>
                
                <div class="gallery-nav">
                    <div class="gallery-dot active" data-index="0"></div>
                    <div class="gallery-dot" data-index="1"></div>
                    <div class="gallery-dot" data-index="2"></div>
                    <div class="gallery-dot" data-index="3"></div>
                    <div class="gallery-dot" data-index="4"></div>
                </div>
            </div>
        </section>

        <!-- Social Links Section -->
        <section id="social" class="social-section">
            <div class="fade-in">
                <h3>Join Our Glow Community</h3>
                <p>Follow us for skincare tips, behind-the-scenes, and exclusive offers</p>
                <div class="social-links-container">
                    <a href="https://www.facebook.com/lonia.mongwe" target="_blank" class="social-button facebook">
                        <i class="fab fa-facebook-f"></i>
                    </a>
                    <a href="https://www.tiktok.com/@loniamongwe?_r=1&_t=ZS-92GQkfgjDU4" target="_blank" class="social-button tiktok">
                        <i class="fab fa-tiktok"></i>
                    </a>
                    <a href="https://wa.me/+27735511216" target="_blank" class="social-button whatsapp">
                        <i class="fab fa-whatsapp"></i>
                    </a>
                    <a href="mailto:mongwelonia@gmail.com" target="_blank" class="social-button email">
                        <i class="fas fa-envelope"></i>
                    </a>
                    <a href="https://www.instagram.com/mongwelonia?igsh=MXBoN2s5YnVzeHFxbg==" target="_blank" class="social-button instagram">
                        <i class="fab fa-instagram"></i>
                    </a>
                </div>
                <div style="margin-top: 30px;">
                    <p style="color: rgba(255, 255, 255, 0.8);">Direct WhatsApp: <strong>+27 73 551 1216</strong></p>
                    <p style="color: rgba(255, 255, 255, 0.8); margin-top: 10px;">Email: <strong>mongwelonia@gmail.com</strong></p>
                </div>
            </div>
        </section>

        <!-- Footer -->
        <footer id="footer">
            <div class="footer-content fade-in">
                <div class="footer-column">
                    <h4>Lonz Flawls Aura</h4>
                    <p>Premium skincare solutions that combine science and nature to reveal your natural radiance. Start your glow journey today.</p>
                </div>
                
                <div class="footer-column">
                    <h4>Quick Links</h4>
                    <ul class="footer-links">
                        <li><a href="#hero">Home</a></li>
                        <li><a href="#products">Products</a></li>
                        <li><a href="#all-products">All Products</a></li>
                        <li><a href="#gallery">Gallery</a></li>
                        <li><a href="#social">Connect</a></li>
                    </ul>
                </div>
                
                <div class="footer-column">
                    <h4>Contact Info</h4>
                    <p><i class="fab fa-whatsapp"></i> +27 73 551 1216</p>
                    <p><i class="fas fa-envelope"></i> mongwelonia@gmail.com</p>
                    <p><i class="fas fa-map-marker-alt"></i> South Africa</p>
                </div>
                
                <div class="footer-column">
                    <h4>Join Our Glow Club</h4>
                    <p>Subscribe to get exclusive offers, skincare tips, and early access to new products.</p>
                    <div class="newsletter-form">
                        <input type="email" placeholder="Your email address">
                        <button class="glass-button">Subscribe</button>
                    </div>
                </div>
            </div>
            
            <div class="copyright">
                <p>&copy; 2023 Lonz Flawls Aura. All rights reserved. | Premium Skincare</p>
            </div>
        </footer>
    </div>

    <!-- Results Modal -->
    <div class="results-modal" id="resultsModal">
        <button class="close-button" id="closeResults">&times;</button>
        
        <div class="affirmations-section fade-in">
            <div class="result-icon">
                <i class="fas fa-spa"></i>
            </div>
            <div class="result-message">
                <h3>Your Personalized Glow Plan</h3>
                <p id="resultDescription"></p>
            </div>
        </div>
        
        <div class="results-products-section">
            <div class="results-products-container glass-card">
                <div class="personalized-products-container" id="personalizedProducts"></div>
                
                <div class="result-actions">
                    <button class="glass-button" id="closeResultsBtn">Continue Browsing</button>
                    <button class="glass-button" style="background: rgba(196, 167, 125, 0.3); margin-left: 15px;" id="addAllToCart">
                        <i class="fas fa-shopping-cart"></i> Add All to Cart
                    </button>
                </div>
            </div>
        </div>
    </div>
    <!-- Supabase Initialization -->
    <script>
        // Initialize Supabase
        const supabaseUrl = 'YOUR_SUPABASE_URL_HERE';
        const supabaseKey = 'YOUR_SUPABASE_ANON_KEY_HERE';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        // Supabase hooks will be integrated into existing JavaScript
        // The existing JavaScript code should be placed after this initialization
    </script>

       <script>
                 // DOM Elements - ADDING NEW ONES FOR AUTHENTICATION
        const authChoiceModal = document.getElementById('authChoiceModal');
        const closeAuthChoiceBtn = document.getElementById('closeAuthChoice');
        const guestOption = document.getElementById('guestOption');
        const signupOption = document.getElementById('signupOption');
        const loginOption = document.getElementById('loginOption');

        const enhancedAuthModal = document.getElementById('enhancedAuthModal');
        const closeEnhancedAuthBtn = document.getElementById('closeEnhancedAuth');
        const enhancedAuthTabs = document.querySelectorAll('.enhanced-auth-tab');
        const enhancedAuthForms = document.querySelectorAll('.enhanced-auth-form');
        const enhancedLoginForm = document.getElementById('enhancedLoginForm');
        const enhancedSignupForm = document.getElementById('enhancedSignupForm');
        const switchToSignupEnhanced = document.querySelector('.switch-to-signup-enhanced');
        const switchToLoginEnhanced = document.querySelector('.switch-to-login-enhanced');
        const signupDiscount = document.getElementById('signupDiscount');

        const authLoading = document.getElementById('authLoading');
        const authSuccess = document.getElementById('authSuccess');
        const mainAuthContent = document.getElementById('mainAuthContent');

        // Social login buttons
        const googleLogin = document.getElementById('googleLogin');
        const facebookLogin = document.getElementById('facebookLogin');
        const appleLogin = document.getElementById('appleLogin');
        const googleSignup = document.getElementById('googleSignup');
        const facebookSignup = document.getElementById('facebookSignup');
        const appleSignup = document.getElementById('appleSignup');

        // Password strength elements
        const passwordInput = document.getElementById('enhancedSignupPassword');
        const passwordStrength = document.getElementById('passwordStrength');
        const reqLength = document.getElementById('reqLength');
        const reqUppercase = document.getElementById('reqUppercase');
        const reqLowercase = document.getElementById('reqLowercase');
        const reqNumber = document.getElementById('reqNumber');

        // All existing JavaScript remains the same until the end, where we'll add new functions

        /* ALL EXISTING JAVASCRIPT CODE REMAINS EXACTLY THE SAME */
        // DOM Elements
        const navbar = document.getElementById('navbar');
        const fadeElements = document.querySelectorAll('.fade-in');
        const startQualificationBtn = document.querySelector('.start-qualification');
        const wizardSteps = document.querySelectorAll('.wizard-step');
        const optionItems = document.querySelectorAll('.option-item');
        const wizardNextBtns = document.querySelectorAll('.wizard-next');
        const wizardPrevBtns = document.querySelectorAll('.wizard-prev');
        const progressBar = document.getElementById('progressBar');
        const resultsModal = document.getElementById('resultsModal');
        const closeResultsBtn = document.getElementById('closeResults');
        const closeResultsBtn2 = document.getElementById('closeResultsBtn');
        const addAllToCartBtn = document.getElementById('addAllToCart');
        const galleryTrack = document.getElementById('galleryTrack');
        const galleryDots = document.querySelectorAll('.gallery-dot');

        // Search elements
        const searchIcon = document.getElementById('searchIcon');
        const searchInput = document.getElementById('searchInput');
        const searchClose = document.getElementById('searchClose');
        const searchResults = document.getElementById('searchResults');

        // New search overlay elements
        const searchOverlay = document.getElementById('searchOverlay');
        const searchOverlayInput = document.getElementById('searchOverlayInput');
        const searchOverlayResults = document.getElementById('searchOverlayResults');
        const searchBackBtn = document.getElementById('searchBackBtn');

        // Cart elements
        const floatingCartBtn = document.getElementById('floatingCartBtn');
        const floatingCartBadge = document.getElementById('floatingCartBadge');
        const cartModal = document.getElementById('cartModal');
        const closeCartBtn = document.getElementById('closeCart');
        const cartItems = document.getElementById('cartItems');
        const cartSummary = document.getElementById('cartSummary');
        const addToCartBtns = document.querySelectorAll('.add-to-cart');
        const checkoutBtn = document.getElementById('checkoutBtn');

        // Close buttons
        const closeAuthBtn = document.getElementById('closeAuth');
        const closeWizardBtn = document.getElementById('closeWizard');
        const closeCheckoutBtn = document.getElementById('closeCheckout');
        const closeSuccessBtn = document.getElementById('closeSuccess');

        // Checkout elements
        const checkoutModal = document.getElementById('checkoutModal');
        const checkoutSteps = document.querySelectorAll('.checkout-step');
        const checkoutForms = document.querySelectorAll('.checkout-form');
        const shippingForm = document.getElementById('shippingForm');
        const paymentForm = document.getElementById('paymentForm');
        const reviewForm = document.getElementById('reviewForm');
        const backToCartBtn = document.getElementById('backToCart');
        const nextToPaymentBtn = document.getElementById('nextToPayment');
        const backToShippingBtn = document.getElementById('backToShipping');
        const nextToReviewBtn = document.getElementById('nextToReview');
        const backToPaymentBtn2 = document.getElementById('backToPayment');
        const placeOrderBtn = document.getElementById('placeOrderBtn');
        const paymentMethods = document.querySelectorAll('.payment-method');
        const paypalButton = document.getElementById('paypalButton');

        // Payment method details
        const creditCardDetails = document.getElementById('creditCardDetails');
        const paypalDetails = document.getElementById('paypalDetails');
        const bankTransferDetails = document.getElementById('bankTransferDetails');

        // Success modal elements
        const successModal = document.getElementById('successModal');
        const successMessage = document.getElementById('successMessage');
        const continueShoppingBtn = document.getElementById('continueShopping');

        // Mobile menu elements
        const mobileMenuBtn = document.getElementById('mobileMenuBtn');
        const mobileMenuBtnIcon = document.querySelector('#mobileMenuBtn i');
        const mobileMenuOverlay = document.getElementById('mobileMenuOverlay');
        const mobileNavLinks = document.getElementById('mobileNavLinks');
        const mobileMenuClose = document.getElementById('mobileMenuClose');
        const mobileNavLinksItems = document.querySelectorAll('.mobile-nav-link');

        // Flagship product elements
        const seeMoreBtn = document.querySelector('.see-more-btn');
        const flagshipDetails = document.querySelector('.flagship-details');

        // Enhanced Product data with skin issues and benefits - UPDATED WITH AMAL FRAGRANCES
        const products = [
            {
                id: 1,
                name: "Whitening Oil 100ml",
                price: 200.00,
                image: "https://images.unsplash.com/photo-1556228453-efd6c1ff04f6?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&q=80",
                description: "Our premium whitening oil is formulated with natural extracts and advanced brightening agents.",
                benefits: "Clear dead skin, Repair damage skin, Improve skin tone",
                usage: "Morning and night",
                ingredients: "Vitamin E and C collagen, Gluthathion",
                category: "oil",
                skinIssues: ["dark spots", "uneven skin tone", "dull skin", "hyperpigmentation", "aging skin"],
                benefitsList: ["brightening", "moisturizing", "anti-aging", "skin repair"],
                searchScore: 95,
                section: "flagship"
            },
            {
                id: 2,
                name: "Whitening Cream 250g",
                price: 150.00,
                image: "https://images.unsplash.com/photo-1596462502278-27bfdc403348?ixlib=rb-4.0.3&auto=format&fit=crop&w=600&q=80",
                description: "Advanced whitening cream for even skin tone and radiant complexion.",
                benefits: "Improves skin tone, Strong moisturising, Anti Aging, Acne, Pigmentation, Dark spot, Pimples",
                usage: "Morning and night",
                ingredients: "Vitamin E and C, Collagen and Glutathione",
                category: "cream",
                skinIssues: ["acne", "dark spots", "pigmentation", "uneven skin tone", "pimples", "aging"],
                benefitsList: ["moisturizing", "anti-acne", "brightening", "anti-aging"],
                searchScore: 90,
                section: "all-products"
            },
            {
                id: 3,
                name: "Kojic Soap",
                price: 150.00,
                image: "https://images.unsplash.com/photo-1571781926291-c477ebfd024b?ixlib=rb-4.0.3&auto=format&fit=crop&w=600&q=80",
                description: "Treats different skin disorders and cleans whole body.",
                benefits: "Treats uneven skin tone, Dark spots due to acne, Brightens the skin",
                usage: "",
                ingredients: "",
                category: "soap",
                skinIssues: ["uneven skin tone", "dark spots", "acne scars", "dull skin", "hyperpigmentation"],
                benefitsList: ["cleansing", "brightening", "exfoliating", "acne treatment"],
                searchScore: 85,
                section: "all-products"
            },
            {
                id: 4,
                name: "Extra Glow Lotion 250g",
                price: 100.00,
                image: "https://images.unsplash.com/photo-1556228578-9c360e1d8d34?ixlib=rb-4.0.3&auto=format&fit=crop&w=600&q=80",
                description: "Hydrating lotion for glowing, healthy-looking skin.",
                benefits: "Helps with dry skin, Glowing, Dark inner thighs, Sunburn, Stretch marks, Blemishes, Wounds",
                usage: "Morning and Night",
                ingredients: "Vitamin C, Vegetal glycerin, Sodium lactate",
                category: "lotion",
                skinIssues: ["dry skin", "stretch marks", "blemishes", "sunburn", "dull skin", "dark inner thighs"],
                benefitsList: ["hydration", "glowing skin", "skin repair", "moisturizing"],
                searchScore: 80,
                section: "all-products"
            },
            {
                id: 5,
                name: "Whitening Soap",
                price: 70.00,
                image: "https://images.unsplash.com/photo-1556228453-efd6c1ff04f6?ixlib=rb-4.0.3&auto=format&fit=crop&w=600&q=80",
                description: "Gentle cleansing soap for skin whitening purposes.",
                benefits: "Skin whitening purposes, Eliminates excess oils, Eliminates blemishes, Gently exfoliates dead skin cells, Treats hyperpigmentation and Acne",
                usage: "Morning and Night",
                ingredients: "Collagen extract, Licorice, Glutathione extract and Arbutin extract",
                category: "soap",
                skinIssues: ["excess oil", "blemishes", "hyperpigmentation", "acne", "dull skin"],
                benefitsList: ["cleansing", "brightening", "oil control", "exfoliating"],
                searchScore: 75,
                section: "all-products"
            },
            {
                id: 6,
                name: "Extra Glow Soap",
                price: 70.00,
                image: "https://images.unsplash.com/photo-1571781926291-c477ebfd024b?ixlib=rb-4.0.3&auto=format&fit=crop&w=600&q=80",
                description: "Nourishing soap for glowing, moisturized skin.",
                benefits: "Brings out the glow, Moisturises dry skin, Helps treat Stretch marks, Helps fade skin scars",
                usage: "Morning and Night",
                ingredients: "Turmeric + Vitamin C, Essential oils, Lemon, Palm oil and Honey",
                category: "soap",
                skinIssues: ["dry skin", "stretch marks", "skin scars", "dull skin"],
                benefitsList: ["glowing skin", "moisturizing", "skin repair", "nourishing"],
                searchScore: 70,
                section: "all-products"
            },
            {
                id: 7,
                name: "Whitening Tissue Oil",
                price: 200.00,
                image: "https://images.unsplash.com/photo-1556228453-efd6c1ff04f6?ixlib=rb-4.0.3&auto=format&fit=crop&w=600&q=80",
                description: "Lightweight tissue oil for targeted whitening treatment.",
                benefits: "",
                usage: "",
                ingredients: "",
                category: "oil",
                skinIssues: ["dark spots", "uneven skin tone", "hyperpigmentation"],
                benefitsList: ["targeted treatment", "brightening", "skin repair"],
                searchScore: 65,
                section: "all-products"
            },
            {
                id: 8,
                name: "Extra Glow Oil",
                price: 100.00,
                image: "https://images.unsplash.com/photo-1556228578-9c360e1d8d34?ixlib=rb-4.0.3&auto=format&fit=crop&w=600&q=80",
                description: "Radiant glow oil for luminous, healthy-looking skin.",
                benefits: "",
                usage: "",
                ingredients: "",
                category: "oil",
                skinIssues: ["dull skin", "dry skin", "lack of glow"],
                benefitsList: ["glowing skin", "radiance", "moisturizing"],
                searchScore: 60,
                section: "all-products"
            },
            {
                id: 13,
                name: "Extra Glow Combo",
                price: 250.00,
                image: "https://images.unsplash.com/photo-1596462502278-27bfdc403348?ixlib=rb-4.0.3&auto=format&fit=crop&w=600&q=80",
                description: "Complete extra glow set for radiant, hydrated skin.",
                benefits: "",
                usage: "Morning and night",
                ingredients: "Extra glow soap, extra glow oil, extra glow cream",
                category: "combo",
                skinIssues: ["dull skin", "dry skin", "lack of radiance", "dehydrated skin"],
                benefitsList: ["complete routine", "glowing skin", "hydration", "radiance"],
                searchScore: 88,
                section: "products"
            },
            {
                id: 14,
                name: "Whitening Combo",
                price: 420.00,
                image: "https://images.unsplash.com/photo-1556228578-9c360e1d8d34?ixlib=rb-4.0.3&auto=format&fit=crop&w=600&q=80",
                description: "Complete whitening set for radiant, even-toned skin.",
                benefits: "",
                usage: "Morning and night",
                ingredients: "Whitening oil, whitening soap, whitening cream",
                category: "combo",
                skinIssues: ["dark spots", "uneven skin tone", "hyperpigmentation", "dull complexion"],
                benefitsList: ["complete routine", "brightening", "even skin tone", "radiance"],
                searchScore: 92,
                section: "products"
            },
            {
                id: 15,
                name: "Extra Whitening Combo",
                price: 500.00,
                image: "https://images.unsplash.com/photo-1571781926291-c477ebfd024b?ixlib=rb-4.0.3&auto=format&fit=crop&w=600&q=80",
                description: "Premium whitening set with kojic soap for enhanced results.",
                benefits: "",
                usage: "Morning and night",
                ingredients: "Whitening oil, whitening cream, kojic soap",
                category: "combo",
                skinIssues: ["severe hyperpigmentation", "dark spots", "acne scars", "uneven skin tone"],
                benefitsList: ["premium routine", "intensive brightening", "skin repair", "radiance"],
                searchScore: 89,
                section: "products"
            },
            // AMAL FRAGRANCES PRODUCTS
            {
                id: 100,
                name: "Black Oud (30ml)",
                price: 180.00,
                image: "https://images.unsplash.com/photo-1541643600914-78b084683601?ixlib=rb-4.0.3&auto=format&fit=crop&w=600&q=80",
                description: "THE EXCLUSIVE OUD COLLECTION - A rich, deep oud fragrance with woody notes.",
                benefits: "Fragrance: Black Oud",
                usage: "Size: 30ml",
                ingredients: "Collection: Amal Fragrances",
                category: "perfume",
                skinIssues: ["fragrance", "oud", "perfume", "luxury"],
                benefitsList: ["long-lasting", "woody notes", "luxury fragrance"],
                searchScore: 85,
                section: "all-products"
            },
            {
                id: 101,
                name: "Black Oud (50ml)",
                price: 250.00,
                image: "https://images.unsplash.com/photo-1541643600914-78b084683601?ixlib=rb-4.0.3&auto=format&fit=crop&w=600&q=80",
                description: "THE EXCLUSIVE OUD COLLECTION - A rich, deep oud fragrance with woody notes.",
                benefits: "Fragrance: Black Oud",
                usage: "Size: 50ml",
                ingredients: "Collection: Amal Fragrances",
                category: "perfume",
                skinIssues: ["fragrance", "oud", "perfume", "luxury"],
                benefitsList: ["long-lasting", "woody notes", "luxury fragrance"],
                searchScore: 85,
                section: "all-products"
            },
            {
                id: 102,
                name: "Black Oud (100ml)",
                price: 450.00,
                image: "https://images.unsplash.com/photo-1541643600914-78b084683601?ixlib=rb-4.0.3&auto=format&fit=crop&w=600&q=80",
                description: "THE EXCLUSIVE OUD COLLECTION - A rich, deep oud fragrance with woody notes.",
                benefits: "Fragrance: Black Oud",
                usage: "Size: 100ml",
                ingredients: "Collection: Amal Fragrances",
                category: "perfume",
                skinIssues: ["fragrance", "oud", "perfume", "luxury"],
                benefitsList: ["long-lasting", "woody notes", "luxury fragrance"],
                searchScore: 85,
                section: "all-products"
            },
            {
                id: 103,
                name: "White Oud (30ml)",
                price: 180.00,
                image: "https://images.unsplash.com/photo-1541643600914-78b084683601?ixlib=rb-4.0.3&auto=format&fit=crop&w=600&q=80",
                description: "THE EXCLUSIVE OUD COLLECTION - A lighter, floral oud fragrance with subtle notes.",
                benefits: "Fragrance: White Oud",
                usage: "Size: 30ml",
                ingredients: "Collection: Amal Fragrances",
                category: "perfume",
                skinIssues: ["fragrance", "oud", "perfume", "floral"],
                benefitsList: ["long-lasting", "floral notes", "subtle fragrance"],
                searchScore: 85,
                section: "all-products"
            },
            {
                id: 104,
                name: "White Oud (50ml)",
                price: 250.00,
                image: "https://images.unsplash.com/photo-1541643600914-78b084683601?ixlib=rb-4.0.3&auto=format&fit=crop&w=600&q=80",
                description: "THE EXCLUSIVE OUD COLLECTION - A lighter, floral oud fragrance with subtle notes.",
                benefits: "Fragrance: White Oud",
                usage: "Size: 50ml",
                ingredients: "Collection: Amal Fragrances",
                category: "perfume",
                skinIssues: ["fragrance", "oud", "perfume", "floral"],
                benefitsList: ["long-lasting", "floral notes", "subtle fragrance"],
                searchScore: 85,
                section: "all-products"
            },
            {
                id: 105,
                name: "White Oud (100ml)",
                price: 450.00,
                image: "https://images.unsplash.com/photo-1541643600914-78b084683601?ixlib=rb-4.0.3&auto=format&fit=crop&w=600&q=80",
                description: "THE EXCLUSIVE OUD COLLECTION - A lighter, floral oud fragrance with subtle notes.",
                benefits: "Fragrance: White Oud",
                usage: "Size: 100ml",
                ingredients: "Collection: Amal Fragrances",
                category: "perfume",
                skinIssues: ["fragrance", "oud", "perfume", "floral"],
                benefitsList: ["long-lasting", "floral notes", "subtle fragrance"],
                searchScore: 85,
                section: "all-products"
            },
            {
                id: 106,
                name: "Black Oud (30ml)",
                price: 180.00,
                image: "https://images.unsplash.com/photo-1541643600914-78b084683601?ixlib=rb-4.0.3&auto=format&fit=crop&w=600&q=80",
                description: "THE EXCLUSIVE OUD COLLECTION - A rich, deep oud fragrance with woody notes.",
                benefits: "Fragrance: Black Oud",
                usage: "Size: 30ml",
                ingredients: "Collection: Amal Fragrances",
                category: "perfume",
                skinIssues: ["fragrance", "oud", "perfume", "luxury"],
                benefitsList: ["long-lasting", "woody notes", "luxury fragrance"],
                searchScore: 85,
                section: "all-products"
            },
            {
                id: 107,
                name: "Black Oud (50ml)",
                price: 250.00,
                image: "https://images.unsplash.com/photo-1541643600914-78b084683601?ixlib=rb-4.0.3&auto=format&fit=crop&w=600&q=80",
                description: "THE EXCLUSIVE OUD COLLECTION - A rich, deep oud fragrance with woody notes.",
                benefits: "Fragrance: Black Oud",
                usage: "Size: 50ml",
                ingredients: "Collection: Amal Fragrances",
                category: "perfume",
                skinIssues: ["fragrance", "oud", "perfume", "luxury"],
                benefitsList: ["long-lasting", "woody notes", "luxury fragrance"],
                searchScore: 85,
                section: "all-products"
            },
            {
                id: 108,
                name: "Black Oud (100ml)",
                price: 450.00,
                image: "https://images.unsplash.com/photo-1541643600914-78b084683601?ixlib=rb-4.0.3&auto=format&fit=crop&w=600&q=80",
                description: "THE EXCLUSIVE OUD COLLECTION - A rich, deep oud fragrance with woody notes.",
                benefits: "Fragrance: Black Oud",
                usage: "Size: 100ml",
                ingredients: "Collection: Amal Fragrances",
                category: "perfume",
                skinIssues: ["fragrance", "oud", "perfume", "luxury"],
                benefitsList: ["long-lasting", "woody notes", "luxury fragrance"],
                searchScore: 85,
                section: "all-products"
            },
            {
                id: 109,
                name: "OUD JOY (50ml)",
                price: 350.00,
                image: "https://images.unsplash.com/photo-1541643600914-78b084683601?ixlib=rb-4.0.3&auto=format&fit=crop&w=600&q=80",
                description: "THE EXCLUSIVE OUD SPRING COLLECTION - A fresh, uplifting oud fragrance for spring.",
                benefits: "Fragrance: OUD JOY",
                usage: "Size: 50ml",
                ingredients: "Collection: Amal Fragrances",
                category: "perfume",
                skinIssues: ["fragrance", "oud", "perfume", "spring"],
                benefitsList: ["fresh", "uplifting", "spring fragrance"],
                searchScore: 85,
                section: "all-products"
            },
            {
                id: 110,
                name: "OUD JOY (100ml)",
                price: 600.00,
                image: "https://images.unsplash.com/photo-1541643600914-78b084683601?ixlib=rb-4.0.3&auto=format&fit=crop&w=600&q=80",
                description: "THE EXCLUSIVE OUD SPRING COLLECTION - A fresh, uplifting oud fragrance for spring.",
                benefits: "Fragrance: OUD JOY",
                usage: "Size: 100ml",
                ingredients: "Collection: Amal Fragrances",
                category: "perfume",
                skinIssues: ["fragrance", "oud", "perfume", "spring"],
                benefitsList: ["fresh", "uplifting", "spring fragrance"],
                searchScore: 85,
                section: "all-products"
            },
            {
                id: 111,
                name: "Premium Oud (50ml)",
                price: 900.00,
                image: "https://images.unsplash.com/photo-1541643600914-78b084683601?ixlib=rb-4.0.3&auto=format&fit=crop&w=600&q=80",
                description: "THE PREMIUM OUD COLLECTION - Luxurious oud fragrance with premium ingredients.",
                benefits: "Collection: Premium Oud",
                usage: "Size: 50ml",
                ingredients: "Category: Amal Fragrances",
                category: "perfume",
                skinIssues: ["fragrance", "oud", "perfume", "premium", "luxury"],
                benefitsList: ["luxury", "premium ingredients", "exclusive"],
                searchScore: 90,
                section: "all-products"
            },
            {
                id: 112,
                name: "Premium Oud (100ml)",
                price: 1500.00,
                image: "https://images.unsplash.com/photo-1541643600914-78b084683601?ixlib=rb-4.0.3&auto=format&fit=crop&w=600&q=80",
                description: "THE PREMIUM OUD COLLECTION - Luxurious oud fragrance with premium ingredients.",
                benefits: "Collection: Premium Oud",
                usage: "Size: 100ml",
                ingredients: "Category: Amal Fragrances",
                category: "perfume",
                skinIssues: ["fragrance", "oud", "perfume", "premium", "luxury"],
                benefitsList: ["luxury", "premium ingredients", "exclusive"],
                searchScore: 90,
                section: "all-products"
            },
            {
                id: 113,
                name: "Home Diffuser Oud",
                price: 350.00,
                image: "https://images.unsplash.com/photo-1541643600914-78b084683601?ixlib=rb-4.0.3&auto=format&fit=crop&w=600&q=80",
                description: "THE HOME DIFFUSER OUD COLLECTION - Create a luxurious ambiance with oud fragrance.",
                benefits: "Type: Home Diffuser",
                usage: "Use: Home fragrance",
                ingredients: "Category: Amal Fragrances",
                category: "home fragrance",
                skinIssues: ["fragrance", "oud", "home", "diffuser"],
                benefitsList: ["home fragrance", "creates ambiance", "long-lasting"],
                searchScore: 80,
                section: "all-products"
            },
            {
                id: 114,
                name: "Car Diffuser Oud",
                price: 80.00,
                image: "https://images.unsplash.com/photo-1541643600914-78b084683601?ixlib=rb-4.0.3&auto=format&fit=crop&w=600&q=80",
                description: "THE CAR DIFFUSER OUD COLLECTION - Enjoy oud fragrance during your travels.",
                benefits: "Type: Car Diffuser",
                usage: "Use: Car fragrance",
                ingredients: "Category: Amal Fragrances",
                category: "car fragrance",
                skinIssues: ["fragrance", "oud", "car", "travel"],
                benefitsList: ["car fragrance", "travel-friendly", "refreshing"],
                searchScore: 75,
                section: "all-products"
            },
            {
                id: 115,
                name: "Body Lotion Oud",
                price: 200.00,
                image: "https://images.unsplash.com/photo-1541643600914-78b084683601?ixlib=rb-4.0.3&auto=format&fit=crop&w=600&q=80",
                description: "THE BODY LOTION OUD COLLECTION - Moisturizing body lotion with oud fragrance.",
                benefits: "Type: Body Lotion",
                usage: "Use: Daily moisturizer",
                ingredients: "Category: Amal Fragrances",
                category: "body care",
                skinIssues: ["fragrance", "oud", "body lotion", "moisturizer"],
                benefitsList: ["moisturizing", "fragrant", "skin care"],
                searchScore: 80,
                section: "all-products"
            },
            {
                id: 116,
                name: "Deodorant Oud",
                price: 100.00,
                image: "https://images.unsplash.com/photo-1541643600914-78b084683601?ixlib=rb-4.0.3&auto=format&fit=crop&w=600&q=80",
                description: "THE DEODORANT OUD COLLECTION - Long-lasting deodorant with oud fragrance.",
                benefits: "Type: Deodorant",
                usage: "Use: Daily protection",
                ingredients: "Category: Amal Fragrances",
                category: "personal care",
                skinIssues: ["fragrance", "oud", "deodorant", "personal care"],
                benefitsList: ["long-lasting", "protection", "fragrant"],
                searchScore: 75,
                section: "all-products"
            }
        ];

        // Enhanced product recommendation logic based on skin issues
        const recommendationLogic = {
            "acne": {
                description: "For acne-prone skin, we recommend gentle yet effective products that combat breakouts while soothing inflammation.",
                products: [3, 2, 5],
                primaryCombo: null,
                explanation: "These products work together to cleanse, treat, and prevent breakouts without harsh chemicals."
            },
            "dark-spots": {
                description: "For dark spots and hyperpigmentation, we recommend targeted brightening products that fade spots and even skin tone.",
                products: [1, 2, 3],
                primaryCombo: 14,
                explanation: "This combination delivers maximum brightening power to fade dark spots and reveal radiant skin."
            },
            "dry": {
                description: "For dry skin, we recommend intensive hydration and nourishment to restore moisture barrier and glow.",
                products: [4, 8],
                primaryCombo: 13,
                explanation: "These deeply hydrating products work together to quench thirsty skin and restore natural radiance."
            },
            "uneven-tone": {
                description: "For uneven skin tone, we recommend products that balance complexion and deliver consistent results.",
                products: [1, 2, 5],
                primaryCombo: 14,
                explanation: "This combination evens out skin tone and delivers a balanced, radiant complexion."
            },
            "glow": {
                description: "For glow maintenance, we recommend products that enhance natural radiance and protect skin health.",
                products: [4, 6, 8],
                primaryCombo: 13,
                explanation: "These glow-enhancing products work together to maintain your skin's natural luminosity."
            }
        };

        // Top searched products (anchor buys) - UPDATED TO INCLUDE AMAL FRAGRANCES
        const topSearchedProducts = [1, 14, 2, 13, 3, 4, 100, 109, 111, 113];

        // Common skin issues and benefits for suggestions - UPDATED WITH FRAGRANCE TERMS
        const searchSuggestions = {
            skinIssues: [
                "acne", "dark spots", "dry skin", "oily skin", "aging skin", 
                "hyperpigmentation", "uneven skin tone", "dull skin", "sensitive skin",
                "stretch marks", "sun damage", "wrinkles", "fine lines", "redness"
            ],
            benefits: [
                "brightening", "moisturizing", "anti-aging", "hydration", 
                "glowing skin", "radiance", "skin repair", "exfoliating",
                "cleansing", "firming", "soothing", "protective", "nourishing"
            ],
            productTypes: [
                "oil", "cream", "soap", "lotion", "combo", "serum", "toner",
                "perfume", "fragrance", "oud", "diffuser", "deodorant"
            ]
        };

        // User data for qualification
        const userData = {
            skinConcern: '',
            sensitivity: '',
            ageRange: ''
        };

        // Personalized recommendations for current user
        let personalizedRecommendations = [];

        // Current wizard step
        let currentStep = 1;
        const totalSteps = 3;

        // Gallery state
        let currentGallerySlide = 0;
        const gallerySlideCount = 5;

        // Cart state
        let cart = JSON.parse(localStorage.getItem('cart')) || [];

        // Checkout state
        let currentCheckoutStep = 1;
        let selectedPaymentMethod = 'credit';

        // Mobile menu state
        let isMobileMenuOpen = false;

        // Search state
        let currentSearchCategory = 'all';
        let searchTimeout = null;

        // NEW: Address Selection State with manual entry support
        let currentAddressStep = 'country';
        let selectedCountry = '';
        let selectedState = '';
        let selectedCity = '';
        let selectedVillage = '';
        let selectedZip = '';
        let isManualEntry = false;
        let manualState = '';
        let manualCity = '';
        let manualVillage = '';
        let manualZip = '';

        // NEW: Authentication state
        let isAuthenticated = false;
        let currentUser = null;
        let userHasDiscount = false;

        // Address data structure (mock data for demonstration) - MODIFIED: Only South Africa and United States
        const addressData = {
            countries: [
                { code: 'ZA', name: 'South Africa', flag: '', currency: 'ZAR' },
                { code: 'US', name: 'United States', flag: '', currency: 'USD' },
                { code: 'OTHER', name: 'Other Country', flag: '', currency: 'USD' }
            ],
            states: {
                'ZA': [
                    'Gauteng', 'Western Cape', 'KwaZulu-Natal', 'Eastern Cape', 
                    'Limpopo', 'Mpumalanga', 'North West', 'Free State', 'Northern Cape'
                ],
                'US': [
                    'California', 'Texas', 'Florida', 'New York', 'Pennsylvania',
                    'Illinois', 'Ohio', 'Georgia', 'North Carolina', 'Michigan'
                ],
                'OTHER': []
            },
            cities: {
                'Gauteng': ['Johannesburg', 'Pretoria', 'Sandton', 'Randburg', 'Centurion'],
                'Western Cape': ['Cape Town', 'Stellenbosch', 'Paarl', 'Worcester', 'George'],
                'California': ['Los Angeles', 'San Francisco', 'San Diego', 'Sacramento', 'San Jose'],
                'Texas': ['Houston', 'Dallas', 'Austin', 'San Antonio', 'Fort Worth'],
                'OTHER': []
            },
            villages: {
                'Johannesburg': ['Sandton CBD', 'Randburg CBD', 'Rosebank', 'Parktown', 'Melville'],
                'Cape Town': ['City Bowl', 'Atlantic Seaboard', 'Southern Suburbs', 'Northern Suburbs'],
                'Los Angeles': ['Hollywood', 'Downtown LA', 'Beverly Hills', 'Santa Monica', 'Venice'],
                'OTHER': []
            },
            zipCodes: {
                'Johannesburg': ['2000', '2001', '2196', '2193', '2194'],
                'Cape Town': ['8000', '8001', '7700', '7800', '7925'],
                'Los Angeles': ['90001', '90002', '90003', '90004', '90005'],
                'OTHER': []
            }
        };

        // NEW: User data structure for localStorage
        const initializeUsers = () => {
            if (!localStorage.getItem('users')) {
                localStorage.setItem('users', JSON.stringify([]));
            }
            if (!localStorage.getItem('currentUser')) {
                localStorage.setItem('currentUser', JSON.stringify(null));
            }
        };

        // Initialize cart badge
        updateCartBadge();

        // Initialize address selection
        initializeAddressSelection();

        // Initialize payment methods
        initializePaymentMethods();

        // NEW: Initialize authentication system
        initializeUsers();
        initializeAuthentication();

        // Floating cart functionality
        floatingCartBtn.addEventListener('click', () => {
            cartModal.classList.add('active');
            updateCartDisplay();
        });

        // Floating cart hover effects
        floatingCartBtn.addEventListener('mouseenter', () => {
            const label = document.querySelector('.floating-cart-label');
            label.style.opacity = '1';
            label.style.transform = 'translateY(0)';
        });

        floatingCartBtn.addEventListener('mouseleave', () => {
            const label = document.querySelector('.floating-cart-label');
            label.style.opacity = '0';
            label.style.transform = 'translateY(-10px)';
        });

        // Mobile menu functionality
        mobileMenuBtn.addEventListener('click', () => {
            if (isMobileMenuOpen) {
                closeMobileMenu();
            } else {
                openMobileMenu();
            }
        });

        mobileMenuClose.addEventListener('click', () => {
            closeMobileMenu();
        });

        mobileMenuOverlay.addEventListener('click', () => {
            closeMobileMenu();
        });

        mobileNavLinksItems.forEach(link => {
            link.addEventListener('click', () => {
                closeMobileMenu();
            });
        });

        function openMobileMenu() {
            mobileMenuOverlay.classList.add('active');
            mobileNavLinks.classList.add('active');
            isMobileMenuOpen = true;
            document.body.style.overflow = 'hidden';
            mobileMenuBtnIcon.classList.remove('fa-bars');
            mobileMenuBtnIcon.classList.add('fa-times');
            mobileMenuBtn.classList.add('active');
        }

        function closeMobileMenu() {
            mobileMenuOverlay.classList.remove('active');
            mobileNavLinks.classList.remove('active');
            isMobileMenuOpen = false;
            document.body.style.overflow = '';
            mobileMenuBtnIcon.classList.remove('fa-times');
            mobileMenuBtnIcon.classList.add('fa-bars');
            mobileMenuBtn.classList.remove('active');
        }

        // Close buttons functionality
        closeAuthBtn.addEventListener('click', () => {
            document.getElementById('authModal').classList.remove('active');
        });

        closeWizardBtn.addEventListener('click', () => {
            wizardSteps.forEach(step => step.classList.remove('active'));
            wizardSteps[0].classList.add('active');
            currentStep = 1;
            updateProgressBar();

            optionItems.forEach(item => item.classList.remove('selected'));
            userData.skinConcern = '';
            userData.sensitivity = '';
            userData.ageRange = '';
        });

        closeCartBtn.addEventListener('click', () => {
            cartModal.classList.remove('active');
        });

        closeCheckoutBtn.addEventListener('click', () => {
            checkoutModal.classList.remove('active');
            resetAddressSelection();
        });

        closeSuccessBtn.addEventListener('click', () => {
            successModal.classList.remove('active');
        });

        closeResultsBtn.addEventListener('click', () => {
            resultsModal.classList.remove('active');
        });

        closeResultsBtn2.addEventListener('click', () => {
            resultsModal.classList.remove('active');
        });

        // NEW: Close auth choice modal
        closeAuthChoiceBtn.addEventListener('click', () => {
            authChoiceModal.classList.remove('active');
        });

        // NEW: Close enhanced auth modal
        closeEnhancedAuthBtn.addEventListener('click', () => {
            enhancedAuthModal.classList.remove('active');
        });

        // Add all recommended products to cart
        addAllToCartBtn.addEventListener('click', () => {
            if (personalizedRecommendations.length === 0) {
                alert('No recommendations to add to cart');
                return;
            }

            personalizedRecommendations.forEach(productId => {
                const product = products.find(p => p.id === productId);
                if (product) {
                    addToCart({
                        id: product.id,
                        name: product.name,
                        price: product.price,
                        image: product.image
                    });
                }
            });

            const logic = recommendationLogic[userData.skinConcern];
            if (logic && logic.primaryCombo) {
                const comboProduct = products.find(p => p.id === logic.primaryCombo);
                if (comboProduct) {
                    addToCart({
                        id: comboProduct.id,
                        name: comboProduct.name,
                        price: comboProduct.price,
                        image: comboProduct.image
                    });
                }
            }

            addAllToCartBtn.innerHTML = '<i class="fas fa-check"></i> All Added!';
            addAllToCartBtn.style.background = 'rgba(40, 167, 69, 0.3)';

            setTimeout(() => {
                addAllToCartBtn.innerHTML = '<i class="fas fa-shopping-cart"></i> Add All to Cart';
                addAllToCartBtn.style.background = '';
            }, 2000);

            setTimeout(() => {
                resultsModal.classList.remove('active');
                cartModal.classList.add('active');
            }, 500);
        });

        // Enhanced Search functionality
        searchIcon.addEventListener('click', () => {
            if (window.innerWidth <= 768) {
                searchOverlay.classList.add('active');
                searchOverlayInput.focus();
                document.body.style.overflow = 'hidden';

                if (!searchOverlayInput.value.trim()) {
                    displayTopSearchedProductsInOverlay();
                }
            } else {
                searchInput.classList.add('active');
                searchClose.classList.add('active');
                searchInput.focus();

                if (!searchInput.value.trim()) {
                    displayTopSearchedProducts();
                }
            }
        });

        searchClose.addEventListener('click', () => {
            searchInput.classList.remove('active');
            searchClose.classList.remove('active');
            searchInput.value = '';
            searchResults.classList.remove('active');
        });

        searchInput.addEventListener('focus', () => {
            if (!searchInput.value.trim()) {
                displayTopSearchedProducts();
            }
        });

        searchInput.addEventListener('input', (e) => {
            clearTimeout(searchTimeout);

            searchTimeout = setTimeout(() => {
                const searchTerm = e.target.value.toLowerCase().trim();

                if (searchTerm.length === 0) {
                    displayTopSearchedProducts();
                    return;
                }

                performSearch(searchTerm, searchResults);
            }, 300);
        });

        // Search overlay functionality
        searchBackBtn.addEventListener('click', () => {
            searchOverlay.classList.remove('active');
            searchOverlayInput.value = '';
            document.body.style.overflow = '';
        });

        searchOverlayInput.addEventListener('input', (e) => {
            clearTimeout(searchTimeout);

            searchTimeout = setTimeout(() => {
                const searchTerm = e.target.value.toLowerCase().trim();

                if (searchTerm.length === 0) {
                    displayTopSearchedProductsInOverlay();
                    return;
                }

                performSearch(searchTerm, searchOverlayResults);
            }, 300);
        });

        // Function to display top searched products in overlay
        function displayTopSearchedProductsInOverlay() {
            let resultsHTML = `
                <div class="top-searched-section">
                    <h5><i class="fas fa-fire"></i> Top Searched Products</h5>
                    <div class="top-searched-products">
            `;

            topSearchedProducts.forEach(productId => {
                const product = products.find(p => p.id === productId);
                if (product) {
                    resultsHTML += `
                        <div class="top-searched-item" data-id="${product.id}">
                            <img src="${product.image}" alt="${product.name}">
                            <div class="top-searched-info">
                                <h6>${product.name}</h6>
                                <div class="top-searched-price">R${product.price.toFixed(2)}</div>
                            </div>
                        </div>
                    `;
                }
            });

            resultsHTML += `
                    </div>
                </div>
                
                <div class="search-suggestions">
                    <h5><i class="fas fa-lightbulb"></i> Search by Skin Concern</h5>
                    <div class="suggestions-grid">
            `;

            searchSuggestions.skinIssues.slice(0, 8).forEach(issue => {
                resultsHTML += `<span class="suggestion-tag" data-suggestion="${issue}">${issue}</span>`;
            });

            resultsHTML += `
                    </div>
                </div>
                
                <div class="search-suggestions">
                    <h5><i class="fas fa-star"></i> Search by Benefits</h5>
                    <div class="suggestions-grid">
            `;

            searchSuggestions.benefits.slice(0, 6).forEach(benefit => {
                resultsHTML += `<span class="suggestion-tag" data-suggestion="${benefit}">${benefit}</span>`;
            });

            resultsHTML += `
                        </div>
                    </div>
                `;

            searchOverlayResults.innerHTML = resultsHTML;

            document.querySelectorAll('.top-searched-item').forEach(item => {
                item.addEventListener('click', function() {
                    const productId = parseInt(this.getAttribute('data-id'));
                    const product = products.find(p => p.id === productId);

                    if (product) {
                        navigateToProduct(product);
                        searchOverlay.classList.remove('active');
                        document.body.style.overflow = '';
                    }
                });
            });

            document.querySelectorAll('.suggestion-tag').forEach(tag => {
                tag.addEventListener('click', function() {
                    const suggestion = this.getAttribute('data-suggestion');
                    searchOverlayInput.value = suggestion;
                    performSearch(suggestion, searchOverlayResults);
                });
            });
        }

        // Function to display top searched products in desktop
        function displayTopSearchedProducts() {
            let resultsHTML = `
                <div class="top-searched-section">
                    <h5><i class="fas fa-fire"></i> Top Searched Products</h5>
                    <div class="top-searched-products">
            `;

            topSearchedProducts.forEach(productId => {
                const product = products.find(p => p.id === productId);
                if (product) {
                    resultsHTML += `
                        <div class="top-searched-item" data-id="${product.id}">
                            <img src="${product.image}" alt="${product.name}">
                            <div class="top-searched-info">
                                <h6>${product.name}</h6>
                                <div class="top-searched-price">R${product.price.toFixed(2)}</div>
                            </div>
                        </div>
                    `;
                }
            });

            resultsHTML += `
                    </div>
                </div>
                
                <div class="search-suggestions">
                    <h5><i class="fas fa-lightbulb"></i> Search by Skin Concern</h5>
                    <div class="suggestions-grid">
            `;

            searchSuggestions.skinIssues.slice(0, 8).forEach(issue => {
                resultsHTML += `<span class="suggestion-tag" data-suggestion="${issue}">${issue}</span>`;
            });

            resultsHTML += `
                    </div>
                </div>
                
                <div class="search-suggestions">
                    <h5><i class="fas fa-star"></i> Search by Benefits</h5>
                    <div class="suggestions-grid">
            `;

            searchSuggestions.benefits.slice(0, 6).forEach(benefit => {
                resultsHTML += `<span class="suggestion-tag" data-suggestion="${benefit}">${benefit}</span>`;
            });

            resultsHTML += `
                    </div>
                </div>
            `;

            searchResults.innerHTML = resultsHTML;
            searchResults.classList.add('active');

            document.querySelectorAll('.top-searched-item').forEach(item => {
                item.addEventListener('click', function() {
                    const productId = parseInt(this.getAttribute('data-id'));
                    const product = products.find(p => p.id === productId);

                    if (product) {
                        navigateToProduct(product);
                    }
                });
            });

            document.querySelectorAll('.suggestion-tag').forEach(tag => {
                tag.addEventListener('click', function() {
                    const suggestion = this.getAttribute('data-suggestion');
                    searchInput.value = suggestion;
                    performSearch(suggestion, searchResults);
                });
            });
        }

        // Function to perform search with predictive suggestions
        function performSearch(searchTerm, resultsContainer) {
            const filteredProducts = [];
            const suggestions = new Set();

            products.forEach(product => {
                let score = 0;
                let matchedFields = [];

                if (product.name.toLowerCase().includes(searchTerm)) {
                    score += 30;
                    matchedFields.push('name');
                }

                if (product.description.toLowerCase().includes(searchTerm)) {
                    score += 20;
                    matchedFields.push('description');
                }

                if (product.benefits.toLowerCase().includes(searchTerm)) {
                    score += 15;
                    matchedFields.push('benefits');
                }

                product.skinIssues.forEach(issue => {
                    if (issue.toLowerCase().includes(searchTerm)) {
                        score += 10;
                        matchedFields.push('skin issue: ' + issue);

                        searchSuggestions.skinIssues.forEach(si => {
                            if (si.includes(searchTerm) && si !== issue) {
                                suggestions.add(si);
                            }
                        });
                    }
                });

                product.benefitsList.forEach(benefit => {
                    if (benefit.toLowerCase().includes(searchTerm)) {
                        score += 10;
                        matchedFields.push('benefit: ' + benefit);

                        searchSuggestions.benefits.forEach(b => {
                            if (b.includes(searchTerm) && b !== benefit) {
                                suggestions.add(b);
                            }
                        });
                    }
                });

                if (product.category.toLowerCase().includes(searchTerm)) {
                    score += 5;
                    matchedFields.push('category');
                }

                if (score > 0) {
                    filteredProducts.push({
                        product: product,
                        score: score + product.searchScore,
                        matchedFields: matchedFields
                    });
                }
            });

            filteredProducts.sort((a, b) => b.score - a.score);

            const suggestionArray = Array.from(suggestions).slice(0, 5);

            displaySearchResults(filteredProducts, suggestionArray, searchTerm, resultsContainer);
        }

        // Function to display search results with suggestions
        function displaySearchResults(filteredProducts, suggestions, searchTerm, resultsContainer) {
            if (filteredProducts.length === 0 && suggestions.length === 0) {
                resultsContainer.innerHTML = `
                    <div class="no-results">
                        <i class="fas fa-search" style="font-size: 40px; margin-bottom: 15px; opacity: 0.5;"></i>
                        <p>No products found for "${searchTerm}"</p>
                        <p style="margin-top: 10px; font-size: 14px;">Try searching for: acne, dark spots, brightening, moisturizing, oud, perfume</p>
                    </div>
                `;

                if (resultsContainer === searchResults) {
                    searchResults.classList.add('active');
                }
                return;
            }

            let resultsHTML = '';

            if (suggestions.length > 0) {
                resultsHTML += `
                    <div class="search-suggestions">
                        <h5><i class="fas fa-lightbulb"></i> Try Searching For</h5>
                        <div class="suggestions-grid">
                `;

                suggestions.forEach(suggestion => {
                    resultsHTML += `<span class="suggestion-tag" data-suggestion="${suggestion}">${suggestion}</span>`;
                });

                resultsHTML += `
                        </div>
                    </div>
                `;
            }

            if (filteredProducts.length > 0) {
                resultsHTML += `
                    <div class="search-results-list">
                        <h5><i class="fas fa-check-circle"></i> ${filteredProducts.length} Products Found</h5>
                `;

                filteredProducts.forEach((item, index) => {
                    const product = item.product;
                    const matchedFields = item.matchedFields.slice(0, 2).join(', ');

                    resultsHTML += `
                        <div class="search-result-item" data-id="${product.id}">
                            <img src="${product.image}" alt="${product.name}">
                            <div class="search-result-info">
                                <h4>${product.name}</h4>
                                <p>${product.description.substring(0, 60)}...</p>
                                <div class="search-result-tags">
                                    <span class="search-result-tag">${product.category}</span>
                                    ${item.score > 100 ? '<span class="search-result-tag" style="background: rgba(255,193,7,0.2);">Popular</span>' : ''}
                                    ${product.category === 'perfume' ? '<span class="search-result-tag" style="background: rgba(196,167,125,0.2);">Amal Fragrances</span>' : ''}
                                </div>
                                <div class="search-result-price">R${product.price.toFixed(2)}</div>
                            </div>
                        </div>
                    `;
                });

                resultsHTML += `</div>`;
            }

            resultsContainer.innerHTML = resultsHTML;

            if (resultsContainer === searchResults) {
                searchResults.classList.add('active');
            }

            resultsContainer.querySelectorAll('.search-result-item').forEach(item => {
                item.addEventListener('click', function() {
                    const productId = parseInt(this.getAttribute('data-id'));
                    const product = products.find(p => p.id === productId);

                    if (product) {
                        navigateToProduct(product);

                        if (searchOverlay.classList.contains('active')) {
                            searchOverlay.classList.remove('active');
                            document.body.style.overflow = '';
                        }
                    }
                });
            });

            resultsContainer.querySelectorAll('.suggestion-tag').forEach(tag => {
                tag.addEventListener('click', function() {
                    const suggestion = this.getAttribute('data-suggestion');

                    if (resultsContainer === searchOverlayResults) {
                        searchOverlayInput.value = suggestion;
                        performSearch(suggestion, searchOverlayResults);
                    } else {
                        searchInput.value = suggestion;
                        performSearch(suggestion, searchResults);
                    }
                });
            });
        }

        // Function to navigate to product and highlight it
        function navigateToProduct(product) {
            searchInput.classList.remove('active');
            searchClose.classList.remove('active');
            searchInput.value = '';
            searchResults.classList.remove('active');

            let targetSectionId;
            if (product.section === "products") {
                targetSectionId = "products";
            } else if (product.section === "flagship") {
                targetSectionId = "flagship";
            } else {
                targetSectionId = "all-products";
            }

            document.getElementById(targetSectionId).scrollIntoView({ 
                behavior: 'smooth',
                block: 'start'
            });

            setTimeout(() => {
                const productElement = document.querySelector(`.add-to-cart[data-id="${product.id}"]`);
                if (productElement) {
                    const productCard = productElement.closest('.product-card');

                    productCard.scrollIntoView({ 
                        behavior: 'smooth',
                        block: 'center'
                    });

                    productCard.style.animation = 'none';
                    void productCard.offsetWidth;
                    productCard.style.animation = 'pulse 2s';

                    productCard.style.boxShadow = '0 0 0 3px var(--accent-color)';
                    productCard.style.transform = 'scale(1.02)';

                    setTimeout(() => {
                        productCard.style.boxShadow = '';
                        productCard.style.transform = '';
                    }, 3000);
                }
            }, 800);
        }

        // Close search when clicking outside (desktop only)
        document.addEventListener('click', (e) => {
            if (window.innerWidth > 768) {
                if (!searchInput.contains(e.target) && !searchIcon.contains(e.target) && !searchResults.contains(e.target)) {
                    searchInput.classList.remove('active');
                    searchClose.classList.remove('active');
                    searchResults.classList.remove('active');
                }
            }
        });

        // Scroll event for navbar and fade animations
        window.addEventListener('scroll', () => {
            if (window.scrollY > 50) {
                navbar.classList.add('scrolled');
            } else {
                navbar.classList.remove('scrolled');
            }

            fadeElements.forEach(element => {
                const elementTop = element.getBoundingClientRect().top;
                const windowHeight = window.innerHeight;

                if (elementTop < windowHeight - 100) {
                    element.classList.add('visible');
                }
            });

            const video = document.getElementById('background-video');
            const scrolled = window.pageYOffset;
            const rate = scrolled * -0.5;
            video.style.transform = `translate3d(0px, ${rate}px, 0px)`;
        });

        // Initialize fade elements on page load
        document.addEventListener('DOMContentLoaded', () => {
            fadeElements.forEach(element => {
                const elementTop = element.getBoundingClientRect().top;
                const windowHeight = window.innerHeight;

                if (elementTop < windowHeight - 100) {
                    element.classList.add('visible');
                }
            });

            updateProgressBar();

            if ('ontouchstart' in window) {
                document.body.classList.add('touch-device');

                document.querySelectorAll('.glass-button, .option-item, .product-card').forEach(element => {
                    element.style.cursor = 'pointer';
                });
            }

            const style = document.createElement('style');
            style.textContent = `
                @keyframes pulse {
                    0% { box-shadow: 0 0 0 0 rgba(196, 167, 125, 0.4); }
                    70% { box-shadow: 0 0 0 15px rgba(196, 167, 125, 0); }
                    100% { box-shadow: 0 0 0 0 rgba(196, 167, 125, 0); }
                }
            `;
            document.head.appendChild(style);

            initializeFlagshipProduct();

            // Only initialize add to cart buttons once - FIXED: Remove duplicate initialization
            initializeAddToCartButtons();
        });

        // Initialize all add to cart buttons - FIXED: This should be the only place where add-to-cart buttons get event listeners
        function initializeAddToCartButtons() {
            // Use event delegation for better performance and to handle dynamically added buttons
            document.addEventListener('click', function(event) {
                // Check if the clicked element or its parent has the add-to-cart class
                const addToCartButton = event.target.closest('.add-to-cart');

                if (addToCartButton) {
                    event.preventDefault();

                    const productId = parseInt(addToCartButton.getAttribute('data-id'));
                    const productName = addToCartButton.getAttribute('data-name');
                    const productPrice = parseFloat(addToCartButton.getAttribute('data-price'));
                    const productImage = addToCartButton.getAttribute('data-image');

                    addToCart({
                        id: productId,
                        name: productName,
                        price: productPrice,
                        image: productImage
                    });

                    const originalText = addToCartButton.innerHTML;
                    addToCartButton.innerHTML = '<i class="fas fa-check"></i> Added!';
                    addToCartButton.style.background = 'rgba(40, 167, 69, 0.3)';

                    setTimeout(() => {
                        addToCartButton.innerHTML = originalText;
                        addToCartButton.style.background = '';
                    }, 2000);
                }
            });
        }

        // Flagship product "See More" functionality
        function initializeFlagshipProduct() {
            const seeMoreBtn = document.querySelector('.see-more-btn');
            const flagshipDetails = document.querySelector('.flagship-details');

            if (seeMoreBtn && flagshipDetails) {
                const isMobile = window.innerWidth <= 850;
                if (isMobile) {
                    flagshipDetails.classList.add('collapsed');
                    flagshipDetails.classList.remove('expanded');
                    seeMoreBtn.innerHTML = '<i class="fas fa-chevron-down"></i> See More';
                } else {
                    flagshipDetails.classList.add('expanded');
                    flagshipDetails.classList.remove('collapsed');
                    seeMoreBtn.innerHTML = '<i class="fas fa-chevron-up"></i> See Less';
                }

                seeMoreBtn.addEventListener('click', () => {
                    const isCollapsed = flagshipDetails.classList.contains('collapsed');

                    if (isCollapsed) {
                        flagshipDetails.classList.remove('collapsed');
                        flagshipDetails.classList.add('expanded');
                        seeMoreBtn.innerHTML = '<i class="fas fa-chevron-up"></i> See Less';
                    } else {
                        flagshipDetails.classList.remove('expanded');
                        flagshipDetails.classList.add('collapsed');
                        seeMoreBtn.innerHTML = '<i class="fas fa-chevron-down"></i> See More';
                    }
                });

                window.addEventListener('resize', () => {
                    const isMobile = window.innerWidth <= 850;

                    if (isMobile && flagshipDetails.classList.contains('expanded')) {
                        flagshipDetails.classList.remove('expanded');
                        flagshipDetails.classList.add('collapsed');
                        seeMoreBtn.innerHTML = '<i class="fas fa-chevron-down"></i> See More';
                    }
                });
            }
        }

        // Cart functionality
        function updateCartBadge() {
            const totalItems = cart.reduce((total, item) => total + item.quantity, 0);

            if (totalItems > 0) {
                floatingCartBadge.textContent = totalItems;
                floatingCartBadge.style.display = 'flex';
            } else {
                floatingCartBadge.style.display = 'none';
            }
        }

        // Add item to cart
        function addToCart(product) {
            const existingItem = cart.find(item => item.id === product.id);

            if (existingItem) {
                existingItem.quantity += 1;
            } else {
                cart.push({
                    ...product,
                    quantity: 1
                });
            }

            localStorage.setItem('cart', JSON.stringify(cart));

            updateCartBadge();

            if (cartModal.classList.contains('active')) {
                updateCartDisplay();
            }
        }

        // Update cart display - CLEANER DESIGN
        function updateCartDisplay() {
            if (cart.length === 0) {
                cartItems.innerHTML = `
                    <div class="cart-empty">
                        <i class="fas fa-shopping-bag"></i>
                        <h4>Your bag is empty</h4>
                        <p>Add some products to get started!</p>
                        <button class="glass-button" onclick="document.querySelector('#all-products').scrollIntoView({behavior: 'smooth'})">
                            <i class="fas fa-store"></i> Browse Products
                        </button>
                    </div>
                `;
                cartSummary.style.display = 'none';
                return;
            }

            let itemsHTML = '';
            let subtotal = 0;

            cart.forEach((item, index) => {
                const itemTotal = item.price * item.quantity;
                subtotal += itemTotal;

                itemsHTML += `
                    <div class="cart-item glass-card">
                        <div class="cart-item-image" style="background-image: url('${item.image}');"></div>
                        <div class="cart-item-info">
                            <h4>${item.name}</h4>
                            <div class="cart-item-price">R${item.price.toFixed(2)} each</div>
                            <div style="color: rgba(255, 255, 255, 0.7); font-size: 0.9rem;">
                                Total: R${itemTotal.toFixed(2)}
                            </div>
                        </div>
                        <div class="cart-item-actions">
                            <div class="quantity-control">
                                <button class="quantity-btn decrease-quantity" data-index="${index}">
                                    <i class="fas fa-minus"></i>
                                </button>
                                <span class="quantity">${item.quantity}</span>
                                <button class="quantity-btn increase-quantity" data-index="${index}">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                            <button class="remove-item" data-index="${index}">
                                <i class="fas fa-trash"></i> Remove
                            </button>
                        </div>
                    </div>
                `;
            });

            cartItems.innerHTML = itemsHTML;

            const shipping = 50.00;
            const total = subtotal + shipping;

            document.getElementById('cartSubtotal').textContent = `R${subtotal.toFixed(2)}`;
            document.getElementById('cartShipping').textContent = `R${shipping.toFixed(2)}`;
            document.getElementById('cartTax').textContent = `R0.00`;
            document.getElementById('cartTotal').textContent = `R${total.toFixed(2)}`;

            cartSummary.style.display = 'block';

            document.querySelectorAll('.decrease-quantity').forEach(btn => {
                btn.addEventListener('click', function() {
                    const index = parseInt(this.getAttribute('data-index'));
                    updateQuantity(index, -1);
                });
            });

            document.querySelectorAll('.increase-quantity').forEach(btn => {
                btn.addEventListener('click', function() {
                    const index = parseInt(this.getAttribute('data-index'));
                    updateQuantity(index, 1);
                });
            });

            document.querySelectorAll('.remove-item').forEach(btn => {
                btn.addEventListener('click', function() {
                    const index = parseInt(this.getAttribute('data-index'));
                    removeFromCart(index);
                });
            });
        }

        // Update item quantity
        function updateQuantity(index, change) {
            if (cart[index]) {
                cart[index].quantity += change;

                if (cart[index].quantity <= 0) {
                    cart.splice(index, 1);
                }

                localStorage.setItem('cart', JSON.stringify(cart));
                updateCartBadge();
                updateCartDisplay();
            }
        }

        // Remove item from cart
        function removeFromCart(index) {
            if (cart[index]) {
                cart.splice(index, 1);

                localStorage.setItem('cart', JSON.stringify(cart));
                updateCartBadge();
                updateCartDisplay();
            }
        }

        // Checkout functionality - MODIFIED FOR NEW AUTHENTICATION FLOW
        checkoutBtn.addEventListener('click', () => {
            if (cart.length === 0) {
                alert('Your cart is empty!');
                return;
            }

            cartModal.classList.remove('active');

            // NEW: Show auth choice modal instead of directly going to checkout
            authChoiceModal.classList.add('active');
        });

        checkoutModal.addEventListener('click', (e) => {
            if (e.target === checkoutModal) {
                checkoutModal.classList.remove('active');
                resetAddressSelection();
            }
        });

        // NEW: Auth Choice Modal Functionality
        guestOption.addEventListener('click', () => {
            authChoiceModal.classList.remove('active');
            checkoutModal.classList.add('active');
            updateCheckoutStep(1);
            initializeAddressSelection();
        });

        signupOption.addEventListener('click', () => {
            authChoiceModal.classList.remove('active');
            enhancedAuthModal.classList.add('active');
            showAuthTab('signup');
        });

        loginOption.addEventListener('click', () => {
            authChoiceModal.classList.remove('active');
            enhancedAuthModal.classList.add('active');
            showAuthTab('login');
        });

        // NEW: Enhanced Auth Modal Functionality
        function initializeAuthentication() {
            // Enhanced auth tabs
            enhancedAuthTabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabName = this.getAttribute('data-tab');
                    showAuthTab(tabName);
                });
            });

            // Switch between login and signup
            switchToSignupEnhanced.addEventListener('click', (e) => {
                e.preventDefault();
                showAuthTab('signup');
            });

            switchToLoginEnhanced.addEventListener('click', (e) => {
                e.preventDefault();
                showAuthTab('login');
            });

            // Social login buttons
            googleLogin.addEventListener('click', () => socialLogin('google'));
            facebookLogin.addEventListener('click', () => socialLogin('facebook'));
            appleLogin.addEventListener('click', () => socialLogin('apple'));
            googleSignup.addEventListener('click', () => socialLogin('google'));
            facebookSignup.addEventListener('click', () => socialLogin('facebook'));
            appleSignup.addEventListener('click', () => socialLogin('apple'));

            // Password strength checker
            if (passwordInput) {
                passwordInput.addEventListener('input', checkPasswordStrength);
            }

            // Enhanced login form submission
            enhancedLoginForm.addEventListener('submit', (e) => {
                e.preventDefault();
                handleLogin();
            });

            // Enhanced signup form submission
            enhancedSignupForm.addEventListener('submit', (e) => {
                e.preventDefault();
                handleSignup();
            });

            // Forgot password
            document.getElementById('forgotPassword').addEventListener('click', (e) => {
                e.preventDefault();
                handleForgotPassword();
            });
        }

        function showAuthTab(tabName) {
            // Update tabs
            enhancedAuthTabs.forEach(tab => {
                tab.classList.remove('active');
                if (tab.getAttribute('data-tab') === tabName) {
                    tab.classList.add('active');
                }
            });

            // Update forms
            enhancedAuthForms.forEach(form => {
                form.classList.remove('active');
                if (form.id === `enhanced${tabName.charAt(0).toUpperCase() + tabName.slice(1)}Form`) {
                    form.classList.add('active');
                }
            });

            // Show/hide discount
            if (tabName === 'signup') {
                signupDiscount.style.display = 'block';
            } else {
                signupDiscount.style.display = 'none';
            }

            // Reset forms
            resetAuthForms();
        }

        function checkPasswordStrength() {
            const password = passwordInput.value;
            let strength = 0;

            // Check length
            if (password.length >= 8) {
                strength++;
                reqLength.classList.remove('invalid');
                reqLength.classList.add('valid');
                reqLength.innerHTML = '<i class="fas fa-check-circle"></i> At least 8 characters';
            } else {
                reqLength.classList.remove('valid');
                reqLength.classList.add('invalid');
                reqLength.innerHTML = '<i class="fas fa-circle" style="font-size: 6px;"></i> At least 8 characters';
            }

            // Check uppercase
            if (/[A-Z]/.test(password)) {
                strength++;
                reqUppercase.classList.remove('invalid');
                reqUppercase.classList.add('valid');
                reqUppercase.innerHTML = '<i class="fas fa-check-circle"></i> One uppercase letter';
            } else {
                reqUppercase.classList.remove('valid');
                reqUppercase.classList.add('invalid');
                reqUppercase.innerHTML = '<i class="fas fa-circle" style="font-size: 6px;"></i> One uppercase letter';
            }

            // Check lowercase
            if (/[a-z]/.test(password)) {
                strength++;
                reqLowercase.classList.remove('invalid');
                reqLowercase.classList.add('valid');
                reqLowercase.innerHTML = '<i class="fas fa-check-circle"></i> One lowercase letter';
            } else {
                reqLowercase.classList.remove('valid');
                reqLowercase.classList.add('invalid');
                reqLowercase.innerHTML = '<i class="fas fa-circle" style="font-size: 6px;"></i> One lowercase letter';
            }

            // Check number
            if (/[0-9]/.test(password)) {
                strength++;
                reqNumber.classList.remove('invalid');
                reqNumber.classList.add('valid');
                reqNumber.innerHTML = '<i class="fas fa-check-circle"></i> One number';
            } else {
                reqNumber.classList.remove('valid');
                reqNumber.classList.add('invalid');
                reqNumber.innerHTML = '<i class="fas fa-circle" style="font-size: 6px;"></i> One number';
            }

            // Update strength indicator
            if (strength === 0) {
                passwordStrength.textContent = '';
                passwordStrength.className = 'password-strength';
            } else if (strength <= 2) {
                passwordStrength.textContent = 'Weak password';
                passwordStrength.className = 'password-strength weak';
            } else if (strength === 3) {
                passwordStrength.textContent = 'Medium password';
                passwordStrength.className = 'password-strength medium';
            } else {
                passwordStrength.textContent = 'Strong password';
                passwordStrength.className = 'password-strength strong';
            }
        }

        function socialLogin(provider) {
            showAuthLoading();

            // Simulate social login API call
            setTimeout(() => {
                // For demo purposes, create a mock user
                const mockUser = {
                    id: Date.now(),
                    firstName: 'Social',
                    lastName: 'User',
                    email: `social.${provider}@example.com`,
                    provider: provider,
                    hasDiscount: provider === 'google' || provider === 'facebook' || provider === 'apple',
                    createdAt: new Date().toISOString()
                };

                // Save user to localStorage
                const users = JSON.parse(localStorage.getItem('users')) || [];
                const existingUser = users.find(u => u.email === mockUser.email);

                if (!existingUser) {
                    users.push(mockUser);
                    localStorage.setItem('users', JSON.stringify(users));
                }

                // Set as current user
                localStorage.setItem('currentUser', JSON.stringify(mockUser));
                currentUser = mockUser;
                isAuthenticated = true;
                userHasDiscount = mockUser.hasDiscount;

                // Show success and proceed to checkout
                showAuthSuccess();

                setTimeout(() => {
                    enhancedAuthModal.classList.remove('active');
                    checkoutModal.classList.add('active');
                    updateCheckoutStep(1);
                    initializeAddressSelection();

                    // If user has discount from social signup, apply it
                    if (userHasDiscount) {
                        applyDiscountToCart();
                    }
                }, 1500);
            }, 1000);
        }

        function handleLogin() {
            const email = document.getElementById('enhancedLoginEmail').value;
            const password = document.getElementById('enhancedLoginPassword').value;
            const rememberMe = document.getElementById('rememberMeEnhanced').checked;

            // Basic validation
            if (!email || !password) {
                alert('Please fill in all fields');
                return;
            }

            showAuthLoading();

            // Simulate API call
            setTimeout(() => {
                const users = JSON.parse(localStorage.getItem('users')) || [];
                const user = users.find(u => u.email === email && u.password === password);

                if (user) {
                    // Successful login
                    localStorage.setItem('currentUser', JSON.stringify(user));
                    currentUser = user;
                    isAuthenticated = true;
                    userHasDiscount = user.hasDiscount || false;

                    showAuthSuccess();

                    setTimeout(() => {
                        enhancedAuthModal.classList.remove('active');
                        checkoutModal.classList.add('active');
                        updateCheckoutStep(1);
                        initializeAddressSelection();

                        // If user has discount, apply it
                        if (userHasDiscount) {
                            applyDiscountToCart();
                        }
                    }, 1500);
                } else {
                    // Failed login
                    hideAuthLoading();
                    alert('Invalid email or password. Please try again.');
                }
            }, 1000);
        }

        function handleSignup() {
            const firstName = document.getElementById('signupFirstName').value;
            const lastName = document.getElementById('signupLastName').value;
            const email = document.getElementById('enhancedSignupEmail').value;
            const password = document.getElementById('enhancedSignupPassword').value;
            const confirmPassword = document.getElementById('enhancedSignupConfirmPassword').value;
            const agreeTerms = document.getElementById('agreeTermsEnhanced').checked;

            // Validation
            if (!firstName || !lastName || !email || !password || !confirmPassword) {
                alert('Please fill in all fields');
                return;
            }

            if (!agreeTerms) {
                alert('Please agree to the Terms & Conditions');
                return;
            }

            if (password !== confirmPassword) {
                alert('Passwords do not match');
                return;
            }

            // Check password strength
            const passwordRegex = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d).{8,}$/;
            if (!passwordRegex.test(password)) {
                alert('Password must be at least 8 characters long and contain uppercase, lowercase, and a number');
                return;
            }

            showAuthLoading();

            // Simulate API call
            setTimeout(() => {
                const users = JSON.parse(localStorage.getItem('users')) || [];

                // Check if user already exists
                if (users.find(u => u.email === email)) {
                    hideAuthLoading();
                    alert('An account with this email already exists. Please login instead.');
                    return;
                }

                // Create new user
                const newUser = {
                    id: Date.now(),
                    firstName: firstName,
                    lastName: lastName,
                    email: email,
                    password: password, // In real app, this would be hashed
                    hasDiscount: true, // First-time signup gets discount
                    createdAt: new Date().toISOString(),
                    orders: []
                };

                // Save user
                users.push(newUser);
                localStorage.setItem('users', JSON.stringify(users));
                localStorage.setItem('currentUser', JSON.stringify(newUser));

                currentUser = newUser;
                isAuthenticated = true;
                userHasDiscount = true;

                showAuthSuccess();

                setTimeout(() => {
                    enhancedAuthModal.classList.remove('active');
                    checkoutModal.classList.add('active');
                    updateCheckoutStep(1);
                    initializeAddressSelection();

                    // Apply 15% discount for first-time signup
                    applyDiscountToCart();
                }, 1500);
            }, 1000);
        }

        function handleForgotPassword() {
            const email = prompt('Please enter your email address to reset your password:');
            if (email) {
                alert(`Password reset link has been sent to ${email}. Check your email inbox.`);
            }
        }

        function showAuthLoading() {
            mainAuthContent.style.display = 'none';
            authLoading.classList.add('active');
            authSuccess.classList.remove('active');
        }

        function hideAuthLoading() {
            mainAuthContent.style.display = 'block';
            authLoading.classList.remove('active');
        }

        function showAuthSuccess() {
            mainAuthContent.style.display = 'none';
            authLoading.classList.remove('active');
            authSuccess.classList.add('active');
        }

        function resetAuthForms() {
            document.getElementById('enhancedLoginForm').reset();
            document.getElementById('enhancedSignupForm').reset();
            passwordStrength.textContent = '';
            passwordStrength.className = 'password-strength';

            // Reset password requirements
            [reqLength, reqUppercase, reqLowercase, reqNumber].forEach(el => {
                el.classList.remove('valid');
                el.classList.add('invalid');
                el.innerHTML = el.innerHTML.replace('fa-check-circle', 'fa-circle');
                el.innerHTML = el.innerHTML.replace('style="font-size: 6px;"', '');
                el.innerHTML = '<i class="fas fa-circle" style="font-size: 6px;"></i>' + el.textContent.replace(' ', '');
            });
        }

        function applyDiscountToCart() {
            // Apply 15% discount to cart
            const discountMultiplier = 0.85; // 15% off = 85% of original price

            // Update cart with discounted prices
            cart = cart.map(item => ({
                ...item,
                originalPrice: item.price,
                price: parseFloat((item.price * discountMultiplier).toFixed(2))
            }));

            localStorage.setItem('cart', JSON.stringify(cart));

            // Update display if cart modal is open
            if (cartModal.classList.contains('active')) {
                updateCartDisplay();
            }

            // Show discount applied message
            const discountMessage = document.createElement('div');
            discountMessage.className = 'discount-display';
            discountMessage.innerHTML = `
                <i class="fas fa-gift"></i>
                <span>15% discount applied to your order!</span>
            `;

            // Insert at beginning of cart summary
            const cartSummary = document.getElementById('cartSummary');
            if (cartSummary) {
                cartSummary.insertBefore(discountMessage, cartSummary.firstChild);
            }
        }

        // Update checkout step
        function updateCheckoutStep(step) {
            currentCheckoutStep = step;

            checkoutSteps.forEach(s => {
                s.classList.remove('active', 'completed');

                const stepNum = parseInt(s.getAttribute('data-step'));

                if (stepNum === step) {
                    s.classList.add('active');
                } else if (stepNum < step) {
                    s.classList.add('completed');
                }
            });

            checkoutForms.forEach(form => {
                form.classList.remove('active');
            });

            if (step === 1) {
                shippingForm.classList.add('active');
            } else if (step === 2) {
                paymentForm.classList.add('active');
                updateBankDetails();
            } else if (step === 3) {
                updateReviewSection();
                reviewForm.classList.add('active');
            }
        }

        // Checkout navigation - UPDATED FOR ADDRESS VALIDATION
        nextToPaymentBtn.addEventListener('click', () => {
            if (!validateAddressSelection()) {
                alert('Please complete the address selection process before proceeding');
                return;
            }

            if (!validateShippingForm()) {
                alert('Please fill in all required shipping information');
                return;
            }

            updateCheckoutStep(2);
        });

        backToShippingBtn.addEventListener('click', () => {
            updateCheckoutStep(1);
        });

        nextToReviewBtn.addEventListener('click', () => {
            if (selectedPaymentMethod === 'credit' && !validatePaymentForm()) {
                alert('Please fill in all required payment information');
                return;
            }

            updateCheckoutStep(3);
        });

        backToPaymentBtn2.addEventListener('click', () => {
            updateCheckoutStep(2);
        });

        backToCartBtn.addEventListener('click', () => {
            checkoutModal.classList.remove('active');
            cartModal.classList.add('active');
        });

        // Initialize payment methods
        function initializePaymentMethods() {
            // Payment method selection
            paymentMethods.forEach(method => {
                method.addEventListener('click', function() {
                    const methodType = this.getAttribute('data-method');

                    // Remove selected class from all methods
                    paymentMethods.forEach(m => m.classList.remove('selected'));
                    // Add selected class to clicked method
                    this.classList.add('selected');

                    // Update selected payment method
                    selectedPaymentMethod = methodType;

                    // Hide all payment details
                    creditCardDetails.classList.remove('active');
                    paypalDetails.classList.remove('active');
                    bankTransferDetails.classList.remove('active');

                    // Show selected payment method details
                    if (methodType === 'credit') {
                        creditCardDetails.classList.add('active');
                        // Make credit card fields required
                        document.getElementById('cardName').required = true;
                        document.getElementById('cardNumber').required = true;
                        document.getElementById('cardExpiry').required = true;
                        document.getElementById('cardCVC').required = true;
                    } else if (methodType === 'paypal') {
                        paypalDetails.classList.add('active');
                        // Remove required from credit card fields
                        document.getElementById('cardName').required = false;
                        document.getElementById('cardNumber').required = false;
                        document.getElementById('cardExpiry').required = false;
                        document.getElementById('cardCVC').required = false;
                    } else if (methodType === 'bank') {
                        bankTransferDetails.classList.add('active');
                        // Remove required from credit card fields
                        document.getElementById('cardName').required = false;
                        document.getElementById('cardNumber').required = false;
                        document.getElementById('cardExpiry').required = false;
                        document.getElementById('cardCVC').required = false;
                    }
                });
            });

            // PayPal button functionality
            paypalButton.addEventListener('click', function(e) {
                e.preventDefault();
                processPayPalPayment();
            });
        }

        // Process PayPal payment
        function processPayPalPayment() {
            // In a real implementation, this would redirect to PayPal
            // For demo purposes, we'll simulate a successful payment
            alert('You would now be redirected to PayPal to complete your payment. In a real implementation, this would integrate with the PayPal API.');

            // Simulate successful PayPal payment
            simulatePaymentProcessing('paypal');
        }

        // Simulate payment processing
        function simulatePaymentProcessing(method) {
            // Show processing message
            const paypalButton = document.getElementById('paypalButton');
            const originalText = paypalButton.innerHTML;

            if (method === 'paypal') {
                paypalButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
                paypalButton.disabled = true;

                // Simulate API call delay
                setTimeout(() => {
                    paypalButton.innerHTML = '<i class="fab fa-paypal"></i> Payment Successful!';
                    paypalButton.style.background = 'linear-gradient(135deg, #28a745, #20c997)';

                    // Enable next button
                    document.getElementById('nextToReview').disabled = false;

                    setTimeout(() => {
                        paypalButton.innerHTML = originalText;
                        paypalButton.style.background = '';
                        paypalButton.disabled = false;
                    }, 3000);
                }, 2000);
            }
        }

        // Update bank transfer details
        function updateBankDetails() {
            const subtotal = cart.reduce((total, item) => total + (item.price * item.quantity), 0);
            const shipping = 50.00;
            const total = subtotal + shipping;
            const orderId = Math.floor(1000 + Math.random() * 9000);

            document.getElementById('bankReference').textContent = orderId;
            document.getElementById('bankAmount').textContent = `R${total.toFixed(2)}`;
        }

        // Update review section
        function updateReviewSection() {
            const subtotal = cart.reduce((total, item) => total + (item.price * item.quantity), 0);
            const shipping = 50.00;
            const total = subtotal + shipping;

            let reviewItemsHTML = '';
            cart.forEach(item => {
                reviewItemsHTML += `
                    <div class="review-item">
                        <span>${item.name}  ${item.quantity}</span>
                        <span>R${(item.price * item.quantity).toFixed(2)}</span>
                    </div>
                `;
            });

            document.getElementById('reviewItems').innerHTML = reviewItemsHTML;

            document.getElementById('reviewSubtotal').textContent = `R${subtotal.toFixed(2)}`;
            document.getElementById('reviewShipping').textContent = `R${shipping.toFixed(2)}`;
            document.getElementById('reviewTax').textContent = `R0.00`;
            document.getElementById('reviewTotal').textContent = `R${total.toFixed(2)}`;
        }

        // Place order
        placeOrderBtn.addEventListener('click', () => {
            if (!document.getElementById('agreeTermsCheckout').checked) {
                alert('Please agree to the Terms & Conditions');
                return;
            }

            if (!validateAddressSelection()) {
                alert('Please complete the address selection process');
                return;
            }

            const orderId = Math.floor(1000 + Math.random() * 9000);
            document.getElementById('orderId').textContent = orderId;

            // Get shipping information
            const shippingInfo = {
                firstName: document.getElementById('shippingFirstName').value,
                lastName: document.getElementById('shippingLastName').value,
                email: document.getElementById('shippingEmail').value,
                phone: document.getElementById('shippingPhone').value,
                country: selectedCountry,
                state: selectedState || manualState,
                city: selectedCity || manualCity,
                village: selectedVillage || manualVillage,
                zip: selectedZip || manualZip,
                street: document.getElementById('shippingAddress').value,
                apartment: document.getElementById('shippingApartment').value,
                notes: document.getElementById('shippingNotes').value,
                isManualEntry: isManualEntry
            };

            // Save shipping info to user profile if logged in
            if (isAuthenticated && currentUser) {
                const users = JSON.parse(localStorage.getItem('users')) || [];
                const userIndex = users.findIndex(u => u.id === currentUser.id);

                if (userIndex !== -1) {
                    // Save shipping info to user profile
                    users[userIndex].shippingInfo = shippingInfo;
                    localStorage.setItem('users', JSON.stringify(users));

                    // Update current user
                    currentUser.shippingInfo = shippingInfo;
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                }
            }

            const order = {
                id: orderId,
                date: new Date().toISOString(),
                items: [...cart],
                total: parseFloat(document.getElementById('reviewTotal').textContent.replace('R', '')),
                paymentMethod: selectedPaymentMethod,
                status: selectedPaymentMethod === 'bank' ? 'Pending Payment' : 'Processing',
                shippingAddress: shippingInfo,
                paymentDetails: selectedPaymentMethod === 'bank' ? {
                    bankName: 'Standard Bank',
                    accountName: 'Lonz Flawls Aura',
                    accountNumber: '0123456789',
                    branchCode: '051001',
                    reference: orderId,
                    amount: parseFloat(document.getElementById('reviewTotal').textContent.replace('R', ''))
                } : null,
                userId: isAuthenticated ? currentUser.id : null,
                discountApplied: userHasDiscount
            };

            // Save order to user's order history if logged in
            if (isAuthenticated && currentUser) {
                const users = JSON.parse(localStorage.getItem('users')) || [];
                const userIndex = users.findIndex(u => u.id === currentUser.id);

                if (userIndex !== -1) {
                    if (!users[userIndex].orders) {
                        users[userIndex].orders = [];
                    }
                    users[userIndex].orders.push(order);
                    localStorage.setItem('users', JSON.stringify(users));
                }
            }

            const orders = JSON.parse(localStorage.getItem('orders')) || [];
            orders.push(order);
            localStorage.setItem('orders', JSON.stringify(orders));

            // Clear cart
            cart = [];
            localStorage.setItem('cart', JSON.stringify(cart));
            updateCartBadge();

            // Close checkout modal
            checkoutModal.classList.remove('active');

            // Set success message based on payment method and authentication status
            let successMsg = "Thank you for your purchase. Your order has been successfully placed and is being processed. You will receive a confirmation email shortly.";

            if (selectedPaymentMethod === 'paypal') {
                successMsg = "Thank you for your purchase! Your PayPal payment was successful and your order is being processed. You will receive a confirmation email shortly.";
            } else if (selectedPaymentMethod === 'bank') {
                successMsg = "Thank you for your order! Please transfer R" + order.total.toFixed(2) + " to our bank account (details in your confirmation email). Your order will be processed once payment is confirmed.";
            }

            // Add account creation message if guest checkout
            if (!isAuthenticated) {
                successMsg += "\n\nWant to save your shipping info for faster checkout next time? Create an account to unlock order tracking and exclusive discounts!";
            }

            successMessage.textContent = successMsg;
            successModal.classList.add('active');

            resetAddressSelection();

            // Reset authentication state for next checkout
            userHasDiscount = false;
        });

        // Continue shopping
        continueShoppingBtn.addEventListener('click', () => {
            successModal.classList.remove('active');
        });

        // Validation functions
        function validateShippingForm() {
            const requiredFields = [
                'shippingFirstName',
                'shippingLastName',
                'shippingEmail',
                'shippingPhone',
                'shippingAddress'
            ];

            for (const fieldId of requiredFields) {
                const field = document.getElementById(fieldId);
                if (!field.value.trim()) {
                    return false;
                }
            }

            return true;
        }

        function validatePaymentForm() {
            if (selectedPaymentMethod !== 'credit') {
                return true;
            }

            const requiredFields = [
                'cardName',
                'cardNumber',
                'cardExpiry',
                'cardCVC'
            ];

            for (const fieldId of requiredFields) {
                const field = document.getElementById(fieldId);
                if (!field.value.trim()) {
                    return false;
                }
            }

            // Simple card validation
            const cardNumber = document.getElementById('cardNumber').value.replace(/\s/g, '');
            const cardExpiry = document.getElementById('cardExpiry').value;
            const cardCVC = document.getElementById('cardCVC').value;

            // Check card number length (13-19 digits)
            if (cardNumber.length < 13 || cardNumber.length > 19) {
                alert('Please enter a valid card number');
                return false;
            }

            // Check expiry date format
            if (!/^\d{2}\/\d{2}$/.test(cardExpiry)) {
                alert('Please enter expiry date in MM/YY format');
                return false;
            }

            // Check if card is not expired
            const [month, year] = cardExpiry.split('/');
            const currentYear = new Date().getFullYear() % 100;
            const currentMonth = new Date().getMonth() + 1;

            if (parseInt(year) < currentYear || (parseInt(year) === currentYear && parseInt(month) < currentMonth)) {
                alert('Card has expired');
                return false;
            }

            // Check CVC length (3-4 digits)
            if (cardCVC.length < 3 || cardCVC.length > 4) {
                alert('Please enter a valid CVC');
                return false;
            }

            return true;
        }

        // NEW: Address Selection Functions with manual entry support

        function initializeAddressSelection() {
            populateCountryOptions();

            document.getElementById('nextAddressStep').addEventListener('click', goToNextAddressStep);
            document.getElementById('prevAddressStep').addEventListener('click', goToPrevAddressStep);

            document.getElementById('shippingZip').addEventListener('input', validateZipCode);

            // NEW: Pre-fill shipping info if user is logged in and has saved info
            if (isAuthenticated && currentUser && currentUser.shippingInfo) {
                prefillShippingInfo(currentUser.shippingInfo);
            }
        }

        function prefillShippingInfo(shippingInfo) {
            document.getElementById('shippingFirstName').value = shippingInfo.firstName || '';
            document.getElementById('shippingLastName').value = shippingInfo.lastName || '';
            document.getElementById('shippingEmail').value = shippingInfo.email || '';
            document.getElementById('shippingPhone').value = shippingInfo.phone || '';
            document.getElementById('shippingAddress').value = shippingInfo.street || '';
            document.getElementById('shippingApartment').value = shippingInfo.apartment || '';
            document.getElementById('shippingNotes').value = shippingInfo.notes || '';

            // Note: Country/state/city selection would need more complex logic
            // For now, we just prefill the basic fields
        }

        function populateCountryOptions() {
            const countryOptions = document.getElementById('countryOptions');
            countryOptions.innerHTML = '';

            addressData.countries.forEach(country => {
                const option = document.createElement('div');
                option.className = 'address-option';
                option.innerHTML = `
                    <i class="fas fa-globe-americas"></i>
                    <p>${country.flag} ${country.name}</p>
                    <small style="color: rgba(255, 255, 255, 0.6);">${country.currency}</small>
                `;
                option.addEventListener('click', () => selectCountry(country.code));
                countryOptions.appendChild(option);
            });
        }

        function selectCountry(countryCode) {
            selectedCountry = countryCode;
            const country = addressData.countries.find(c => c.code === countryCode);

            document.querySelectorAll('#countryOptions .address-option').forEach(option => {
                option.classList.remove('selected');
            });
            event.target.closest('.address-option').classList.add('selected');

            updateAddressProgress('country');

            populateStateOptions(countryCode);

            setTimeout(() => goToNextAddressStep(), 500);
        }

        function populateStateOptions(countryCode) {
            const stateOptions = document.getElementById('stateOptions');
            stateOptions.innerHTML = '';

            const states = addressData.states[countryCode] || [];

            if (states.length === 0) {
                stateOptions.innerHTML = `
                    <div style="text-align: center; padding: 30px; color: rgba(255, 255, 255, 0.7);">
                        <i class="fas fa-exclamation-circle" style="font-size: 40px; margin-bottom: 15px;"></i>
                        <p>No states/provinces available for this country.</p>
                        <p style="margin-top: 10px; font-size: 14px;">You can enter state manually.</p>
                    </div>
                `;
                return;
            }

            states.forEach(state => {
                const option = document.createElement('div');
                option.className = 'address-option';
                option.innerHTML = `
                    <i class="fas fa-map-marker-alt"></i>
                    <p>${state}</p>
                `;
                option.addEventListener('click', () => selectState(state));
                stateOptions.appendChild(option);
            });
        }

        function selectState(state) {
            selectedState = state;
            manualState = '';
            isManualEntry = false;

            document.querySelectorAll('#stateOptions .address-option').forEach(option => {
                option.classList.remove('selected');
            });
            event.target.closest('.address-option').classList.add('selected');

            updateAddressProgress('state');

            populateCityOptions(state);

            setTimeout(() => goToNextAddressStep(), 500);
        }

        function enterStateManually() {
            isManualEntry = true;
            selectedState = '';
            manualState = prompt('Please enter your state/province name:');

            if (manualState && manualState.trim()) {
                manualState = manualState.trim();
                selectedState = manualState;
                updateAddressProgress('state');

                populateCityOptions(manualState);

                setTimeout(() => goToNextAddressStep(), 500);
            }
        }

        function populateCityOptions(state) {
            const cityOptions = document.getElementById('cityOptions');
            cityOptions.innerHTML = '';

            const cities = addressData.cities[state] || [];

            if (cities.length === 0) {
                cityOptions.innerHTML = `
                    <div style="text-align: center; padding: 30px; color: rgba(255, 255, 255, 0.7);">
                        <i class="fas fa-exclamation-circle" style="font-size: 40px; margin-bottom: 15px;"></i>
                        <p>No cities available for this state.</p>
                        <p style="margin-top: 10px; font-size: 14px;">You can enter city manually.</p>
                    </div>
                `;
                return;
            }

            cities.forEach(city => {
                const option = document.createElement('div');
                option.className = 'address-option';
                option.innerHTML = `
                    <i class="fas fa-city"></i>
                    <p>${city}</p>
                `;
                option.addEventListener('click', () => selectCity(city));
                cityOptions.appendChild(option);
            });
        }

        function selectCity(city) {
            selectedCity = city;
            manualCity = '';
            isManualEntry = false;

            document.querySelectorAll('#cityOptions .address-option').forEach(option => {
                option.classList.remove('selected');
            });
            event.target.closest('.address-option').classList.add('selected');

            updateAddressProgress('city');

            populateVillageOptions(city);

            setTimeout(() => goToNextAddressStep(), 500);
        }

        function enterCityManually() {
            isManualEntry = true;
            selectedCity = '';
            manualCity = prompt('Please enter your city/town name:');

            if (manualCity && manualCity.trim()) {
                manualCity = manualCity.trim();
                selectedCity = manualCity;
                updateAddressProgress('city');

                populateVillageOptions(manualCity);

                setTimeout(() => goToNextAddressStep(), 500);
            }
        }

        function populateVillageOptions(city) {
            const villageOptions = document.getElementById('villageOptions');
            villageOptions.innerHTML = '';

            const villages = addressData.villages[city] || [];

            if (villages.length === 0) {
                villageOptions.innerHTML = `
                    <div style="text-align: center; padding: 30px; color: rgba(255, 255, 255, 0.7);">
                        <i class="fas fa-exclamation-circle" style="font-size: 40px; margin-bottom: 15px;"></i>
                        <p>No villages/suburbs available for this city.</p>
                        <p style="margin-top: 10px; font-size: 14px;">You can enter village manually below.</p>
                    </div>
                `;
                return;
            }

            villages.forEach(village => {
                const option = document.createElement('div');
                option.className = 'address-option';
                option.innerHTML = `
                    <i class="fas fa-home"></i>
                    <p>${village}</p>
                `;
                option.addEventListener('click', () => selectVillage(village));
                villageOptions.appendChild(option);
            });
        }

        function selectVillage(village) {
            selectedVillage = village;
            manualVillage = '';
            manualZip = '';
            isManualEntry = false;

            document.querySelectorAll('#villageOptions .address-option').forEach(option => {
                option.classList.remove('selected');
            });
            event.target.closest('.address-option').classList.add('selected');

            updateAddressProgress('village');

            // Clear manual village input if shown
            document.getElementById('manualVillageContainer').classList.remove('active');
            document.getElementById('manualVillageName').value = '';
            document.getElementById('manualVillageZip').value = '';

            setTimeout(() => goToNextAddressStep(), 500);
        }

        function enterVillageManually() {
            // Hide village options and show manual input
            document.getElementById('villageOptions').style.display = 'none';
            document.getElementById('villageSearch').style.display = 'none';
            document.getElementById('manualVillageContainer').classList.add('active');
            document.querySelectorAll('#villageStep .address-option').forEach(opt => {
                opt.style.display = 'none';
            });
        }

        function cancelManualVillage() {
            // Show village options and hide manual input
            document.getElementById('villageOptions').style.display = 'block';
            document.getElementById('villageSearch').style.display = 'flex';
            document.getElementById('manualVillageContainer').classList.remove('active');
            document.querySelectorAll('#villageStep .address-option').forEach(opt => {
                opt.style.display = 'flex';
            });

            // Clear manual input
            document.getElementById('manualVillageName').value = '';
            document.getElementById('manualVillageZip').value = '';
        }

        function saveManualVillage() {
            const villageName = document.getElementById('manualVillageName').value.trim();
            const villageZip = document.getElementById('manualVillageZip').value.trim();

            if (!villageName) {
                alert('Please enter village/suburb name');
                return;
            }

            if (!villageZip) {
                alert('Please enter ZIP/postal code');
                return;
            }

            // Set manual values
            manualVillage = villageName;
            manualZip = villageZip;
            selectedVillage = villageName;
            selectedZip = villageZip;
            isManualEntry = true;

            // Show manual village note in ZIP step
            document.getElementById('manualVillageNote').style.display = 'block';

            updateAddressProgress('village');

            // Go to ZIP step directly since we already have ZIP
            document.getElementById('villageStep').classList.remove('active');
            currentAddressStep = 'zip';
            document.getElementById('zipStep').classList.add('active');

            // Set the ZIP input value
            document.getElementById('shippingZip').value = villageZip;

            // Update address confirmation
            updateAddressConfirmation();

            // Update navigation
            updateAddressNavigation();

            // Validate ZIP
            validateZipCode();
        }

        function skipVillage() {
            selectedVillage = '';
            manualVillage = '';
            manualZip = '';
            isManualEntry = false;

            updateAddressProgress('village');

            goToNextAddressStep();
        }

        function validateZipCode() {
            const zipInput = document.getElementById('shippingZip');
            const zipValidation = document.getElementById('zipValidation');
            selectedZip = zipInput.value.trim();

            if (!selectedZip) {
                zipValidation.innerHTML = '';
                return false;
            }

            // If manual entry, accept any ZIP code
            if (isManualEntry && manualZip) {
                zipValidation.innerHTML = `
                    <i class="fas fa-check-circle"></i>
                    <span>Manual ZIP code accepted</span>
                `;
                zipValidation.className = 'zip-validation valid';

                updateAddressConfirmation();
                return true;
            }

            // For regular entries, validate against list if available
            const validZips = addressData.zipCodes[selectedCity] || [];
            const isValid = validZips.some(zip => selectedZip.startsWith(zip.substring(0, 2))) || validZips.length === 0;

            if (isValid) {
                zipValidation.innerHTML = `
                    <i class="fas fa-check-circle"></i>
                    <span>Valid ZIP code for ${selectedCity}</span>
                `;
                zipValidation.className = 'zip-validation valid';

                updateAddressConfirmation();
                return true;
            } else {
                zipValidation.innerHTML = `
                    <i class="fas fa-exclamation-triangle"></i>
                    <span>ZIP code may not match ${selectedCity}</span>
                `;
                zipValidation.className = 'zip-validation invalid';
                return false;
            }
        }

        function updateAddressConfirmation() {
            const addressDetails = document.getElementById('addressDetails');
            const addressConfirmation = document.getElementById('addressConfirmation');

            if ((selectedCountry && selectedState && selectedCity) || (selectedCountry && (manualState || manualCity))) {
                let addressText = '';

                if (isManualEntry) {
                    addressText = `
                        <strong>${manualVillage || 'N/A'}</strong><br>
                        ${manualCity || selectedCity}, ${manualState || selectedState}<br>
                        ${selectedCountry}<br>
                        ZIP: ${manualZip || selectedZip}<br>
                        <small style="color: var(--accent-color);"><i class="fas fa-edit"></i> Manually entered</small>
                    `;
                } else {
                    addressText = `
                        <strong>${selectedVillage || 'N/A'}, ${selectedCity}</strong><br>
                        ${selectedState}, ${selectedCountry}<br>
                        ZIP: ${selectedZip}
                    `;
                }

                addressDetails.innerHTML = addressText;
                addressConfirmation.style.display = 'block';
            } else {
                addressConfirmation.style.display = 'none';
            }
        }

        function updateAddressProgress(step) {
            document.querySelectorAll('.address-progress-step').forEach(stepEl => {
                stepEl.classList.remove('active', 'completed');

                const stepName = stepEl.getAttribute('data-step');

                if (stepName === step) {
                    stepEl.classList.add('active');
                } else if (
                    (stepName === 'country' && selectedCountry) ||
                    (stepName === 'state' && (selectedState || manualState)) ||
                    (stepName === 'city' && (selectedCity || manualCity)) ||
                    (stepName === 'village' && (selectedVillage !== undefined || manualVillage)) ||
                    (stepName === 'zip' && (selectedZip || manualZip))
                ) {
                    stepEl.classList.add('completed');
                }
            });

            updateAddressConfirmation();
        }

        function goToNextAddressStep() {
            const steps = ['country', 'state', 'city', 'village', 'zip'];
            const currentIndex = steps.indexOf(currentAddressStep);

            if (!validateCurrentAddressStep()) {
                return;
            }

            if (currentIndex < steps.length - 1) {
                document.getElementById(`${currentAddressStep}Step`).classList.remove('active');

                currentAddressStep = steps[currentIndex + 1];

                document.getElementById(`${currentAddressStep}Step`).classList.add('active');

                updateAddressNavigation();

                updateAddressProgress(currentAddressStep);

                if (currentAddressStep === 'zip') {
                    validateZipCode();
                }
            }
        }

        function goToPrevAddressStep() {
            const steps = ['country', 'state', 'city', 'village', 'zip'];
            const currentIndex = steps.indexOf(currentAddressStep);

            if (currentIndex > 0) {
                document.getElementById(`${currentAddressStep}Step`).classList.remove('active');

                currentAddressStep = steps[currentIndex - 1];

                document.getElementById(`${currentAddressStep}Step`).classList.add('active');

                updateAddressNavigation();

                // Reset manual village display if going back to village step
                if (currentAddressStep === 'village') {
                    document.getElementById('villageOptions').style.display = 'block';
                    document.getElementById('villageSearch').style.display = 'flex';
                    document.getElementById('manualVillageContainer').classList.remove('active');
                    document.querySelectorAll('#villageStep .address-option').forEach(opt => {
                        opt.style.display = 'flex';
                    });
                }
            }
        }

        function updateAddressNavigation() {
            const prevBtn = document.getElementById('prevAddressStep');
            const nextBtn = document.getElementById('nextAddressStep');

            if (currentAddressStep === 'country') {
                prevBtn.style.display = 'none';
            } else {
                prevBtn.style.display = 'inline-flex';
            }

            if (currentAddressStep === 'zip') {
                nextBtn.innerHTML = 'Complete Address Selection <i class="fas fa-check"></i>';
            } else {
                nextBtn.innerHTML = 'Next <i class="fas fa-arrow-right"></i>';
            }
        }

        function validateCurrentAddressStep() {
            switch (currentAddressStep) {
                case 'country':
                    if (!selectedCountry) {
                        alert('Please select a country');
                        return false;
                    }
                    break;
                case 'state':
                    if (!selectedState && !manualState) {
                        alert('Please select or enter a state/province');
                        return false;
                    }
                    break;
                case 'city':
                    if (!selectedCity && !manualCity) {
                        alert('Please select or enter a city/town');
                        return false;
                    }
                    break;
                case 'village':
                    // Village is optional
                    break;
                case 'zip':
                    if (!validateZipCode()) {
                        alert('Please enter a valid ZIP code');
                        return false;
                    }
                    break;
            }
            return true;
        }

        function validateAddressSelection() {
            // For manual entry, we need at least country, state (manual), city (manual), and zip
            if (isManualEntry) {
                return selectedCountry && (manualState || selectedState) && (manualCity || selectedCity) && (manualZip || selectedZip);
            }

            // For regular entry, we need country, state, city, and zip
            return selectedCountry && selectedState && selectedCity && selectedZip;
        }

        function resetAddressSelection() {
            currentAddressStep = 'country';
            selectedCountry = '';
            selectedState = '';
            selectedCity = '';
            selectedVillage = '';
            selectedZip = '';
            isManualEntry = false;
            manualState = '';
            manualCity = '';
            manualVillage = '';
            manualZip = '';

            document.querySelectorAll('.address-step').forEach(step => {
                step.classList.remove('active');
            });
            document.getElementById('countryStep').classList.add('active');

            document.querySelectorAll('.address-progress-step').forEach(step => {
                step.classList.remove('active', 'completed');
            });
            document.querySelector('[data-step="country"]').classList.add('active');

            document.querySelectorAll('.address-option').forEach(option => {
                option.classList.remove('selected');
            });

            // Reset manual village container
            document.getElementById('villageOptions').style.display = 'block';
            document.getElementById('villageSearch').style.display = 'flex';
            document.getElementById('manualVillageContainer').classList.remove('active');
            document.getElementById('manualVillageName').value = '';
            document.getElementById('manualVillageZip').value = '';
            document.querySelectorAll('#villageStep .address-option').forEach(opt => {
                opt.style.display = 'flex';
            });

            document.getElementById('shippingZip').value = '';
            document.getElementById('zipValidation').innerHTML = '';
            document.getElementById('addressConfirmation').style.display = 'none';
            document.getElementById('manualVillageNote').style.display = 'none';

            updateAddressNavigation();
        }

        // Search functions for address selection
        function searchStates() {
            const searchTerm = document.getElementById('stateSearch').value.toLowerCase();
            const states = addressData.states[selectedCountry] || [];
            const filteredStates = states.filter(state => 
                state.toLowerCase().includes(searchTerm)
            );

            const stateOptions = document.getElementById('stateOptions');
            stateOptions.innerHTML = '';

            if (filteredStates.length === 0) {
                stateOptions.innerHTML = `
                    <div style="text-align: center; padding: 30px; color: rgba(255, 255, 255, 0.7);">
                        <i class="fas fa-search" style="font-size: 40px; margin-bottom: 15px;"></i>
                        <p>No states found for "${searchTerm}"</p>
                    </div>
                `;
                return;
            }

            filteredStates.forEach(state => {
                const option = document.createElement('div');
                option.className = 'address-option';
                option.innerHTML = `
                    <i class="fas fa-map-marker-alt"></i>
                    <p>${state}</p>
                `;
                option.addEventListener('click', () => selectState(state));
                stateOptions.appendChild(option);
            });
        }

        function searchCities() {
            const searchTerm = document.getElementById('citySearch').value.toLowerCase();
            const stateName = selectedState || manualState;
            const cities = addressData.cities[stateName] || [];
            const filteredCities = cities.filter(city => 
                city.toLowerCase().includes(searchTerm)
            );

            const cityOptions = document.getElementById('cityOptions');
            cityOptions.innerHTML = '';

            if (filteredCities.length === 0) {
                cityOptions.innerHTML = `
                    <div style="text-align: center; padding: 30px; color: rgba(255, 255, 255, 0.7);">
                        <i class="fas fa-search" style="font-size: 40px; margin-bottom: 15px;"></i>
                        <p>No cities found for "${searchTerm}"</p>
                    </div>
                `;
                return;
            }

            filteredCities.forEach(city => {
                const option = document.createElement('div');
                option.className = 'address-option';
                option.innerHTML = `
                    <i class="fas fa-city"></i>
                    <p>${city}</p>
                `;
                option.addEventListener('click', () => selectCity(city));
                cityOptions.appendChild(option);
            });
        }

        function searchVillages() {
            const searchTerm = document.getElementById('villageSearch').value.toLowerCase();
            const cityName = selectedCity || manualCity;
            const villages = addressData.villages[cityName] || [];
            const filteredVillages = villages.filter(village => 
                village.toLowerCase().includes(searchTerm)
            );

            const villageOptions = document.getElementById('villageOptions');
            villageOptions.innerHTML = '';

            if (filteredVillages.length === 0) {
                villageOptions.innerHTML = `
                    <div style="text-align: center; padding: 30px; color: rgba(255, 255, 255, 0.7);">
                        <i class="fas fa-search" style="font-size: 40px; margin-bottom: 15px;"></i>
                        <p>No villages found for "${searchTerm}"</p>
                    </div>
                `;
                return;
            }

            filteredVillages.forEach(village => {
                const option = document.createElement('div');
                option.className = 'address-option';
                option.innerHTML = `
                    <i class="fas fa-home"></i>
                    <p>${village}</p>
                `;
                option.addEventListener('click', () => selectVillage(village));
                villageOptions.appendChild(option);
            });
        }

        // Start qualification wizard
        startQualificationBtn.addEventListener('click', () => {
            document.getElementById('qualification').scrollIntoView({ behavior: 'smooth' });
        });

        // Option selection in wizard
        optionItems.forEach(item => {
            item.addEventListener('click', function() {
                const parentStep = this.closest('.wizard-step');
                const allOptions = parentStep.querySelectorAll('.option-item');
                allOptions.forEach(opt => opt.classList.remove('selected'));

                this.classList.add('selected');

                const stepId = parentStep.id;
                const value = this.getAttribute('data-value');

                if (stepId === 'step1') {
                    userData.skinConcern = value;
                } else if (stepId === 'step2') {
                    userData.sensitivity = value;
                } else if (stepId === 'step3') {
                    userData.ageRange = value;
                }
            });
        });

        // Wizard navigation
        wizardNextBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                const step = parseInt(this.getAttribute('data-step'));

                if (step === 1 && !userData.skinConcern) {
                    alert('Please select your primary skin concern');
                    return;
                } else if (step === 2 && !userData.sensitivity) {
                    alert('Please select your skin sensitivity level');
                    return;
                } else if (step === 3 && !userData.ageRange) {
                    alert('Please select your age range');
                    return;
                }

                if (step === 3) {
                    generatePersonalizedRecommendations();
                    return;
                }

                if (currentStep < totalSteps) {
                    wizardSteps[currentStep - 1].classList.remove('active');
                    currentStep++;
                    wizardSteps[currentStep - 1].classList.add('active');
                    updateProgressBar();
                }
            });
        });

        wizardPrevBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                if (currentStep > 1) {
                    wizardSteps[currentStep - 1].classList.remove('active');
                    currentStep--;
                    wizardSteps[currentStep - 1].classList.add('active');
                    updateProgressBar();
                }
            });
        });

        // Update progress bar
        function updateProgressBar() {
            const progress = ((currentStep - 1) / (totalSteps - 1)) * 100;
            progressBar.style.width = `${progress}%`;
        }

        // Generate personalized recommendations based on user data
        function generatePersonalizedRecommendations() {
            const logic = recommendationLogic[userData.skinConcern];

            if (!logic) {
                personalizedRecommendations = [1, 14];
                showResults("Based on your skin profile, we recommend our best-selling Whitening Combo to address your concerns and deliver radiant results.", [1, 14]);
                return;
            }

            personalizedRecommendations = [...logic.products];

            if (userData.sensitivity === 'very-sensitive' || userData.sensitivity === 'sensitive') {
                personalizedRecommendations = personalizedRecommendations.filter(id => id !== 3 && id !== 5);

                if (userData.skinConcern === 'acne') {
                    personalizedRecommendations.push(4);
                }
            }

            if (userData.ageRange === '50-plus' || userData.ageRange === '36-50') {
                if (!personalizedRecommendations.includes(1)) {
                    personalizedRecommendations.push(1);
                }
                if (!personalizedRecommendations.includes(2)) {
                    personalizedRecommendations.push(2);
                }
            }

            let description = logic.description + " " + logic.explanation;

            if (userData.sensitivity === 'very-sensitive' || userData.sensitivity === 'sensitive') {
                description += " We've selected gentle formulas suitable for sensitive skin.";
            }

            if (userData.ageRange === '50-plus') {
                description += " These products are specially chosen for mature skin needs.";
            } else if (userData.ageRange === '36-50') {
                description += " These formulas address both your primary concern and early signs of aging.";
            }

            showResults(description, personalizedRecommendations, logic.primaryCombo);
        }

        // Show results modal with personalized recommendations - UPDATED to use product cards
        function showResults(description, productIds, primaryComboId = null) {
            document.getElementById('resultDescription').textContent = description;

            const personalizedProductsDiv = document.getElementById('personalizedProducts');
            personalizedProductsDiv.innerHTML = '';

            productIds.forEach(productId => {
                const product = products.find(p => p.id === productId);
                if (product) {
                    let detailsHTML = '';
                    if (product.benefits || product.usage || product.ingredients) {
                        detailsHTML = `
                            <div class="product-details">
                                ${product.benefits ? `<div class="product-benefits"><strong>Benefits:</strong> ${product.benefits}</div>` : ''}
                                ${product.usage ? `<div class="product-usage"><strong>Usage:</strong> ${product.usage}</div>` : ''}
                                ${product.ingredients ? `<div class="product-ingredients"><strong>Active Ingredients:</strong> ${product.ingredients}</div>` : ''}
                            </div>
                        `;
                    }

                    const productHTML = `
                        <div class="product-card glass-card">
                            ${product.section === "flagship" ? '<div class="product-badge badge-flagship">Flagship</div>' : ''}
                            <div class="product-image" style="background-image: url('${product.image}');"></div>
                            <div class="product-info">
                                <h3>${product.name}</h3>
                                <p>${product.description.substring(0, 100)}...</p>
                                ${detailsHTML}
                                <div class="product-price">R${product.price.toFixed(2)}</div>
                            </div>
                            <button class="glass-button add-to-cart" 
                                data-id="${product.id}" 
                                data-name="${product.name}" 
                                data-price="${product.price}" 
                                data-image="${product.image}">
                                <i class="fas fa-cart-plus"></i> Add to Cart
                            </button>
                        </div>
                    `;
                    personalizedProductsDiv.innerHTML += productHTML;
                }
            });

            if (primaryComboId) {
                const comboProduct = products.find(p => p.id === primaryComboId);
                if (comboProduct) {
                    let comboDetailsHTML = '';
                    if (comboProduct.benefits || comboProduct.usage || comboProduct.ingredients) {
                        comboDetailsHTML = `
                            <div class="product-details">
                                ${comboProduct.benefits ? `<div class="product-benefits"><strong>Benefits:</strong> ${comboProduct.benefits}</div>` : ''}
                                ${comboProduct.usage ? `<div class="product-usage"><strong>Usage:</strong> ${comboProduct.usage}</div>` : ''}
                                ${comboProduct.ingredients ? `<div class="product-ingredients"><strong>Contains:</strong> ${comboProduct.ingredients}</div>` : ''}
                            </div>
                        `;
                    }

                    const comboHTML = `
                        <div class="product-card glass-card combo-card">
                            <div class="product-badge badge-recommended">Recommended Combo</div>
                            <div class="product-image" style="background-image: url('${comboProduct.image}');"></div>
                            <div class="product-info">
                                <h3>${comboProduct.name}</h3>
                                <p>${comboProduct.description.substring(0, 100)}...</p>
                                ${comboDetailsHTML}
                                <div class="product-price">R${comboProduct.price.toFixed(2)}</div>
                            </div>
                            <button class="glass-button add-to-cart" 
                                data-id="${comboProduct.id}" 
                                data-name="${comboProduct.name}" 
                                data-price="${comboProduct.price}" 
                                data-image="${comboProduct.image}"
                                style="background: rgba(196, 167, 125, 0.3);">
                                <i class="fas fa-star"></i> Add Combo
                            </button>
                        </div>
                    `;
                    personalizedProductsDiv.innerHTML += comboHTML;

                    if (!personalizedRecommendations.includes(primaryComboId)) {
                        personalizedRecommendations.push(primaryComboId);
                    }
                }
            }

            // Note: The add-to-cart buttons in the results modal will now work automatically
            // because we're using event delegation in initializeAddToCartButtons()

            resultsModal.classList.add('active');

            setTimeout(() => {
                resultsModal.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }, 100);
        }

        // Gallery navigation
        galleryDots.forEach(dot => {
            dot.addEventListener('click', function() {
                const index = parseInt(this.getAttribute('data-index'));
                goToGallerySlide(index);
            });
        });

        function goToGallerySlide(index) {
            currentGallerySlide = index;
            const translateX = -index * 325;

            galleryTrack.style.transform = `translateX(${translateX}px)`;

            galleryDots.forEach((dot, i) => {
                if (i === index) {
                    dot.classList.add('active');
                } else {
                    dot.classList.remove('active');
                }
            });
        }

        // Auto-rotate gallery
        setInterval(() => {
            currentGallerySlide = (currentGallerySlide + 1) % gallerySlideCount;
            goToGallerySlide(currentGallerySlide);
        }, 5000);

        // Smooth scrolling for anchor links
        document.querySelectorAll('a[href^="#"]').forEach(anchor => {
            anchor.addEventListener('click', function(e) {
                e.preventDefault();

                const targetId = this.getAttribute('href');
                if (targetId === '#') return;

                const targetElement = document.querySelector(targetId);
                if (targetElement) {
                    targetElement.scrollIntoView({
                        behavior: 'smooth',
                        block: 'start'
                    });

                    closeMobileMenu();
                }
            });
        });

        // Newsletter form
        const newsletterForm = document.querySelector('.newsletter-form');
        const newsletterInput = newsletterForm.querySelector('input');
        const newsletterButton = newsletterForm.querySelector('button');

        newsletterButton.addEventListener('click', () => {
            if (newsletterInput.value && newsletterInput.value.includes('@')) {
                newsletterButton.innerHTML = '<i class="fas fa-check"></i> Subscribed!';
                newsletterButton.style.background = 'rgba(40, 167, 69, 0.3)';
                newsletterInput.value = '';

                setTimeout(() => {
                    newsletterButton.innerHTML = 'Subscribe';
                    newsletterButton.style.background = '';
                }, 3000);
            } else {
                newsletterInput.style.border = '1px solid rgba(220, 53, 69, 0.5)';
                setTimeout(() => {
                    newsletterInput.style.border = '';
                }, 2000);
            }
        });

    </script>

    <!-- New minimal JavaScript for polish features only -->
    <script>
        // Task B: Next button behavior
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize all Next buttons as disabled
            const nextButtons = document.querySelectorAll('.wizard-next');
            nextButtons.forEach(btn => {
                btn.disabled = true;
            });

            // Enable Next button when option is selected
            const optionItems = document.querySelectorAll('.option-item');
            optionItems.forEach(item => {
                item.addEventListener('click', function() {
                    const wizardStep = this.closest('.wizard-step');
                    const nextButton = wizardStep.querySelector('.wizard-next');
                    if (nextButton) {
                        nextButton.disabled = false;
                    }
                });
            });

            // Task E: Tags clarity line
            const searchResults = document.getElementById('searchResults');
            if (searchResults) {
                // Add helper text to search suggestions when they appear
                const observer = new MutationObserver(function(mutations) {
                    mutations.forEach(function(mutation) {
                        if (mutation.type === 'childList') {
                            const suggestionSections = searchResults.querySelectorAll('.search-suggestions');
                            suggestionSections.forEach(section => {
                                // Check if helper text already exists
                                if (!section.querySelector('.tags-helper')) {
                                    const helper = document.createElement('div');
                                    helper.className = 'tags-helper';
                                    helper.textContent = 'Tap any tag to instantly see matching products';
                                    section.insertBefore(helper, section.firstChild);
                                }
                            });
                        }
                    });
                });

                observer.observe(searchResults, { childList: true, subtree: true });
            }

            // Same for overlay search
            const searchOverlayResults = document.getElementById('searchOverlayResults');
            if (searchOverlayResults) {
                const overlayObserver = new MutationObserver(function(mutations) {
                    mutations.forEach(function(mutation) {
                        if (mutation.type === 'childList') {
                            const suggestionSections = searchOverlayResults.querySelectorAll('.search-suggestions');
                            suggestionSections.forEach(section => {
                                if (!section.querySelector('.tags-helper')) {
                                    const helper = document.createElement('div');
                                    helper.className = 'tags-helper';
                                    helper.textContent = 'Tap any tag to instantly see matching products';
                                    section.insertBefore(helper, section.firstChild);
                                }
                            });
                        }
                    });
                });

                overlayObserver.observe(searchOverlayResults, { childList: true, subtree: true });
            }
        });

    </script>

    <!-- New minimal JavaScript for polish features only -->
    <script>
        // Task B: Next button behavior
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize all Next buttons as disabled
            const nextButtons = document.querySelectorAll('.wizard-next');
            nextButtons.forEach(btn => {
                btn.disabled = true;
            });

            // Enable Next button when option is selected
            const optionItems = document.querySelectorAll('.option-item');
            optionItems.forEach(item => {
                item.addEventListener('click', function() {
                    const wizardStep = this.closest('.wizard-step');
                    const nextButton = wizardStep.querySelector('.wizard-next');
                    if (nextButton) {
                        nextButton.disabled = false;
                    }
                });
            });

            // Task E: Tags clarity line
            const searchResults = document.getElementById('searchResults');
            if (searchResults) {
                // Add helper text to search suggestions when they appear
                const observer = new MutationObserver(function(mutations) {
                    mutations.forEach(function(mutation) {
                        if (mutation.type === 'childList') {
                            const suggestionSections = searchResults.querySelectorAll('.search-suggestions');
                            suggestionSections.forEach(section => {
                                // Check if helper text already exists
                                if (!section.querySelector('.tags-helper')) {
                                    const helper = document.createElement('div');
                                    helper.className = 'tags-helper';
                                    helper.textContent = 'Tap any tag to instantly see matching products';
                                    section.insertBefore(helper, section.firstChild);
                                }
                            });
                        }
                    });
                });

                observer.observe(searchResults, { childList: true, subtree: true });
            }

            // Same for overlay search
            const searchOverlayResults = document.getElementById('searchOverlayResults');
            if (searchOverlayResults) {
                const overlayObserver = new MutationObserver(function(mutations) {
                    mutations.forEach(function(mutation) {
                        if (mutation.type === 'childList') {
                            const suggestionSections = searchOverlayResults.querySelectorAll('.search-suggestions');
                            suggestionSections.forEach(section => {
                                if (!section.querySelector('.tags-helper')) {
                                    const helper = document.createElement('div');
                                    helper.className = 'tags-helper';
                                    helper.textContent = 'Tap any tag to instantly see matching products';
                                    section.insertBefore(helper, section.firstChild);
                                }
                            });
                        }
                    });
                });

                overlayObserver.observe(searchOverlayResults, { childList: true, subtree: true });
            }
        });

// ==================== SUPABASE CONFIGURATION ====================

// Initialize Supabase client with your project credentials
const SUPABASE_URL = 'https://your-project-id.supabase.co'; // Replace with your Supabase URL
const SUPABASE_ANON_KEY = 'your-anon-key-here'; // Replace with your Supabase anon key

// Create Supabase client
const supabase = window.supabase ? window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY) : null;

// ==================== DATABASE TABLES ====================
// You'll need to create these tables in your Supabase database:

/*
1. products table:
   - id (uuid, primary key)
   - name (text)
   - price (decimal)
   - image_url (text)
   - description (text)
   - benefits (text)
   - usage (text)
   - ingredients (text)
   - category (text)
   - skin_issues (text array)
   - benefits_list (text array)
   - search_score (integer)
   - section (text)
   - badge (text)
   - created_at (timestamp)

2. users table:
   - id (uuid, primary key, references auth.users)
   - first_name (text)
   - last_name (text)
   - email (text, unique)
   - has_discount (boolean)
   - shipping_info (jsonb)
   - orders (jsonb array)
   - created_at (timestamp)

3. orders table:
   - id (uuid, primary key)
   - user_id (uuid, references users)
   - items (jsonb)
   - total (decimal)
   - payment_method (text)
   - status (text)
   - shipping_address (jsonb)
   - payment_details (jsonb)
   - discount_applied (boolean)
   - created_at (timestamp)

4. search_analytics table:
   - id (uuid, primary key)
   - search_term (text)
   - product_id (uuid, references products)
   - click_count (integer)
   - created_at (timestamp)
*/

// ==================== SUPABASE FUNCTIONS ====================

// 1. PRODUCTS FUNCTIONS
async function fetchProductsFromSupabase() {
    if (!supabase) {
        console.warn('Supabase not initialized, using local data');
        return products; // Fall back to local products array
    }

    try {
        const { data, error } = await supabase
            .from('products')
            .select('*')
            .order('search_score', { ascending: false });

        if (error) {
            console.error('Error fetching products:', error);
            return products; // Fall back to local data
        }

        // Transform Supabase data to match local product structure
        return data.map(product => ({
            id: product.id,
            name: product.name,
            price: parseFloat(product.price),
            image: product.image_url,
            description: product.description,
            benefits: product.benefits || '',
            usage: product.usage || '',
            ingredients: product.ingredients || '',
            category: product.category,
            skinIssues: product.skin_issues || [],
            benefitsList: product.benefits_list || [],
            searchScore: product.search_score || 0,
            section: product.section || 'all-products',
            badge: product.badge || ''
        }));
    } catch (error) {
        console.error('Error fetching products:', error);
        return products; // Fall back to local data
    }
}

// 2. USER AUTHENTICATION FUNCTIONS
async function signUpWithSupabase(userData) {
    if (!supabase) {
        console.warn('Supabase not initialized, using localStorage fallback');
        return signUpLocal(userData);
    }

    try {
        // First, sign up with Supabase Auth
        const { data: authData, error: authError } = await supabase.auth.signUp({
            email: userData.email,
            password: userData.password,
            options: {
                data: {
                    first_name: userData.firstName,
                    last_name: userData.lastName
                }
            }
        });

        if (authError) throw authError;

        // Then create user profile in public.users table
        const { error: profileError } = await supabase
            .from('users')
            .insert({
                id: authData.user.id,
                first_name: userData.firstName,
                last_name: userData.lastName,
                email: userData.email,
                has_discount: true, // First-time signup gets discount
                created_at: new Date().toISOString()
            });

        if (profileError) throw profileError;

        return {
            success: true,
            user: {
                id: authData.user.id,
                firstName: userData.firstName,
                lastName: userData.lastName,
                email: userData.email,
                hasDiscount: true
            }
        };
    } catch (error) {
        console.error('Sign up error:', error);
        return {
            success: false,
            error: error.message
        };
    }
}

async function signInWithSupabase(email, password) {
    if (!supabase) {
        console.warn('Supabase not initialized, using localStorage fallback');
        return signInLocal(email, password);
    }

    try {
        const { data, error } = await supabase.auth.signInWithPassword({
            email: email,
            password: password
        });

        if (error) throw error;

        // Fetch user profile from public.users table
        const { data: userProfile, error: profileError } = await supabase
            .from('users')
            .select('*')
            .eq('id', data.user.id)
            .single();

        if (profileError) throw profileError;

        return {
            success: true,
            user: {
                id: data.user.id,
                firstName: userProfile.first_name,
                lastName: userProfile.last_name,
                email: data.user.email,
                hasDiscount: userProfile.has_discount,
                shippingInfo: userProfile.shipping_info,
                orders: userProfile.orders || []
            }
        };
    } catch (error) {
        console.error('Sign in error:', error);
        return {
            success: false,
            error: error.message
        };
    }
}

async function signOutWithSupabase() {
    if (!supabase) {
        console.warn('Supabase not initialized, using localStorage fallback');
        return signOutLocal();
    }

    try {
        const { error } = await supabase.auth.signOut();
        if (error) throw error;
        return { success: true };
    } catch (error) {
        console.error('Sign out error:', error);
        return { success: false, error: error.message };
    }
}

// 3. ORDER FUNCTIONS
async function saveOrderToSupabase(orderData) {
    if (!supabase) {
        console.warn('Supabase not initialized, using localStorage fallback');
        return saveOrderLocal(orderData);
    }

    try {
        const { data, error } = await supabase
            .from('orders')
            .insert({
                user_id: orderData.userId,
                items: orderData.items,
                total: orderData.total,
                payment_method: orderData.paymentMethod,
                status: orderData.status,
                shipping_address: orderData.shippingAddress,
                payment_details: orderData.paymentDetails,
                discount_applied: orderData.discountApplied,
                created_at: new Date().toISOString()
            })
            .select()
            .single();

        if (error) throw error;

        // Update user's orders array if logged in
        if (orderData.userId) {
            const { data: userData, error: userError } = await supabase
                .from('users')
                .select('orders')
                .eq('id', orderData.userId)
                .single();

            if (!userError && userData) {
                const updatedOrders = [...(userData.orders || []), orderData];
                await supabase
                    .from('users')
                    .update({ orders: updatedOrders })
                    .eq('id', orderData.userId);
            }
        }

        return {
            success: true,
            orderId: data.id
        };
    } catch (error) {
        console.error('Save order error:', error);
        return {
            success: false,
            error: error.message
        };
    }
}

// 4. SEARCH ANALYTICS
async function logSearchToSupabase(searchTerm, productId = null) {
    if (!supabase) return;

    try {
        if (productId) {
            // Log product click from search
            const { data: existing } = await supabase
                .from('search_analytics')
                .select('*')
                .eq('search_term', searchTerm)
                .eq('product_id', productId)
                .single();

            if (existing) {
                await supabase
                    .from('search_analytics')
                    .update({ click_count: existing.click_count + 1 })
                    .eq('id', existing.id);
            } else {
                await supabase
                    .from('search_analytics')
                    .insert({
                        search_term: searchTerm,
                        product_id: productId,
                        click_count: 1
                    });
            }
        }
    } catch (error) {
        console.error('Log search error:', error);
    }
}

// 5. USER PROFILE MANAGEMENT
async function updateUserProfile(userId, updates) {
    if (!supabase) return { success: false };

    try {
        const { error } = await supabase
            .from('users')
            .update(updates)
            .eq('id', userId);

        if (error) throw error;
        return { success: true };
    } catch (error) {
        console.error('Update profile error:', error);
        return { success: false, error: error.message };
    }
}

// ==================== LOCAL STORAGE FALLBACKS ====================
function signUpLocal(userData) {
    const users = JSON.parse(localStorage.getItem('users')) || [];

    // Check if user already exists
    if (users.find(u => u.email === userData.email)) {
        return {
            success: false,
            error: 'User already exists'
        };
    }

    const newUser = {
        id: Date.now().toString(),
        firstName: userData.firstName,
        lastName: userData.lastName,
        email: userData.email,
        password: userData.password,
        hasDiscount: true,
        createdAt: new Date().toISOString()
    };

    users.push(newUser);
    localStorage.setItem('users', JSON.stringify(users));
    localStorage.setItem('currentUser', JSON.stringify(newUser));

    return {
        success: true,
        user: {
            id: newUser.id,
            firstName: newUser.firstName,
            lastName: newUser.lastName,
            email: newUser.email,
            hasDiscount: true
        }
    };
}

function signInLocal(email, password) {
    const users = JSON.parse(localStorage.getItem('users')) || [];
    const user = users.find(u => u.email === email && u.password === password);

    if (user) {
        localStorage.setItem('currentUser', JSON.stringify(user));
        return {
            success: true,
            user: user
        };
    }

    return {
        success: false,
        error: 'Invalid credentials'
    };
}

function signOutLocal() {
    localStorage.removeItem('currentUser');
    return { success: true };
}

function saveOrderLocal(orderData) {
    const orders = JSON.parse(localStorage.getItem('orders')) || [];
    const orderId = Date.now().toString();

    const order = {
        ...orderData,
        id: orderId,
        createdAt: new Date().toISOString()
    };

    orders.push(order);
    localStorage.setItem('orders', JSON.stringify(orders));

    return {
        success: true,
        orderId: orderId
    };
}

// ==================== SUPABASE CONFIGURATION ====================

// Initialize Supabase client with your project credentials
const SUPABASE_URL = 'https://gdqvtgpzcgglmbqwrbkv.supabase.co';
const SUPABASE_ANON_KEY = 'sb_publishable_XxD9JYRc6jn6TvlSBUvgyA_sjjzki1U';

// Create Supabase client
const supabase = window.supabase ? window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY) : null;

// ==================== DATABASE TABLES ====================
// You'll need to create these tables in your Supabase database:

/*
1. products table:
   - id (uuid, primary key)
   - name (text)
   - price (decimal)
   - image_url (text)
   - description (text)
   - benefits (text)
   - usage (text)
   - ingredients (text)
   - category (text)
   - skin_issues (text array)
   - benefits_list (text array)
   - search_score (integer)
   - section (text)
   - badge (text)
   - created_at (timestamp)

2. users table:
   - id (uuid, primary key, references auth.users)
   - first_name (text)
   - last_name (text)
   - email (text, unique)
   - has_discount (boolean)
   - shipping_info (jsonb)
   - orders (jsonb array)
   - created_at (timestamp)

3. orders table:
   - id (uuid, primary key)
   - user_id (uuid, references users)
   - items (jsonb)
   - total (decimal)
   - payment_method (text)
   - status (text)
   - shipping_address (jsonb)
   - payment_details (jsonb)
   - discount_applied (boolean)
   - created_at (timestamp)

4. search_analytics table:
   - id (uuid, primary key)
   - search_term (text)
   - product_id (uuid, references products)
   - click_count (integer)
   - created_at (timestamp)
*/

// ==================== SUPABASE FUNCTIONS ====================

// 1. PRODUCTS FUNCTIONS
async function fetchProductsFromSupabase() {
    if (!supabase) {
        console.warn('Supabase not initialized, using local data');
        return products; // Fall back to local products array
    }

    try {
        const { data, error } = await supabase
            .from('products')
            .select('*')
            .order('search_score', { ascending: false });

        if (error) {
            console.error('Error fetching products:', error);
            return products; // Fall back to local data
        }

        // Transform Supabase data to match local product structure
        return data.map(product => ({
            id: product.id,
            name: product.name,
            price: parseFloat(product.price),
            image: product.image_url,
            description: product.description,
            benefits: product.benefits || '',
            usage: product.usage || '',
            ingredients: product.ingredients || '',
            category: product.category,
            skinIssues: product.skin_issues || [],
            benefitsList: product.benefits_list || [],
            searchScore: product.search_score || 0,
            section: product.section || 'all-products',
            badge: product.badge || ''
        }));
    } catch (error) {
        console.error('Error fetching products:', error);
        return products; // Fall back to local data
    }
}

// 2. USER AUTHENTICATION FUNCTIONS
async function signUpWithSupabase(userData) {
    if (!supabase) {
        console.warn('Supabase not initialized, using localStorage fallback');
        return signUpLocal(userData);
    }

    try {
        // First, sign up with Supabase Auth
        const { data: authData, error: authError } = await supabase.auth.signUp({
            email: userData.email,
            password: userData.password,
            options: {
                data: {
                    first_name: userData.firstName,
                    last_name: userData.lastName
                }
            }
        });

        if (authError) throw authError;

        // Then create user profile in public.users table
        const { error: profileError } = await supabase
            .from('users')
            .insert({
                id: authData.user.id,
                first_name: userData.firstName,
                last_name: userData.lastName,
                email: userData.email,
                has_discount: true, // First-time signup gets discount
                created_at: new Date().toISOString()
            });

        if (profileError) throw profileError;

        return {
            success: true,
            user: {
                id: authData.user.id,
                firstName: userData.firstName,
                lastName: userData.lastName,
                email: userData.email,
                hasDiscount: true
            }
        };
    } catch (error) {
        console.error('Sign up error:', error);
        return {
            success: false,
            error: error.message
        };
    }
}

async function signInWithSupabase(email, password) {
    if (!supabase) {
        console.warn('Supabase not initialized, using localStorage fallback');
        return signInLocal(email, password);
    }

    try {
        const { data, error } = await supabase.auth.signInWithPassword({
            email: email,
            password: password
        });

        if (error) throw error;

        // Fetch user profile from public.users table
        const { data: userProfile, error: profileError } = await supabase
            .from('users')
            .select('*')
            .eq('id', data.user.id)
            .single();

        if (profileError) throw profileError;

        return {
            success: true,
            user: {
                id: data.user.id,
                firstName: userProfile.first_name,
                lastName: userProfile.last_name,
                email: data.user.email,
                hasDiscount: userProfile.has_discount,
                shippingInfo: userProfile.shipping_info,
                orders: userProfile.orders || []
            }
        };
    } catch (error) {
        console.error('Sign in error:', error);
        return {
            success: false,
            error: error.message
        };
    }
}

async function signOutWithSupabase() {
    if (!supabase) {
        console.warn('Supabase not initialized, using localStorage fallback');
        return signOutLocal();
    }

    try {
        const { error } = await supabase.auth.signOut();
        if (error) throw error;
        return { success: true };
    } catch (error) {
        console.error('Sign out error:', error);
        return { success: false, error: error.message };
    }
}

// 3. ORDER FUNCTIONS
async function saveOrderToSupabase(orderData) {
    if (!supabase) {
        console.warn('Supabase not initialized, using localStorage fallback');
        return saveOrderLocal(orderData);
    }

    try {
        const { data, error } = await supabase
            .from('orders')
            .insert({
                user_id: orderData.userId,
                items: orderData.items,
                total: orderData.total,
                payment_method: orderData.paymentMethod,
                status: orderData.status,
                shipping_address: orderData.shippingAddress,
                payment_details: orderData.paymentDetails,
                discount_applied: orderData.discountApplied,
                created_at: new Date().toISOString()
            })
            .select()
            .single();

        if (error) throw error;

        // Update user's orders array if logged in
        if (orderData.userId) {
            const { data: userData, error: userError } = await supabase
                .from('users')
                .select('orders')
                .eq('id', orderData.userId)
                .single();

            if (!userError && userData) {
                const updatedOrders = [...(userData.orders || []), orderData];
                await supabase
                    .from('users')
                    .update({ orders: updatedOrders })
                    .eq('id', orderData.userId);
            }
        }

        return {
            success: true,
            orderId: data.id
        };
    } catch (error) {
        console.error('Save order error:', error);
        return {
            success: false,
            error: error.message
        };
    }
}

// 4. SEARCH ANALYTICS
async function logSearchToSupabase(searchTerm, productId = null) {
    if (!supabase) return;

    try {
        if (productId) {
            // Log product click from search
            const { data: existing } = await supabase
                .from('search_analytics')
                .select('*')
                .eq('search_term', searchTerm)
                .eq('product_id', productId)
                .single();

            if (existing) {
                await supabase
                    .from('search_analytics')
                    .update({ click_count: existing.click_count + 1 })
                    .eq('id', existing.id);
            } else {
                await supabase
                    .from('search_analytics')
                    .insert({
                        search_term: searchTerm,
                        product_id: productId,
                        click_count: 1
                    });
            }
        }
    } catch (error) {
        console.error('Log search error:', error);
    }
}

// 5. USER PROFILE MANAGEMENT
async function updateUserProfile(userId, updates) {
    if (!supabase) return { success: false };

    try {
        const { error } = await supabase
            .from('users')
            .update(updates)
            .eq('id', userId);

        if (error) throw error;
        return { success: true };
    } catch (error) {
        console.error('Update profile error:', error);
        return { success: false, error: error.message };
    }
}

// ==================== LOCAL STORAGE FALLBACKS ====================
function signUpLocal(userData) {
    const users = JSON.parse(localStorage.getItem('users')) || [];

    // Check if user already exists
    if (users.find(u => u.email === userData.email)) {
        return {
            success: false,
            error: 'User already exists'
        };
    }

    const newUser = {
        id: Date.now().toString(),
        firstName: userData.firstName,
        lastName: userData.lastName,
        email: userData.email,
        password: userData.password,
        hasDiscount: true,
        createdAt: new Date().toISOString()
    };

    users.push(newUser);
    localStorage.setItem('users', JSON.stringify(users));
    localStorage.setItem('currentUser', JSON.stringify(newUser));

    return {
        success: true,
        user: {
            id: newUser.id,
            firstName: newUser.firstName,
            lastName: newUser.lastName,
            email: newUser.email,
            hasDiscount: true
        }
    };
}

function signInLocal(email, password) {
    const users = JSON.parse(localStorage.getItem('users')) || [];
    const user = users.find(u => u.email === email && u.password === password);

    if (user) {
        localStorage.setItem('currentUser', JSON.stringify(user));
        return {
            success: true,
            user: user
        };
    }

    return {
        success: false,
        error: 'Invalid credentials'
    };
}

function signOutLocal() {
    localStorage.removeItem('currentUser');
    return { success: true };
}

function saveOrderLocal(orderData) {
    const orders = JSON.parse(localStorage.getItem('orders')) || [];
    const orderId = Date.now().toString();

    const order = {
        ...orderData,
        id: orderId,
        createdAt: new Date().toISOString()
    };

    orders.push(order);
    localStorage.setItem('orders', JSON.stringify(orders));

    return {
        success: true,
        orderId: orderId
    };
}

// ==================== TEST CONNECTION FUNCTION ====================
// Test connection on mobile
async function testMobileConnection() {
    console.log(' Testing Supabase from mobile...');
    try {
        const { data, error } = await supabase.from('products').select('count');
        if (error && error.code === '42P01') {
            console.log(' Connected! Ready to add products.');
            // Show mobile-friendly success
            setTimeout(() => {
                if (typeof Android !== 'undefined' && Android.showToast) {
                    Android.showToast('Connected to database!');
                }
            }, 500);
        } else if (error) {
            console.log(' Connection okay, needs setup.');
        }
    } catch (e) {
        console.log(' Mobile connection check:', e.message);
    }
}

// Run when page loads
document.addEventListener('DOMContentLoaded', testMobileConnection);

// ==================== INTEGRATION WITH EXISTING CODE ====================

// Replace existing product initialization
document.addEventListener('DOMContentLoaded', async () => {
    // Load products from Supabase (or fall back to local)
    const supabaseProducts = await fetchProductsFromSupabase();
    if (supabaseProducts.length > 0) {
        // Merge with local products to ensure all data exists
        products = [...products, ...supabaseProducts.filter(sp => 
            !products.find(p => p.id === sp.id)
        )];
    }

    // Check for existing Supabase session
    if (supabase) {
        const { data: { session } } = await supabase.auth.getSession();
        if (session) {
            // User is logged in via Supabase
            const { data: userProfile } = await supabase
                .from('users')
                .select('*')
                .eq('id', session.user.id)
                .single();

            if (userProfile) {
                currentUser = {
                    id: userProfile.id,
                    firstName: userProfile.first_name,
                    lastName: userProfile.last_name,
                    email: session.user.email,
                    hasDiscount: userProfile.has_discount,
                    shippingInfo: userProfile.shipping_info,
                    orders: userProfile.orders || []
                };
                isAuthenticated = true;
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
            }
        }
    }

    // Update authentication handlers
    enhanceAuthHandlers();
});

function enhanceAuthHandlers() {
    // Replace enhanced login form submission
    enhancedLoginForm.addEventListener('submit', async (e) => {
        e.preventDefault();

        const email = document.getElementById('enhancedLoginEmail').value;
        const password = document.getElementById('enhancedLoginPassword').value;

        showAuthLoading();

        const result = await signInWithSupabase(email, password);

        if (result.success) {
            currentUser = result.user;
            isAuthenticated = true;
            userHasDiscount = result.user.hasDiscount;

            showAuthSuccess();

            setTimeout(() => {
                enhancedAuthModal.classList.remove('active');
                checkoutModal.classList.add('active');
                updateCheckoutStep(1);
                initializeAddressSelection();

                if (userHasDiscount) {
                    applyDiscountToCart();
                }
            }, 1500);
        } else {
            hideAuthLoading();
            alert(`Login failed: ${result.error}`);
        }
    });

    // Replace enhanced signup form submission
    enhancedSignupForm.addEventListener('submit', async (e) => {
        e.preventDefault();

        const firstName = document.getElementById('signupFirstName').value;
        const lastName = document.getElementById('signupLastName').value;
        const email = document.getElementById('enhancedSignupEmail').value;
        const password = document.getElementById('enhancedSignupPassword').value;
        const confirmPassword = document.getElementById('enhancedSignupConfirmPassword').value;

        if (password !== confirmPassword) {
            alert('Passwords do not match');
            return;
        }

        showAuthLoading();

        const result = await signUpWithSupabase({
            firstName,
            lastName,
            email,
            password
        });

        if (result.success) {
            currentUser = result.user;
            isAuthenticated = true;
            userHasDiscount = true;

            showAuthSuccess();

            setTimeout(() => {
                enhancedAuthModal.classList.remove('active');
                checkoutModal.classList.add('active');
                updateCheckoutStep(1);
                initializeAddressSelection();

                applyDiscountToCart();
            }, 1500);
        } else {
            hideAuthLoading();
            alert(`Signup failed: ${result.error}`);
        }
    });

    // Update placeOrderBtn to save to Supabase
    const originalPlaceOrder = placeOrderBtn.onclick;
    placeOrderBtn.addEventListener('click', async () => {
        if (!document.getElementById('agreeTermsCheckout').checked) {
            alert('Please agree to the Terms & Conditions');
            return;
        }

        if (!validateAddressSelection()) {
            alert('Please complete the address selection process');
            return;
        }

        // Build order data
        const orderId = Math.floor(1000 + Math.random() * 9000);
        const orderData = {
            id: orderId,
            date: new Date().toISOString(),
            items: [...cart],
            total: parseFloat(document.getElementById('reviewTotal').textContent.replace('R', '')),
            paymentMethod: selectedPaymentMethod,
            status: selectedPaymentMethod === 'bank' ? 'Pending Payment' : 'Processing',
            shippingAddress: getShippingInfo(),
            paymentDetails: selectedPaymentMethod === 'bank' ? getBankDetails() : null,
            userId: isAuthenticated ? currentUser.id : null,
            discountApplied: userHasDiscount
        };

        // Save order to Supabase
        const result = await saveOrderToSupabase(orderData);

        if (result.success) {
            // Clear cart
            cart = [];
            localStorage.setItem('cart', JSON.stringify(cart));
            updateCartBadge();

            // Close checkout modal
            checkoutModal.classList.remove('active');

            // Show success
            document.getElementById('orderId').textContent = result.orderId || orderId;
            successModal.classList.add('active');

            resetAddressSelection();
            userHasDiscount = false;
        } else {
            alert(`Failed to save order: ${result.error}`);
        }
    });
}

function getShippingInfo() {
    return {
        firstName: document.getElementById('shippingFirstName').value,
        lastName: document.getElementById('shippingLastName').value,
        email: document.getElementById('shippingEmail').value,
        phone: document.getElementById('shippingPhone').value,
        country: selectedCountry,
        state: selectedState || manualState,
        city: selectedCity || manualCity,
        village: selectedVillage || manualVillage,
        zip: selectedZip || manualZip,
        street: document.getElementById('shippingAddress').value,
        apartment: document.getElementById('shippingApartment').value,
        notes: document.getElementById('shippingNotes').value,
        isManualEntry: isManualEntry
    };
}

function getBankDetails() {
    return {
        bankName: 'Standard Bank',
        accountName: 'Lonz Flawls Aura',
        accountNumber: '0123456789',
        branchCode: '051001',
        reference: document.getElementById('orderId').textContent,
        amount: parseFloat(document.getElementById('reviewTotal').textContent.replace('R', ''))
    };
}

// Update search functionality to log analytics
function enhanceSearchFunctionality() {
    // Wrap the performSearch function to log analytics
    const originalPerformSearch = performSearch;
    window.performSearch = function(searchTerm, resultsContainer) {
        // Log search term (without logging every keystroke)
        if (searchTerm.length > 2) {
            logSearchToSupabase(searchTerm);
        }
        return originalPerformSearch(searchTerm, resultsContainer);
    };

    // Log product clicks from search results
    document.addEventListener('click', (e) => {
        const searchResult = e.target.closest('.search-result-item, .top-searched-item');
        if (searchResult) {
            const productId = searchResult.getAttribute('data-id');
            const searchTerm = searchInput.value || searchOverlayInput.value;
            if (productId && searchTerm) {
                logSearchToSupabase(searchTerm, productId);
            }
        }
    });
}

// Initialize enhanced search
enhanceSearchFunctionality();

// Export functions for debugging
window.supabaseBridge = {
    fetchProductsFromSupabase,
    signUpWithSupabase,
    signInWithSupabase,
    signOutWithSupabase,
    saveOrderToSupabase,
    logSearchToSupabase,
    updateUserProfile
};

    </script>
</body>
</html>